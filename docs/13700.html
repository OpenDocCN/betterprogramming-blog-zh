<html>
<head>
<title>Deploying a Pretrained Stable Diffusion Model in AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS Lambda中部署预训练的稳定扩散模型</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/deploying-a-pre-trained-stable-diffusion-model-in-aws-lambda-4a9799cb7113?source=collection_archive---------2-----------------------#2022-09-18">https://betterprogramming.pub/deploying-a-pre-trained-stable-diffusion-model-in-aws-lambda-4a9799cb7113?source=collection_archive---------2-----------------------#2022-09-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a5a6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">部署人工智能生成器模型的设置指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0f0c358b36d1346365e98eca1e68d34c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*M8pq4-qKJVYUcPfy"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kv" href="https://unsplash.com/@wickedmonday?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">邪恶星期一</a>的照片</p></figure><p id="2da6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我将描述如何在AWS Lambda上部署一个稳定的扩散(神经网络)模型，使用一个预训练的模型作为基础，特别是一个预先具有权重和推理代码的模型。</p><p id="a53a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">基础代码使用<a class="ae kv" href="https://www.intel.com/content/www/us/en/developer/tools/openvino-toolkit/overview.html" rel="noopener ugc nofollow" target="_blank"> Openvino </a>来产生一个高度CPU优化版本的稳定扩散。</p><p id="9a61" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个框架对于Edge和物联网用例特别有用，但在这里，我们将使用完全不同的东西——我们将部署一个真正大的模型(大约3 GB，并在AWS Lambda上成功执行)。</p><p id="b843" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我不会教任何关于openvino的东西，因为我对它不熟悉。事实上，我几乎只是使用了一个开源库作为基础。</p><p id="21c7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">相反，我将集中精力把它部署在AWS Lambda上。</p><p id="3cb9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所描述的方法应该不管底层框架(拥抱脸、PyTorch等)如何都可以工作。)，所以如果您想在一个无服务器的HTTP端点上执行推理，了解它是非常有用的。</p><p id="a65d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个小故事分为:</p><ol class=""><li id="27ee" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">简要背景</li><li id="4343" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">在AWS Lambda上部署它的分步指南</li><li id="8a56" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">我犯的愚蠢的错误</li></ol><h1 id="b1b1" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">关于稳定扩散的一些背景</h1><p id="c7c3" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">但是在我们开始之前，先了解一下我们正在做的事情的背景。你可能听说过人工智能生成的图像及其最近的稳定扩散热潮。如果没有，如果你对这个话题感兴趣，你可能会想看看《拥抱脸》关于这个话题的精彩博客:<a class="ae kv" href="https://huggingface.co/blog/stable_diffusion" rel="noopener ugc nofollow" target="_blank">https://huggingface.co/blog/stable_diffusion</a>。</p><p id="a696" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是我用稳定扩散生成的一只太空猫的样本图片:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/02e83fc522244364161ab023c9d9a803.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*ahDKvCznzEzQO18_nFXMKg.jpeg"/></div></figure><p id="c910" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">执行这个神经网络来生成图像需要大量的GPU能力，尽管该模型正在随着时间的推移而优化，并且随着时间的推移，对于任何拥有现代台式机或笔记本电脑的最终用户来说，应该变得更容易使用。</p><p id="4fcd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为稳定扩散模型是开源的，不同的人也一直致力于提供优化的替代方案:为MacBook M1芯片优化它，为英特尔芯片优化它，等等。</p><p id="aaa4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常，所需的时间在很大程度上取决于实际的硬件。我针对不同类型的处理器提取了以下计算近似值(使用RTX 3090和i9在本地进行了测试，并且只在网上阅读了M1的相关资料):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/b54d96b3f05709b38da0fa5efef0b91a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x0ZONq9b8DAPXtXf8mMbCQ.png"/></div></div></figure><p id="9118" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，当在<code class="fe nf ng nh ni b">i9</code>上执行时，Openvino解决方案与其他解决方案相比慢得令人痛苦。</p><p id="6dd8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一种方法是使用由HuggingFace提供的ONNX版本(在用<code class="fe nf ng nh ni b">onnx simplifier</code>(【https://github.com/daquexian/onnx-simplifier】)对其进行优化后，它具有相似的计算时间)。</p><p id="a9b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注</strong>:简化器需要大约27GB内存来简化这个模型。我怀疑如果我使用ONNX版本，最终的结果会是相似的。</p><p id="b62e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尽管CPU推理很慢，但有趣的是它可以在AWS Lambda中执行，这意味着它可以用于免费试用/演示，因为有大量的AWS Lambda免费层。我正在构建类似的东西，例如，我在<a class="ae kv" href="https://app.openimagegenius.com/" rel="noopener ugc nofollow" target="_blank">https://app.openimagegenius.com</a>下发布的免费玩具产品。</p><p id="2d29" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想尝试一下，一定要有耐心，等待五分钟图像生成。Lambda只使用了12个推理步骤来加速(一旦Lambda变热，大约需要60秒的执行时间)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/1cc64254577f7f02707e9d91be4727bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H5hNy_pHJsAioFd9oMI4fQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">为我5岁的儿子制造金色的机器猫</p></figure><p id="cbaf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个例子的源代码可以在这里找到。你可以随意使用它，不需要征得我的同意(这是麻省理工学院的许可)。请记住模特的执照。</p><p id="9b64" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/paolorechia/openimagegenius/tree/main/serverless/stable-diffusion-open-vino-engine" rel="noopener ugc nofollow" target="_blank">https://github . com/paolorechia/open image genius/tree/main/server less/stable-diffusion-open-vino-engine</a></p><p id="05f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">聊够了。让我们开始解决问题吧。</p><h1 id="55fe" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">无服务器胶水</h1><p id="ab49" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">(工作版本:基于容器的Lambda和EFS🎉)</p><h1 id="f15d" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">手动部分</h1><p id="41ce" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">不幸的是，这里有许多手动步骤。虽然可以自动完成其中的大部分工作，但我认为投入这么多时间是没有意义的。精通造云或地形的人可能会自动完成这些步骤中的大部分(如果不是全部)。</p><p id="256d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你试图遵循这些步骤，却遇到了困难，不要犹豫，请联系我，我很乐意帮助你。</p><h2 id="6f24" class="nk mh iq bd mi nl nm dn mm nn no dp mq lf np nq ms lj nr ns mu ln nt nu mw nv bi translated"><strong class="ak">让我们从VPC和EC2开始</strong></h2><ol class=""><li id="362a" class="ls lt iq ky b kz my lc mz lf nw lj nx ln ny lr lx ly lz ma bi translated">创建一个VPC或使用默认的。哪种方式都可以。</li><li id="2a49" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">创建一个连接到此VPC的EC2实例，并最好将其部署到公共子网。您需要通过SSH连接到实例，当您使用公共子网时，这要容易得多。</li><li id="7dc7" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">创建新的安全子组或修改您使用的安全子组。您需要在入口打开端口22和2049。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/ec757e25b3b63846eb9540e83f95dd35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*odaEmwvjW1_Lk2Oo"/></div></div></figure><h2 id="340e" class="nk mh iq bd mi nl nm dn mm nn no dp mq lf np nq ms lj nr ns mu ln nt nu mw nv bi translated"><strong class="ak">现在的EFS </strong></h2><ol class=""><li id="0fc8" class="ls lt iq ky b kz my lc mz lf nw lj nx ln ny lr lx ly lz ma bi translated">创建EFS。确保它在EC2实例设置的相同子网中可用，并使用您定义的相同安全组。</li><li id="7907" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">SSH到您的EC2实例。</li><li id="8220" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">遵循AWS指南，了解如何在EC2:<a class="ae kv" href="https://docs.aws.amazon.com/efs/latest/ug/wt1-test.html" rel="noopener ugc nofollow" target="_blank">https://docs.aws.amazon.com/efs/latest/ug/wt1-test.html</a>中安装EFS</li><li id="3f32" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">总之，您执行以下命令(使用从AWS控制台/ CLI提取的实际装载文件夹和装载目标DNS(您可以在EFS文件系统UI屏幕中找到DNS ),适当地修改参数)</li><li id="0a25" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe nf ng nh ni b">mkdir mnt-folder</code></li><li id="9c97" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe nf ng nh ni b">sudo mount -t nfs -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport mount-target-DNS:/ ~/mnt-folder</code></li><li id="91ca" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">将openvino模型文件保存到EFS。在我的例子中，我使用这段代码(<a class="ae kv" href="https://github.com/bes-dev/stable_diffusion.openvino/blob/master/stable_diffusion_engine.py" rel="noopener ugc nofollow" target="_blank">https://github . com/bes-dev/stable _ diffusion . open vino/blob/master/stable _ diffusion _ engine . py</a>)手动下载了它们，并在之前将它们上传到了一个S3桶中。然后在我的EC2实例中，我从S3桶下载到EFS</li></ol><p id="a0c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">(<strong class="ky ir">注意</strong>:为此，您可能需要为您的EC2分配一个角色，如下面的屏幕截图所示。)</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/c49520f58ffacc07bde1173aa29f1831.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ahN8Oy6aHWMXxg9Q"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/80aef3e270facc0daa59d091a290835c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TPRcJctsNnlcVt4J"/></div></div></figure><p id="84d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦您正确配置了角色，aws-cli就应该工作了，例如，您可以执行像<code class="fe nf ng nh ni b">aws3 sync s3://your-bucket</code>这样的命令。</p><h2 id="7c41" class="nk mh iq bd mi nl nm dn mm nn no dp mq lf np nq ms lj nr ns mu ln nt nu mw nv bi translated">然后为弹性文件系统创建一个访问点</h2><p id="2570" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">为您配置的弹性文件系统创建一个EFS访问点。</p><p id="e0cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里需要注意几件事:</p><p id="c3e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">文件系统用户权限——如果它们太严格，当从Lambda访问EFS文件时，您将得到<code class="fe nf ng nh ni b">PermissionError</code>。在我的例子中，这个EFS专用于这个Lambda，所以我不关心粒度，只提供完全开放的访问(我稍后将在无服务器文件中做同样的事情):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/3e2c352eed53b5706dcb19414869247a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Cmx5YnB9Ng-rPG5u"/></div></div></figure><p id="3204" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，避免将<code class="fe nf ng nh ni b">/</code> <strong class="ky ir"> </strong>分配到您为访问点定义的根目录路径，这可能会在挂载时导致问题。此外，请务必记下您选择的值。你需要在Lambda函数中使用它。我个人用过:<code class="fe nf ng nh ni b">/mnt/fs</code>，在另一个指南中有描述。</p><p id="eecb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，我们已经差不多完成了手动创建资源的工作。</p><h1 id="fa35" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">无服务器框架</h1><p id="b7db" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我从<a class="ae kv" href="https://medium.com/swlh/mount-your-aws-efs-volume-into-aws-lambda-with-the-serverless-framework-470b1c6b1b2d" rel="noopener">https://medium . com/swlh/mount-your-AWS-EFS-volume-into-AWS-lambda-with-the-server less-framework-470 B1 c 6 B1 b 2</a>d收集的关于EFS部分的无服务器模板的大部分繁重工作</p><p id="0a8c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是完整的模板。您几乎必须替换自己的资源id。</p><pre class="kg kh ki kj gt oc ni od bn oe of bi"><span id="553a" class="og mh iq ni b be oh oi l oj ok">service: stable-diffusion-open-vino<br/>frameworkVersion: "3"<br/>provider:<br/>  name: aws<br/>  runtime: python3.8<br/>  stage: ${opt:stage}<br/>  region: eu-central-1<br/>  memorySize: 10240<br/>  iam:<br/>    role:<br/>      statements:<br/>        - Effect: Allow<br/>          Action:<br/>            - "elasticfilesystem:*"<br/>          Resource:<br/>            - "arn:aws:elasticfilesystem:${aws:region}:${aws:accountId}:file-system/${self:custom.fileSystemId}"<br/>            - "arn:aws:elasticfilesystem:${aws:region}:${aws:accountId}:access-point/${self:custom.efsAccessPoint}"<br/>functions:<br/>  textToImg:<br/>    url: true<br/>    image:<br/>      name: appimage<br/>    timeout: 300<br/>    environment:<br/>      MNT_DIR: ${self:custom.LocalMountPath}<br/>    vpc:<br/>      securityGroupIds:<br/>        - ${self:custom.securityGroup}<br/>      subnetIds:<br/>        - ${self:custom.subnetsId.subnet0}<br/>custom:<br/>  efsAccessPoint: YOUR_ACCESS_POINT_ID<br/>  fileSystemId: YOUR_FS_ID<br/>  LocalMountPath: /mnt/fs<br/>  subnetsId:<br/>    subnet0: YOUR_SUBNET_ID<br/>  securityGroup: YOUR_SECURITY_GROUP<br/>resources:<br/>  extensions:<br/>    TextToImgLambdaFunction:<br/>      Properties:<br/>        FileSystemConfigs:<br/>          - Arn: "arn:aws:elasticfilesystem:${self:provider.region}:${aws:accountId}:access-point/${self:custom.efsAccessPoint}"<br/>            LocalMountPath: "${self:custom.LocalMountPath}"</span></pre><p id="8d56" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">值得一提的几个部分:</p><p id="3913" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">内存大小:默认情况下，你不能使用10GB的内存。您需要向AWS开一个票证来支持此用例。请注意，您不会找到此请求的具体案例。我请求增加Lambda存储，并解释说我需要更多内存。AWS花了几天时间才接受它。</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="8cfc" class="nk mh iq ni b gy oo op l oq ok">memorySize: 10240</span></pre><p id="e6fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">函数URL:这一行<code class="fe nf ng nh ni b">url: true</code>允许一个公共URL调用您的函数，主要用于开发/调试目的。</p><h2 id="b81c" class="nk mh iq bd mi nl nm dn mm nn no dp mq lf np nq ms lj nr ns mu ln nt nu mw nv bi translated"><strong class="ak">码头工人集装箱建造模式</strong></h2><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="42f6" class="nk mh iq ni b gy oo op l oq ok">provider:<br/>	...<br/>  ecr:<br/>    images:<br/>      appimage:<br/>        path: ./</span><span id="4088" class="nk mh iq ni b gy or op l oq ok">...</span><span id="95bf" class="nk mh iq ni b gy or op l oq ok">functions:<br/>  textToImg:<br/>    url: true<br/>    image:<br/>      name: appimage<br/>    timeout: 300</span></pre><p id="4d8e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">无服务器框架在这里为您做了很多:仅这些块就将:</p><ol class=""><li id="151e" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">创建私有ECR存储库</li><li id="6a82" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">使用本地docker文件来构建您的容器</li><li id="0b2b" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">给图像加标签</li><li id="f0a1" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">将其推送到私有ECR存储库</li><li id="da14" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">创建一个Lambda函数，该函数使用刚刚创建的docker图像</li></ol><p id="162c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">话虽如此，还是要做好准备。与原生AWS Lambda相比，我们的构建/部署将花费相当多的时间。</p><p id="a12a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是我用过的Dockerfile文件:</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="1604" class="nk mh iq ni b gy oo op l oq ok">FROM python:3.9.9-bullseye</span><span id="0555" class="nk mh iq ni b gy or op l oq ok">WORKDIR /src</span><span id="f0bd" class="nk mh iq ni b gy or op l oq ok">RUN apt-get update &amp;&amp; \\<br/>    apt-get install -y \\<br/>    libgl1 libglib2.0-0 \\<br/>    g++ \\<br/>    make \\<br/>    cmake \\<br/>    unzip \\<br/>    libcurl4-openssl-dev</span><span id="1c3f" class="nk mh iq ni b gy or op l oq ok">COPY requirements.txt /src/<br/> <br/>RUN pip3 install -r requirements.txt --target /src/<br/>COPY handler.py stable_diffusion_engine.py /src/</span><span id="08ab" class="nk mh iq ni b gy or op l oq ok">ENTRYPOINT [ "/usr/local/bin/python", "-m", "awslambdaric" ]<br/>CMD [ "handler.handler" ]</span></pre><p id="d26c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它安装了AWS Lambda运行时接口和我们执行稳定扩散所需的依赖项(openvino版本)。</p><p id="376f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">同样，鸣谢归openvino解决方案的原作者所有:<a class="ae kv" href="https://github.com/bes-dev/stable_diffusion.openvino" rel="noopener ugc nofollow" target="_blank">https://github.com/bes-dev/stable_diffusion.openvino</a>。</p><p id="5dd5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在构建docker映像之前，您需要修改<code class="fe nf ng nh ni b">stable_diffusion_engine</code>模块并获得Lambda处理程序。你可以从我的仓库中提取或者从上面的仓库中改编。</p><p id="b614" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">引擎所需的主要变化是关于如何加载模型:</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="71c9" class="nk mh iq ni b gy oo op l oq ok">        self.tokenizer = CLIPTokenizer.from_pretrained(<br/>             "/mnt/fs/models/clip")</span><span id="3309" class="nk mh iq ni b gy or op l oq ok">				(...)<br/>        self._text_encoder = self.core.read_model(<br/>            "/mnt/fs/models/text_encoder/text_encoder.xml")</span><span id="e396" class="nk mh iq ni b gy or op l oq ok">				(...)<br/>        self._unet = self.core.read_model(<br/>	    "/mnt/fs/models/unet/unet.xml")</span><span id="1dd0" class="nk mh iq ni b gy or op l oq ok">				(...)<br/>        self._vae_decoder = self.core.read_model(<br/>            "/mnt/fs/models/vae_decoder/vae_decoder.xml")</span><span id="1d1c" class="nk mh iq ni b gy or op l oq ok">				(...)<br/>        self._vae_encoder = self.core.read_model(<br/>            "/mnt/fs/models/vae_encoder/vae_encoder.xml")</span></pre><p id="26af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后你可以在我的处理程序中使用这个模块(它只是改编自https://github.com/bes-dev/stable_diffusion.openvino<a class="ae kv" href="https://github.com/bes-dev/stable_diffusion.openvino" rel="noopener ugc nofollow" target="_blank">的<code class="fe nf ng nh ni b">demo.py</code>文件):</a></p><pre class="kg kh ki kj gt oc ni od bn oe of bi"><span id="bfa7" class="og mh iq ni b be oh oi l oj ok"># -- coding: utf-8 --`<br/>print("Starting container code...")<br/>from dataclasses import dataclass<br/>import numpy as np<br/>import cv2<br/>from diffusers import LMSDiscreteScheduler, PNDMScheduler<br/>from stable_diffusion_engine import StableDiffusionEngine<br/>import json<br/>import os<br/>@dataclass<br/>class StableDiffusionArguments:<br/>    prompt: str<br/>    num_inference_steps: int<br/>    guidance_scale: float<br/>    models_dir: str<br/>    seed: int = None<br/>    init_image: str = None<br/>    beta_start: float = 0.00085<br/>    beta_end: float = 0.012<br/>    beta_schedule: str = "scaled_linear"<br/>    model: str = "bes-dev/stable-diffusion-v1-4-openvino"<br/>    mask: str = None<br/>    strength: float = 0.5<br/>    eta: float = 0.0<br/>    tokenizer: str = "openai/clip-vit-large-patch14"<br/>def run_sd(args: StableDiffusionArguments):<br/>    if args.seed is not None:<br/>        np.random.seed(args.seed)<br/>    if args.init_image is None:<br/>        scheduler = LMSDiscreteScheduler(<br/>            beta_start=args.beta_start,<br/>            beta_end=args.beta_end,<br/>            beta_schedule=args.beta_schedule,<br/>            tensor_format="np",<br/>        )<br/>    else:<br/>        scheduler = PNDMScheduler(<br/>            beta_start=args.beta_start,<br/>            beta_end=args.beta_end,<br/>            beta_schedule=args.beta_schedule,<br/>            skip_prk_steps=True,<br/>            tensor_format="np",<br/>        )<br/>    engine = StableDiffusionEngine(<br/>        model=args.model, scheduler=scheduler, tokenizer=args.tokenizer, models_dir=args.models_dir<br/>    )<br/>    image = engine(<br/>        prompt=args.prompt,<br/>        init_image=None if args.init_image is None else cv2.imread(<br/>            args.init_image),<br/>        mask=None if args.mask is None else cv2.imread(args.mask, 0),<br/>        strength=args.strength,<br/>        num_inference_steps=args.num_inference_steps,<br/>        guidance_scale=args.guidance_scale,<br/>        eta=args.eta,<br/>    )<br/>    is_success, im_buf_arr = cv2.imencode(".jpg", image)<br/>    if not is_success:<br/>        raise ValueError("Failed to encode image as JPG")<br/>    byte_im = im_buf_arr.tobytes()<br/>    return byte_im<br/>def handler(event, context, models_dir=None):<br/>    print("Getting into handler, event: ", event)<br/>    print("Working dir at handler...", )<br/>    current_dir = os.getcwd()<br/>    print(current_dir)<br/>    print(os.listdir(current_dir))<br/>    print("Listing root")<br/>    print(os.listdir("/"))<br/>    # Get args<br/>    # randomizer params<br/>    body = json.loads(event.get("body"))<br/>    prompt = body["prompt"]<br/>    seed = body.get("seed")<br/>    num_inference_steps: int = int(body.get("num_inference_steps", 32))<br/>    guidance_scale: float = float(body.get("guidance_scale", 7.5))<br/>    args = StableDiffusionArguments(<br/>        prompt=prompt,<br/>        seed=seed,<br/>        num_inference_steps=num_inference_steps,<br/>        guidance_scale=guidance_scale,<br/>        models_dir=models_dir<br/>    )<br/>    print("Parsed args:", args)<br/>    image = run_sd(args)<br/>    print("Image generated")<br/>    body = json.dumps(<br/>        {"message": "wow, no way", "image": image.decode("latin1")})<br/>    return {"statusCode": 200, "body": body}</span></pre><h1 id="0502" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">测试部署</h1><p id="7b5c" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">当您完成部署时，无服务器框架应该会给您一个URL，您可以这样调用它:</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="8508" class="nk mh iq ni b gy oo op l oq ok">curl -X POST \\<br/>https://your_lambda_url_id.lambda-url.eu-central-1.on.aws/ \\<br/>-H 'content-type: application/json' \\<br/>-d '{"prompt": "tree"}'</span></pre><p id="12c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一切正常，您应该在云观察日志中看到它正在生成以下图像:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi os"><img src="../Images/e5a8aa5c67f331e7ee494c30c9e1a4bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:672/0*KC-yo5P6UGVI2bub"/></div></figure><p id="9430" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我测试时，它在主循环中花了将近3分钟，执行完整的Lambda用了238秒(4分钟)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/4ac20c82d7a02d67633aa9a2cb4e0ee3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vw7JTyRCQwgUDQeD"/></div></div></figure><p id="e32c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的卷曲会给你一个不可读的字符串，里面有一个编码成<code class="fe nf ng nh ni b">latin1</code>的图像。如果你打算实际使用你的Lambda，也许你会想要这样的东西(我用它来本地测试我的容器，替换URL):</p><pre class="kg kh ki kj gt oc ni od bn oe of bi"><span id="03f6" class="og mh iq ni b be oh oi l oj ok">import requests<br/>import json<br/>headers = {"content-type": "application/json"}<br/>url = "&lt;http://localhost:9000/2015-03-31/functions/function/invocations&gt;"<br/>body = json.dumps({"prompt": "beautiful tree", "num_inference_steps": 1})<br/>response = requests.post(url, json={"body": body}, headers=headers)<br/>response.raise_for_status()<br/>j = response.json()<br/>body = json.loads(j["body"])<br/>bytes_img = body["image"].encode("latin1")<br/>with open("test_result.png", "w+b") as fp:<br/>    fp.write(bytes_img)</span></pre><p id="a1cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">唷！那是许多步骤！现在，您可以将您的稳定扩散模型部署到AWS Lambda。我希望你喜欢阅读这个简短的教程。我会给你留下一些我尝试过的事情——但是没有成功——所以也许我可以说服你不要尝试它们。</p><h1 id="3e4c" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">错误的历史</h1><p id="9e7e" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">你想知道我的反复试验有多糟糕吗？嗯，我不介意分享——失败就是学习。</p><h1 id="d850" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">第一次尝试:全EFS，原生AWS Lambda</h1><p id="c29b" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">所以，我曾多次阅读在Lambda上部署大型模型并使用AWS弹性文件系统。所以我这样做了。</p><p id="8df3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我已经配置了一个常规的AWS Lambda，并将其连接到一个EFS。然而，当我执行代码时，我在导入<code class="fe nf ng nh ni b">openvino</code>运行时:<code class="fe nf ng nh ni b">libm.so.6 not found</code>时遇到了一个错误。</p><p id="f58f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">经过一番绞尽脑汁的研究，我了解到AWS Lambda运行在Amazon Linux上，我可能应该直接在EC2实例中构建我的库的依赖项。</p><p id="5196" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">除此之外，当我尝试这样做时，我发现【https://pypi.org/project/openvino/】<a class="ae kv" href="https://pypi.org/project/openvino/" rel="noopener ugc nofollow" target="_blank"/><code class="fe nf ng nh ni b">openvino</code>没有适用于亚马逊Linux的运行时版本2022。啊哦，死胡同</p><h1 id="e319" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">第二次尝试:满容器模式</h1><p id="a439" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">几天后，在与一个朋友讨论了与使用无服务器技术相比，我有多怀念使用docker之后，我突然想到:如果我使用Docker映像来部署Lambda会怎么样？</p><p id="7896" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">事实证明，容器图像大小限制是10GB，这是相当大的限制(<a class="ae kv" href="https://aws.amazon.com/blogs/aws/new-for-aws-lambda-container-image-support/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/AWS/new-for-AWS-lambda-container-image-support/</a>)—这必须有效！</p><p id="42b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">嗯，没那么快。当事情似乎接近工作的时候，我遇到了一些问题。</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="7849" class="nk mh iq ni b gy oo op l oq ok">[ERROR] RuntimeError: Model file /src/models/unet/unet.xml cannot be opened!<br/>Traceback (most recent call last):<br/>  File "/src/handler.py", line 129, in handler<br/>    image = run_sd(args)<br/>  File "/src/handler.py", line 76, in run_sd<br/>    engine = StableDiffusionEngine(<br/>  File "/src/stable_diffusion_engine.py", line 59, in __init__<br/>    self._unet = self.core.read_model(unet_xml, unet_bin)</span></pre><p id="5278" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">啊？我盯着这个错误看了几个小时，调试我的环境，确保文件可用，等等。根据OpenVINO API参考，因为<code class="fe nf ng nh ni b">core.read_model</code>也可以直接接受二进制数据，所以我稍微修改了一下代码，并尝试提前将模型加载到二进制缓冲区的字典中。</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="4976" class="nk mh iq ni b gy oo op l oq ok">models = {}<br/>for model in ["text_encoder", "unet", "vae_decoder", "vae_encoder"]:<br/>    with open(f"./models/{model}/{model}.xml", "r+b") as fp:<br/>        models[f"{model}-xml"] = fp.read()<br/>    with open(f"./models/{model}/{model}.bin", "r+b") as fp:<br/>        models[f"{model}-bin"] = fp.read()</span></pre><p id="3b6c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">除此之外，我仍然会遇到错误，但这次它们更有意义。</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="b50f" class="nk mh iq ni b gy oo op l oq ok">[ERROR] OSError: [Errno 30] Read-only file system: './models/text_encoder/text_encoder.xml'<br/>Traceback (most recent call last):<br/>  File "/usr/local/lib/python3.9/importlib/__init__.py", line 127, in import_module<br/>    return _bootstrap._gcd_import(name[level:], package, level)<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 1030, in _gcd_import<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 1007, in _find_and_load<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 986, in _find_and_load_unlocked<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 680, in _load_unlocked<br/>  File "&lt;frozen importlib._bootstrap_external&gt;", line 850, in exec_module<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 228, in _call_with_frames_removed<br/>  File "/src/handler.py", line 23, in &lt;module&gt;<br/>    from stable_diffusion_engine import StableDiffusionEngine<br/>  File "/src/stable_diffusion_engine.py", line 30, in &lt;module&gt;<br/>    with open(f"./models/{model}/{model}.xml", "r+b") as fp:</span></pre><p id="c204" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我仔细检查了Python文档，意识到<code class="fe nf ng nh ni b">r+b</code>实际上意味着“开放更新(读写)”可能文件系统是只读的。让我们不用它再试一次，只用<code class="fe nf ng nh ni b">rb</code>代替:</p><pre class="kg kh ki kj gt oc ni ol om aw on bi"><span id="397d" class="nk mh iq ni b gy oo op l oq ok">[ERROR] PermissionError: [Errno 13] Permission denied: './models/text_encoder/text_encoder.xml'<br/>Traceback (most recent call last):<br/>  File "/usr/local/lib/python3.9/importlib/__init__.py", line 127, in import_module<br/>    return _bootstrap._gcd_import(name[level:], package, level)<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 1030, in _gcd_import<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 1007, in _find_and_load<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 986, in _find_and_load_unlocked<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 680, in _load_unlocked<br/>  File "&lt;frozen importlib._bootstrap_external&gt;", line 850, in exec_module<br/>  File "&lt;frozen importlib._bootstrap&gt;", line 228, in _call_with_frames_removed<br/>  File "/src/handler.py", line 23, in &lt;module&gt;<br/>    from stable_diffusion_engine import StableDiffusionEngine<br/>  File "/src/stable_diffusion_engine.py", line 30, in &lt;module&gt;<br/>    with open(f"./models/{model}/{model}.xml", "rb") as fp:</span></pre><p id="9a5f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好吧，也许我需要先把文件复制到<code class="fe nf ng nh ni b">/tmp</code>？不，那只是给了我同样的错误。我搞不懂它——同样的代码在本地工作得很好，我甚至用<a class="ae kv" href="https://github.com/aws/aws-lambda-runtime-interface-emulator" rel="noopener ugc nofollow" target="_blank"> Lambda运行时接口仿真器</a>测试了它。一定是环境的原因。</p><p id="3fab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">出于安全原因，AWS阻止从容器映像文件路径进行二进制读取。我一直不知道为什么。切换到混合方法，模型存储在EFS，代码依赖/库存储在Docker镜像中，工作顺利。</p><p id="9aaa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，今天就到这里吧！</p><p id="da12" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望你喜欢读它。干杯！</p></div></div>    
</body>
</html>