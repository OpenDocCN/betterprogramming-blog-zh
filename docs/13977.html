<html>
<head>
<title>DevOps for .NET 6.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DevOps for。NET 6.0</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/devops-for-net-6-0-7fae47cec014?source=collection_archive---------7-----------------------#2022-10-21">https://betterprogramming.pub/devops-for-net-6-0-7fae47cec014?source=collection_archive---------7-----------------------#2022-10-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="05c5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">展开。使用GitHub操作将. NET Web应用程序转换为Azure应用程序服务</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/02294eba88ebb9ca371340382de350e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KH_P92L-MHoquOZ0"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/es/@max_duz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Max Duzij </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="24a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我将向您展示如何使用Bicep for Infrastructure作为代码，通过GitHub Actions将. NET 6 Web App部署到Azure App Service。</p><p id="25c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要跟进，您需要:</p><ul class=""><li id="3d77" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://github.com/" rel="noopener ugc nofollow" target="_blank"> GitHub账户</a></li><li id="15de" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://cli.github.com/" rel="noopener ugc nofollow" target="_blank"> GitHub CLI </a></li><li id="4d9f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://dotnet.microsoft.com/" rel="noopener ugc nofollow" target="_blank">。Net 6 SDK </a></li><li id="1928" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Azure CLI </li><li id="d651" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://github.com/PowerShell/Powershell" rel="noopener ugc nofollow" target="_blank"> PowerShell </a>(所有命令都在PowerShell中运行)</li></ul><p id="bd22" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，创建要部署的应用程序。</p><pre class="kj kk kl km gt mj mk ml mm aw mn bi"><span id="5b32" class="mo mp it mk b gy mq mr l ms mt">dotnet new webapp --output myapp</span></pre><p id="e72d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">切换到文件夹并添加一个. gitignore文件。</p><pre class="kj kk kl km gt mj mk ml mm aw mn bi"><span id="117e" class="mo mp it mk b gy mq mr l ms mt">cd myapp<br/>dotnet new gitignore</span></pre><p id="33c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<em class="mu"> myapp </em>文件夹下创建一个名为<em class="mu"> infra </em>的新文件夹来存放Bicep文件。当我使用Bicep时，我创建了一个模块来保存我的基础设施的不同部分。我总是创建一个<em class="mu"> main.bicep </em>来调用其他模块并收集任何输出。除了main.bicep之外，我还会有一个webapp.bicep。将这两个文件放在下面的<em class="mu">文件夹中。</em></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="27fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在第1行，我将这个部署限定为订阅。这将允许部署创建任何需要的资源组，我在第6行做了这些。资源组需要两个值<code class="fe mx my mz mk b">name</code>和<code class="fe mx my mz mk b">location</code>，这两个值都由第3行和第4行定义的参数提供。</p><p id="47ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在第11行，我调用了<code class="fe mx my mz mk b">webapp.bicep</code>文件，我们稍后将讨论这个文件。在第12行，我设置了名称，在第13行我限定了它的范围，所以所有的东西都是在提供的资源组中创建的。<code class="fe mx my mz mk b">webapp.bicep</code>文件还定义了第15行提供的位置参数。</p><p id="520a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，在第19行，我收集并传播Web应用程序名称作为输出。</p><p id="b34f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我创建了<em class="mu"> </em> <code class="fe mx my mz mk b">webapp.bicep</code>文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="3c01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在Azure App Service中创建Web应用，您首先必须创建一个托管计划。因为应用程序是使用。Net 6它可以在任何平台上运行。对于这个例子，我们将部署到Linux。</p><p id="94cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第3–13行定义了托管计划。必须将<em class="mu">保留</em>属性设置为true，并将<em class="mu">种类</em>属性设置为‘Linux’。您可以根据需要选择任何sku。</p><p id="486e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第15–27行定义了web应用程序并设置了。Net版本到6.0第24行。</p><p id="aa9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">代码准备就绪后，我们可以初始化存储库，并在添加GitHub工作流之前将其推送到GitHub。</p><pre class="kj kk kl km gt mj mk ml mm aw mn bi"><span id="a6f0" class="mo mp it mk b gy mq mr l ms mt">git init<br/>git add *<br/>git commit -a -m 'Init'</span></pre><p id="ca3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着存储库的初始化，我们可以使用GitHub CLI创建一个公共存储库，并将我们的代码推送到那里。</p><pre class="kj kk kl km gt mj mk ml mm aw mn bi"><span id="ec5f" class="mo mp it mk b gy mq mr l ms mt">gh repo create myAppRepo --public --source .<br/>git push --set-upstream origin trunk</span></pre><p id="7e45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着存储库的创建和代码的推送，我们可以创建GitHub工作流了。在根文件夹下创建一个<code class="fe mx my mz mk b">.github</code>文件夹，里面有一个<code class="fe mx my mz mk b">workflows</code>文件夹。最后，在<code class="fe mx my mz mk b">workflows</code>文件夹中创建一个<code class="fe mx my mz mk b">ci.yml</code>文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi na"><img src="../Images/882a66efc369f29a1c29140c3044bf3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:870/format:webp/1*P135OV1TI9lNMosO73895g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">项目中的工作流文件</p></figure><p id="cd26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是<code class="fe mx my mz mk b">ci.yml</code>文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="9c56" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个工作流程有三个任务<code class="fe mx my mz mk b">build</code>、<code class="fe mx my mz mk b">deployDevInfrastructure</code>和<code class="fe mx my mz mk b">deployDevApp</code>。</p><p id="c7c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mx my mz mk b">build</code>作业中，我只是运行我在开发机器上运行的相同命令来发布我的应用程序以进行部署。</p><p id="0040" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用程序发布后，我创建了两个工件，一个用于应用程序，一个用于基础设施。</p><p id="af6e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这份工作有趣得多。该作业使用Azure CLI和PowerShell来部署Bicep文件，并存储输出供其他作业使用。</p><p id="3e9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">来自二头肌部署的输出在线75上被收集。该值与发布简档一起作为输出存储在线路83和84上。第46–48行定义了这一步的输出。</p><p id="3b6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些值用于第104和106行的<code class="fe mx my mz mk b">deployDevApp</code>作业。</p><p id="6402" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要使用Azure CLI，我们必须创建一个存储Azure凭据的GitHub secret。你可以在GitHub的<a class="ae ky" href="https://github.com/Azure/actions-workflow-samples/blob/master/assets/create-secrets-for-GitHub-workflows.md" rel="noopener ugc nofollow" target="_blank">上阅读如何在GitHub动作工作流程</a>中设置秘密。我使用下面的命令来创建凭证。确保用您的值替换<code class="fe mx my mz mk b">{appName}</code>和<code class="fe mx my mz mk b">{subscriptionId}</code>。</p><pre class="kj kk kl km gt mj mk ml mm aw mn bi"><span id="1e2e" class="mo mp it mk b gy mq mr l ms mt">az ad sp create-for-rbac --name {appName} --role Contributor --sdk-auth --scopes /subscriptions/{subscriptionId} --output json &gt;&gt; azurecreds.json</span></pre><p id="2ec5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个命令将创建所需的凭证，并将它们存储在一个JSON文件中，我们将使用GitHub CLI来创建所需的密码。</p><p id="c443" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用GitHub CLI运行以下命令来创建保存Azure凭据的密码。</p><pre class="kj kk kl km gt mj mk ml mm aw mn bi"><span id="9c98" class="mo mp it mk b gy mq mr l ms mt">Get-Content .\azurecreds.json | gh secret set AZURE_CREDENTIALS</span></pre><p id="5d1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">现在删除<em class="mu"> azurecreds.json </em>文件，这样<em class="mu">而</em>就不会被签入GitHub。</strong></p><pre class="kj kk kl km gt mj mk ml mm aw mn bi"><span id="5d64" class="mo mp it mk b gy mq mr l ms mt">del .\azurecreds.json</span></pre><p id="cd3b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在运行这些命令之后，GitHub中有一个秘密，所以这个管道可以执行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/08eefcf7acb4620911623ffa607c8087.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BSGIQsKGQgYe-ae9_L5sww.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Azure凭据另存为GitHub操作机密</p></figure><p id="43cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后添加<em class="mu"> ci.yml </em>文件，推送到GitHub。</p><pre class="kj kk kl km gt mj mk ml mm aw mn bi"><span id="91af" class="mo mp it mk b gy mq mr l ms mt">git add .\.github\workflows\ci.yml<br/>git commit -m "added pipeline"<br/>git push</span></pre><p id="9241" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将这段代码推送到GitHub将启动工作流，并成功地将您的应用程序部署到Azure。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/d5367f617a4e4767208e2afedba639cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cQ8nJNVAfZcK4zvfR2qL2A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">GitHub操作工作流程</p></figure><p id="7cf0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以查看工作流的日志，或者访问Azure门户来获得新web应用的链接。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/199f139174851be8a3c582ab40f63a55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*pC-BG9ziUvMIB242ezeiRg.png"/></div></figure><p id="ce82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读。下次见！</p></div></div>    
</body>
</html>