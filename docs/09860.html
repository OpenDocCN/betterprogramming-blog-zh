<html>
<head>
<title>Avoid the Snake Pit of Python Package Management With Poetry</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用诗意避开Python包管理的蛇坑</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/avoid-the-snake-pit-of-python-package-management-with-poetry-54ab186cf2a4?source=collection_archive---------3-----------------------#2021-10-22">https://betterprogramming.pub/avoid-the-snake-pit-of-python-package-management-with-poetry-54ab186cf2a4?source=collection_archive---------3-----------------------#2021-10-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="db74" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用诗歌构建私有和公共Python库</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6207e089ed0451708d5d2b26f3651e7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ThjUeu85a1B4KtLX"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@thoughtcatalog?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">思想目录</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="d266" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Python是一种给很多开发者带来快乐的编程语言。不幸的是，在Python中构建和使用库一直是一个难题。有多种工具试图提供帮助(仅举几个例子:<code class="fe lv lw lx ly b">setuptools</code>、<code class="fe lv lw lx ly b">pip</code>、<code class="fe lv lw lx ly b">virtualenv</code>、<code class="fe lv lw lx ly b">pipenv</code>、<code class="fe lv lw lx ly b">tox</code>和<code class="fe lv lw lx ly b">conda</code>)，但每种工具都有自己的怪癖和局限性。</p><p id="e21f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们看一下<code class="fe lv lw lx ly b">Poetry</code>，这是一个相对较新的包管理工具，它试图把用Python编程的乐趣带给构建和使用Python库。</p><h1 id="7cb4" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">实践中的诗歌</h1><p id="36ff" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">下面的步骤向您展示了如何用诗歌构建一个库，如何从另一个Python项目中使用这个库，以及如何在<a class="ae ky" href="https://pypi.org/" rel="noopener ugc nofollow" target="_blank"> PyPi </a>上分发这个库以供公共重用。</p><h2 id="5b55" class="mw ma it bd mb mx my dn mf mz na dp mj li nb nc ml lm nd ne mn lq nf ng mp nh bi translated">第一步。装置诗歌</h2><p id="ea70" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">诗歌网站包含大量关于如何在不同操作系统上安装的文档。</p><p id="38b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我已经通过自制软件在我的MacBook上安装了诗歌:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="e927" class="mw ma it ly b gy nm nn l no np">$ brew install poetry<br/>$ poetry --version<br/>Poetry version 1.1.11</span></pre><h2 id="fe0d" class="mw ma it bd mb mx my dn mf mz na dp mj li nb nc ml lm nd ne mn lq nf ng mp nh bi translated">第二步。从头开始创建一个小型Python库</h2><p id="ce1b" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">让我们用诗歌写一个小小的图书馆。这个库将被称为<code class="fe lv lw lx ly b">PyInitials</code>，它的唯一目的是返回给定全名的首字母，例如，“吉多·范·罗苏姆”=&gt;“GvR”。</p><p id="851f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，用诗歌初始化一个新的库项目:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="d2ea" class="mw ma it ly b gy nm nn l no np">$ <strong class="ly iu">poetry new pyinitials</strong><br/>Created package pyinitials in pyinitials</span></pre><p id="fcf1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，创建一个新的虚拟环境，并安装初始的依赖项集:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="a9ce" class="mw ma it ly b gy nm nn l no np">$ <strong class="ly iu">cd pyinitials</strong><br/>[pyinitials] $ <strong class="ly iu">poetry install</strong><br/>Creating virtualenv pyinitials-Q6tcgwA_-py3.9 in /Users/rob/Library/Caches/pypoetry/virtualenvs<br/>Updating dependencies<br/>Resolving dependencies... (1.0s)</span><span id="824a" class="mw ma it ly b gy nq nn l no np">Writing lock file</span><span id="b76d" class="mw ma it ly b gy nq nn l no np">Package operations: 8 installs, 0 updates, 0 removals</span><span id="2e5f" class="mw ma it ly b gy nq nn l no np">• Installing pyparsing (2.4.7)<br/>  • Installing attrs (21.2.0)<br/>  • Installing more-itertools (8.10.0)<br/>  • Installing packaging (21.0)<br/>  • Installing pluggy (0.13.1)<br/>  • Installing py (1.10.0)<br/>  • Installing wcwidth (0.2.5)<br/>  • Installing pytest (5.4.3)</span><span id="e979" class="mw ma it ly b gy nq nn l no np">Installing the current project: pyinitials (0.1.0)</span></pre><p id="b1c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，初始化Git并提交所有生成的文件:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="9a01" class="mw ma it ly b gy nm nn l no np">[pyinitials] $ <strong class="ly iu">git init</strong><br/>[pyinitials] $ <strong class="ly iu">git checkout -b main</strong><br/>[pyinitials] $ <strong class="ly iu">git add *</strong><br/>[pyinitials] $ <strong class="ly iu">git commit -m "Initial commit"</strong></span></pre><p id="da92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，在<a class="ae ky" href="https://docs.github.com/en/get-started/quickstart/create-a-repo" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上创建一个名为<code class="fe lv lw lx ly b">pyinitials</code>的新存储库，将这个存储库作为远程存储库添加到您的本地Git存储库中，并推送所有更改:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="f8fe" class="mw ma it ly b gy nm nn l no np">[pyinitials] $ <strong class="ly iu">git remote add origin git@github.com:&lt;YOUR_GITHUB_USERNAME&gt;/pyinitials.git<br/></strong>[pyinitials] $ <strong class="ly iu">git branch -M main</strong><br/>[pyinitials] $ <strong class="ly iu">git push -u origin main</strong></span></pre><h2 id="43e9" class="mw ma it bd mb mx my dn mf mz na dp mj li nb nc ml lm nd ne mn lq nf ng mp nh bi translated">第三步。添加一些代码和测试</h2><p id="ccc0" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">打开生成的文件<code class="fe lv lw lx ly b">test/test_pyinitials.py</code>并添加第一个单元测试:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="c6cb" class="mw ma it ly b gy nm nn l no np">def test_initials():<br/>    from pyinitials.initials import initials<br/>    assert initials('Guide van Rossum') == 'GvR'</span></pre><p id="6ae0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，运行单元测试(使用诗歌):</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="2fff" class="mw ma it ly b gy nm nn l no np">[pyinitials] $ <strong class="ly iu">poetry run pytest</strong><br/>===================== test session starts ======================<br/>platform darwin -- Python 3.9.7, pytest-5.4.3, py-1.10.0, pluggy-0.13.1<br/>rootdir: /Users/rob/Desktop/pyinitials<br/>collected 2 items</span><span id="1c45" class="mw ma it ly b gy nq nn l no np">tests/test_pyinitials.py .F                               [100%]<br/>================= 1 failed, 1 passed in 0.06s ==================</span></pre><p id="0255" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于导入了一个名为<code class="fe lv lw lx ly b">initials</code>的缺失函数，这将会失败(这并不奇怪)。</p><p id="6b8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要修复测试，请将以下代码添加到一个新文件中:<code class="fe lv lw lx ly b">pyinitials/initials.py</code>:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="28aa" class="mw ma it ly b gy nm nn l no np">def initials(fullname: str) -&gt; str:<br/>    return 'GvR'</span></pre><p id="ec92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，再次运行单元测试，检查它们是否都通过了:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="1347" class="mw ma it ly b gy nm nn l no np">poetry run pytest<br/>===================== test session starts ======================<br/>platform darwin -- Python 3.9.7, pytest-5.4.3, py-1.10.0, pluggy-0.13.1<br/>rootdir: /Users/rob/Desktop/pyinitials<br/>collected 2 items</span><span id="ea50" class="mw ma it ly b gy nq nn l no np">tests/test_pyinitials.py ..                               [100%]<br/>====================== 2 passed in 0.02s =======================</span></pre><h2 id="7168" class="mw ma it bd mb mx my dn mf mz na dp mj li nb nc ml lm nd ne mn lq nf ng mp nh bi translated">第四步。设置持续集成</h2><p id="1749" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">要让单元测试在每次代码推送时运行，你可以在GitHub Actions中设置一个简单的工作流(你可以使用针对诗歌的特定操作。)</p><p id="34a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在目录<code class="fe lv lw lx ly b">.github/workflows</code>中创建一个名为<code class="fe lv lw lx ly b">ci.yml</code>的新文件，包含以下内容:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="1626" class="mw ma it ly b gy nm nn l no np">name: 'CI'</span><span id="a7ca" class="mw ma it ly b gy nq nn l no np">on: [push, pull_request]</span><span id="2101" class="mw ma it ly b gy nq nn l no np">jobs:<br/>  ci:<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>    - name: 'Checkout'<br/>      uses: actions/checkout@v2<br/>    - name: 'Set up Python'<br/>      uses: actions/setup-python@v2<br/>      with:<br/>        python-version: 3.9<br/>    - name: 'Set up Poetry'<br/>      uses: snok/install-poetry@v1<br/>    - name: 'Install dependencies'<br/>      run: poetry install --no-interaction --no-root<br/>    - name: 'Run unit-tests'<br/>      run: poetry run pytest</span></pre><p id="dd19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将所有新文件添加到Git，并将您的更改推送到GitHub。在GitHub中的“Actions”选项卡上，您应该可以看到CI管道的第一次运行:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/1bf654c9e5467f961ab3eaf799efc9bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ggb-twu5-vWhMD8JPLdk5Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CI管道首次成功运行</p></figure><h2 id="54a0" class="mw ma it bd mb mx my dn mf mz na dp mj li nb nc ml lm nd ne mn lq nf ng mp nh bi translated">第五步。在私人组织中使用图书馆</h2><p id="5de2" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">要在私有组织(或您自己的公共python项目)中使用PyInitials库，您可以将其作为Git依赖项添加。对于私有库来说，使用GitHub是建立一个完整的包存储库的一个很好的选择。</p><p id="3ee1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了演示这是如何工作的，您首先需要创建一个新的Python项目，当然也是用诗歌:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="bc9a" class="mw ma it ly b gy nm nn l no np">$ <strong class="ly iu">poetry new mycoolproject<br/></strong>$ <strong class="ly iu">cd mycoolproject<br/></strong>[mycoolproject] $ <strong class="ly iu">poetry install</strong></span></pre><p id="7dc1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，将依赖项添加到GitHub <code class="fe lv lw lx ly b">pyinitials </code>库的主分支:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="c393" class="mw ma it ly b gy nm nn l no np">[mycoolproject] $ <strong class="ly iu">poetry add git+</strong><a class="ae ky" href="https://github.com/robvanderleek/pyinitials.git#main" rel="noopener ugc nofollow" target="_blank"><strong class="ly iu">https://github.com/</strong></a><strong class="ly iu">&lt;YOUR_GITHUB_USERNAME&gt;</strong><a class="ae ky" href="https://github.com/robvanderleek/pyinitials.git#main" rel="noopener ugc nofollow" target="_blank"><strong class="ly iu">/pyinitials.git#main</strong></a></span></pre><p id="ddcc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">#</code>后缀可用于选择分支、标签甚至特定的提交散列，在这种情况下，选择主分支。<br/>如果你的存储库是私有的，使用<code class="fe lv lw lx ly b">git+ssh://</code>链接，确保团队中的每个人(和你的CI/CD管道)都可以使用私有密匙访问存储库。</p><p id="cd20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要检查库是否被成功包含，请在您的诗歌虚拟环境中启动一个shell并调用它:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="ebe6" class="mw ma it ly b gy nm nn l no np">[mycoolproject] $ <strong class="ly iu">poetry shell</strong><br/>Spawning shell within /../mycoolproject-2UmXNoUn-py3.9<br/>$ <strong class="ly iu">python</strong><br/>Python 3.9.7 (default, Sep  3 2021, 12:37:55)<br/>&gt;&gt;&gt; <strong class="ly iu">from pyinitials import initials</strong><br/>&gt;&gt;&gt; <strong class="ly iu">initials('Guido van Rossum')</strong><br/>'GvR'</span></pre><h2 id="0fa8" class="mw ma it bd mb mx my dn mf mz na dp mj li nb nc ml lm nd ne mn lq nf ng mp nh bi translated">第六步。发布到PyPi</h2><p id="4f46" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">poem有两个命令，使得发布到中央Python包存储库变得轻而易举:<code class="fe lv lw lx ly b">build</code>和<code class="fe lv lw lx ly b">publish</code></p><p id="80b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">(在向开源社区发布库之前，确保您的代码和文档遵循了来自<a class="ae ky" href="https://packaging.python.org/" rel="noopener ugc nofollow" target="_blank"> Python打包用户指南</a> ✨的最佳实践)</p><p id="fd06" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，您需要构建发行版本:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="fa39" class="mw ma it ly b gy nm nn l no np">[pyinitials] $ <strong class="ly iu">poetry build<br/></strong>Building pyinitials (1.0.0)<br/>  - Building sdist<br/>  - Built pyinitials-1.0.0.tar.gz<br/>  - Building wheel<br/>  - Built pyinitials-1.0.0-py3-none-any.whl</span></pre><p id="70a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">目录<code class="fe lv lw lx ly b">dist</code>现在包含一个名为<code class="fe lv lw lx ly b">pyinitials-1.0.0.tar.gz</code>的源发行版(sdist)文件和一个名为<code class="fe lv lw lx ly b">pyinitials-1.0.0-py3-none-any.whl</code>的预构建发行版(wheel)文件。</p><p id="6eea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，您可以将两个发行版本发布到Python包存储库:</p><pre class="kj kk kl km gt ni ly nj nk aw nl bi"><span id="3a0c" class="mw ma it ly b gy nm nn l no np">[pyinitials] <strong class="ly iu">poetry publish</strong><br/>Publishing pyinitials (1.0.0) to PyPI<br/> - Uploading pyinitials-1.0.0-py3-none-any.whl 100%<br/> - Uploading pyinitials-1.0.0.tar.gz 100%</span></pre><p id="f772" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">瞧，就这样，发货了！🚀</p><h1 id="7591" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">结论</h1><p id="2f18" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">诗歌是一种工具，它无疑将Python包管理的乐趣带了回来。使用简洁一致的诗歌命令集，创建私有和公共库变得很容易。</p><p id="7608" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面显示的命令正是我在PyPi 上发布和维护<a class="ae ky" href="https://pypi.org/project/pyinitials/" rel="noopener ugc nofollow" target="_blank"> PyInitials包的方式(它也可以为吉多·范·罗苏姆以外的名字生成首字母)。</a></p><p id="06a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">给<a class="ae ky" href="https://python-poetry.org/" rel="noopener ugc nofollow" target="_blank">诗歌一个尝试</a>在你的下一个Python项目中，它有一个平缓的学习曲线。</p><p id="7862" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p><div class="ns nt gp gr nu nv"><a href="https://github.com/robvanderleek/pyinitials" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">GitHub-robvanderleek/py initials</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">这个项目是JavaScript initials包的Python克隆。从PyPi安装，例如用诗歌…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj ks nv"/></div></div></a></div></div></div>    
</body>
</html>