<html>
<head>
<title>Understanding Auth and Cookies for Web Applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解Web应用程序的身份验证和Cookies</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/understanding-auth-and-cookies-for-web-applications-33016c588cf9?source=collection_archive---------1-----------------------#2022-11-01">https://betterprogramming.pub/understanding-auth-and-cookies-for-web-applications-33016c588cf9?source=collection_archive---------1-----------------------#2022-11-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7843" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">停止比较JWT和饼干</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d4a8dd5973e1690d56d588fe3202ff30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Sq0qwNdaVwPTCtFn"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/es/@vyshnavibisani?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Vyshnavi Bisani </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="cc3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于cookies、会话、基于令牌的认证和JWT有很多混淆。</p><p id="e8c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天，我想一劳永逸地澄清人们在谈论“<em class="lv"> JWT vs Cookie </em>、“<em class="lv">本地存储vs Cookie</em>、“<em class="lv">会话vs基于令牌的认证</em>、“<em class="lv">无记名令牌vs Cookie </em>”时的意思。</p><p id="e5ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">给你一个提示——我们应该停止比较JWT和饼干！</p><p id="ff6e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">沿着这条线，我将通过什么是XSS和CSRF攻击，以及如何防止他们使用JWT和CSRF令牌基于令牌的认证。</p><p id="b3f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们开始吧！</p><h1 id="e02f" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">术语速度跑</h1><p id="68f5" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">首先，了解这些术语之间的区别很重要。</p><p id="b51b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果不明确说明这些，我们就不清楚如何恰当地进行比较。</p><h2 id="ffb0" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">客户</h2><p id="9ddc" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我们的客户端应用程序。在这种情况下，我们特指我们的网络浏览器，如Firefox、Brave、Chrome等。</p><h2 id="f97d" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">计算机网络服务器</h2><p id="5fae" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在窗帘后施展所有魔法的电脑。</p><h2 id="11c9" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">请求/响应标头</h2><p id="4616" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated"><a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers" rel="noopener ugc nofollow" target="_blank"> HTTP头</a>。请注意，它们不区分大小写。</p><h2 id="feeb" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">饼干</h2><p id="170a" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">又名“HTTP cookie”、“web cookie”或“浏览器cookie”</p><p id="5f3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">服务器发送回客户端的一小段信息。</p><p id="512d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">cookie存储在浏览器的cookie存储中，通常用于身份验证、个性化和跟踪。</p><p id="2263" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">cookie是通过请求中的<code class="fe nf ng nh ni b">Set-Cookie</code>响应头以名称-值对的形式接收的。这样，您的cookie将自动保存在浏览器的cookie存储中(<code class="fe nf ng nh ni b">document.cookie</code>)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/fb7a7051a4d307e3a141ef11e94bad64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fsFpVLXotSTVY-Jk.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如何接收Cookie的示例。你不应该公开分享你的JWT！(这种JWT已不再使用)。</p></figure><p id="fedb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">带有<code class="fe nf ng nh ni b">HttpOnly</code>、<code class="fe nf ng nh ni b">Secure</code>、<code class="fe nf ng nh ni b">SameSite=Strict</code>旗帜的Cookies更安全。</p><p id="5eeb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，有了<code class="fe nf ng nh ni b">HttpOnly</code>标志，就不能通过JavaScript访问cookies，从而使其免受XSS攻击。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/9538ed541a9fadfb07ea82a4bfc2cf79.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/0*AMdcAIC3sNn0_GjA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用HttpOnly时，不显示cookie</p></figure><p id="91fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">阅读更多关于MDN 的内容，并查看其他旗帜的功能(它们很方便)。</p><h2 id="11fd" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">XSS攻击</h2><p id="4ff0" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">又名“跨站点脚本”攻击。</p><p id="db40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于上下文，web存储(例如，本地存储)可通过同一域上的JavaScript来访问。因此，网络存储容易受到XSS攻击。</p><p id="005c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简而言之，XSS是一种漏洞，攻击者在其中注入将在您的页面上运行的JavaScript。</p><p id="f76d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基本的XSS攻击试图通过表单输入注入JavaScript，攻击者将一个<code class="fe nf ng nh ni b">alert(localStorage.getItem('your-secret-token'))</code>放入表单，以查看它是否由浏览器运行，以及是否可以被其他用户查看。</p><p id="7c54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你仍然不明白XSS是什么，看看这个“XSS解释”视频。</p><h2 id="df3a" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">CSRF攻击</h2><p id="5762" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">又名“跨站点请求伪造”攻击。</p><p id="8d25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Cookies容易受到CSRF攻击。没有饼干=没有CSRF袭击。</p><p id="3d51" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于浏览器会自动发送带有所有请求的Cookies，CSRF攻击利用这一点来获得对可信站点的认证访问。需要更多吗？用简单的词语阅读CSRF。</p><p id="885e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了保护您的网站在使用Cookies时免受CSRF攻击(使用<code class="fe nf ng nh ni b">SameSite=None</code>)，请查看这个<a class="ae ky" href="https://stackoverflow.com/questions/34782493/difference-between-csrf-and-x-csrf-token/34783845#34783845" rel="noopener ugc nofollow" target="_blank"> StackOverflow答案</a>。接下来，在维基百科上阅读更多关于<a class="ae ky" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery#Prevention" rel="noopener ugc nofollow" target="_blank"> CSRF预防的内容</a>(维基百科一般都太干巴巴了，我不喜欢，但这很好！).</p><p id="4337" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还不明白CSRF是什么吗？看看这个“CSRF解释”视频。</p><h2 id="1a9b" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">Cookies存储</h2><p id="a4db" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">又名“饼干罐”或“饼干”是的。我已经明白为什么它让许多人感到困惑。</p><p id="0e80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">存储HTTP cookies的客户端存储。</p><p id="2f13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里有一个重要的注意事项:浏览器通过<code class="fe nf ng nh ni b">cookie</code>请求头自动发送cookies(不需要客户端代码)和每个请求。这正是Cookie(存储)易受CSRF攻击的原因。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/6ef72ecb5e43741ad78fd6a3ed6f47ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9xJNPro2yy0w_nUC.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如果cookie设置了HttpOnly标志，则在使用cookie存储时可以防止XSS攻击。</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/efddea74981b3ab58105e4c87d175d40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mbLtNIZov5UHbnAF.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">要查看cookie:F12→“应用程序”→“存储”→“cookie”</p></figure><h2 id="53e3" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">网络存储</h2><p id="966e" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">又名“本地/会话存储”</p><p id="ba22" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">客户端存储。它们通常用于以键值对的形式存储数据。</p><p id="73c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">易受XSS攻击。因此，对于存储私有/敏感/身份验证相关的数据来说并不理想。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/417d26de8fe44b1bd4797805240dad5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/0*O2bCEf47g4OzSs_I.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">您可以使用JavaScript获取本地存储上的任何项目</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/6abd409ac18388785749dc5405792bd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_jkAe1_ar0fAg5A2.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">要查看本地存储项目:F12 →“应用程序”→“存储”→“本地存储”/“会话存储”</p></figure><p id="9549" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nf ng nh ni b">sessionStorage</code> —数据仅在页面会话期间保留</p><p id="cb0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nf ng nh ni b">localStorage</code> —即使关闭并重新打开浏览器，数据仍然存在</p><p id="cfa8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API" rel="noopener ugc nofollow" target="_blank">阅读更多关于MDN </a>的信息。</p><h2 id="735d" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">Cookies(存储)与网络存储</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/d686114c46be9695f2cc009cc25d00dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ujpTl7tipBODKg2oebbJSg.png"/></div></div></figure><h1 id="1ac2" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">JWT</h1><p id="29e1" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">又名“JSON Web令牌”</p><p id="d8c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">常用于<a class="ae ky" href="https://www.okta.com/identity-101/authentication-vs-authorization/#authentication-vs-authorization-2" rel="noopener ugc nofollow" target="_blank">认证和授权</a>。</p><p id="e76a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">JWT是一个开放标准(<a class="ae ky" href="https://tools.ietf.org/html/rfc7519" rel="noopener ugc nofollow" target="_blank"> RFC 7519 </a>)。这意味着所有的jwt都是令牌。</p><p id="493f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，JWT存储在本地存储或Cookies(存储)中。</p><p id="f64c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">记住，JWT没有被加密。</p><p id="a766" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相反，它是以Base64编码的。尝试在<a class="ae ky" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> jwt.io </a>上解码任何JWT。</p><h2 id="4de4" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">那么，为什么要用JWT呢？</h2><p id="24c0" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">通常与基于令牌的身份认证一起使用，使用JWT时，水平扩展更容易。</p><p id="bcb8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为什么？JWT的验证不需要服务器和数据库之间的任何通信。换句话说，认证可以是无状态的。</p><p id="28d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://auth0.com/docs/secure/tokens/json-web-tokens" rel="noopener ugc nofollow" target="_blank">阅读更多关于Auth0 </a>的内容。</p><h2 id="67b8" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">别拿JWT和曲奇做比较了</h2><p id="e6d7" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">JWT和Cookie本身都不是身份验证机制。</p><p id="bf42" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">JWT仅仅是一种<a class="ae ky" href="https://www.rfc-editor.org/rfc/rfc7519" rel="noopener ugc nofollow" target="_blank">令牌格式</a>。</p><p id="2b97" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">cookie是一种<a class="ae ky" href="https://www.rfc-editor.org/rfc/rfc6265" rel="noopener ugc nofollow" target="_blank"> HTTP状态管理机制</a>。</p><p id="8b31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如前所述，web cookie可以包含JWT，并且可以存储在浏览器的cookie存储中。</p><p id="214f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，我们需要停止比较JWT和饼干。</p><h1 id="c555" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">基于会话与基于令牌的身份验证</h1><p id="6d89" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">相反，应该问的问题是，“基于令牌的身份验证和基于会话的身份验证之间有什么区别？”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/5eaf274a658abfc11841b0038f1594a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I0GUiXUwTbMF2BRBU9kCaQ.png"/></div></div></figure><h1 id="6cf5" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">Cookie与不记名令牌</h1><p id="a6f5" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">现在，我们知道饼干是如何工作的。让我们尝试一下术语“不记名代币”让我们假设从现在开始我们将使用JWT作为我们的认证令牌。</p><p id="6358" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">人们称之为“承载令牌”的是一个字符串(例如，JWT)，它被放入任何HTTP请求的<code class="fe nf ng nh ni b">Authorization</code>报头中。与浏览器cookie不同，它不会自动存储在任何地方，因此这种CSRF是不可能的。</p><p id="2811" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了使用“不记名令牌”，我们需要将JWT显式地存储在客户端的某个地方(Cookies存储或本地存储)，并在发出请求时将该JWT添加到HTTP <code class="fe nf ng nh ni b">Authorization</code>头中。</p><p id="4404" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的包含JWT的cookie设置了<code class="fe nf ng nh ni b">HttpOnly</code>标志，那么用JavaScript从客户端检索您的令牌是不可能的。</p><p id="e3a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">"等等，我们用本地存储怎么样？"</p><p id="ebfe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请记住，使用本地存储会使我们的JWT容易受到XSS的攻击。因此，你会经常听到有人强烈反对将JWT储存在本地。</p><p id="84b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此时，使用Cookie来存储JWT似乎是我们唯一的选择。但是请记住，这使得我们的网站容易受到CSRF攻击！</p><h1 id="9b7a" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">CSRF预防</h1><h2 id="fdae" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">相同站点的Cookies</h2><p id="9358" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated"><a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite" rel="noopener ugc nofollow" target="_blank">同场cookie</a>可以有效防止CSRF攻击。不过，它也有其他的警告。<a class="ae ky" href="https://security.stackexchange.com/questions/121971/will-same-site-cookies-be-sufficient-protection-against-csrf-and-xss/121986#121986" rel="noopener ugc nofollow" target="_blank">此处阅读更多内容</a>。</p><p id="0e5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来的内容假设我们不会使用SameSite cookies。</p><h2 id="bf33" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">常见的CSRF预防方法</h2><p id="4082" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">暂且不谈JWT，这两种是最常见的CSRF预防方法:</p><ul class=""><li id="fe95" class="nr ns it lb b lc ld lf lg li nt lm nu lq nv lu nw nx ny nz bi translated"><a class="ae ky" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery#Synchronizer_token_pattern" rel="noopener ugc nofollow" target="_blank">同步器令牌模式</a></li><li id="ca07" class="nr ns it lb b lc oa lf ob li oc lm od lq oe lu nw nx ny nz bi translated"><a class="ae ky" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery#Cookie-to-header_token" rel="noopener ugc nofollow" target="_blank"> Cookie-to-header-token模式</a></li></ul><p id="e015" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">查看这个<a class="ae ky" href="https://stackoverflow.com/questions/34782493/difference-between-csrf-and-x-csrf-token/34783845#34783845" rel="noopener ugc nofollow" target="_blank"> StackOverflow答案</a>快速总结上述两种方法。</p><p id="bd59" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">酷毙了。但现在问题来了——我们如何才能在JWT问题上做到这一点？</p><h2 id="e741" class="mt lx it bd ly mu mv dn mc mw mx dp mg li my mz mi lm na nb mk lq nc nd mm ne bi translated">改进的“cookie-to-header令牌”方法</h2><p id="2f89" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">老实说，我不太确定这种方法是否有一个合适的名字。我从Hubert Sablonnière关于JWT(JSON Web Token)100%无状态的精彩演讲中发现了这个方法。我强烈建议你去看看。这一小时是值得的。</p><p id="8649" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简而言之，修改后的方法(在我看来)看起来与最初的<a class="ae ky" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery#Cookie-to-header_token" rel="noopener ugc nofollow" target="_blank"> Cookie-to-header token方法</a>相似，除了一些调整:</p><ul class=""><li id="ee53" class="nr ns it lb b lc ld lf lg li nt lm nu lq nv lu nw nx ny nz bi translated">反CSRF令牌在单独的响应报头(例如<code class="fe nf ng nh ni b">X-CSRF-Token</code>)而不是<code class="fe nf ng nh ni b">Set-Cookie</code>响应报头中返回</li><li id="476f" class="nr ns it lb b lc oa lf ob li oc lm od lq oe lu nw nx ny nz bi translated">我们在<code class="fe nf ng nh ni b">Set-Cookie</code>响应头上签名并设置一个JWT</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/3800365d80454974da43291c8145139d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yfO1dZMdkPRzUECy.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这个实现可以在<a class="ae ky" href="https://worker-auth.jerrynsh.workers.dev/" rel="noopener ugc nofollow" target="_blank">这个Cloudflare Worker demo </a>和<a class="ae ky" href="https://github.com/ngshiheng/worker-auth" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p></figure><ol class=""><li id="1696" class="nr ns it lb b lc ld lf lg li nt lm nu lq nv lu og nx ny nz bi translated">用户登录，服务器签署一个带有<code class="fe nf ng nh ni b">csrfToken</code>的JWT，作为JWT声明的一部分。</li></ol><pre class="kj kk kl km gt oh ni oi oj aw ok bi"><span id="c15b" class="mt lx it ni b gy ol om l on oo">{<br/>  "email": "<a class="ae ky" href="mailto:your@email.com" rel="noopener ugc nofollow" target="_blank">your@email.com</a>",<br/>  "exp": 1666798498,<br/>  "csrfToken": "1449bd3e-41c2-45cb-a538-73c7ad80ca2c",<br/>  "iat": 1666794898<br/>}</span></pre><p id="ff1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">生成的<code class="fe nf ng nh ni b">csrfToken</code>应该是不可预测的和唯一的每用户会话。</p><p id="f314" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2.然后，JWT将被字符串化成一个cookie，并设置到<code class="fe nf ng nh ni b">Set-Cookie</code>响应头中。另一方面，随机生成的<code class="fe nf ng nh ni b">csrfToken</code>将被设置在<code class="fe nf ng nh ni b">X-CSRF-Token</code>响应报头中。</p><p id="3e0b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">3.响应头中有了<code class="fe nf ng nh ni b">Set-Cookie</code>头，我们的浏览器会自动将JWT存储在Cookies(存储)中。出现在<code class="fe nf ng nh ni b">X-CSRF-Token</code>标题中的<code class="fe nf ng nh ni b">csrfToken</code>将被提取并设置在浏览器的本地存储器中。</p><p id="3431" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">4.当一个请求(例如GET /hello)被触发时，我们的浏览器将从本地存储中获取<code class="fe nf ng nh ni b">csrfToken</code>。</p><p id="ad13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">5.来自Cookies(存储)的JWT和从本地存储检索到的<code class="fe nf ng nh ni b">csrfToken</code>将在我们的请求头中发送到服务器。</p><p id="1279" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">6.服务器将验证JWT，并检查请求头中的<code class="fe nf ng nh ni b">csrfToken</code>和JWT中的<code class="fe nf ng nh ni b">csrfToken</code>声明，以验证CSRF令牌是否有效。</p><h1 id="2384" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">结论</h1><p id="6214" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">本质上，只要认证不是自动的(比如在带有Cookies的浏览器中)，就不必担心CSRF攻击。</p><p id="9e2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如果您的应用程序通过<code class="fe nf ng nh ni b">Authorization</code>头附加认证凭证，CSRF是不可能的，因为浏览器不能自动认证请求。</p><p id="bb05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们需要停止鼓吹我们的任何比较都更好。事情不是这样的。相反，我们应该考虑我们正在做出的权衡。</p><h1 id="4b82" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">或许是个演示？</h1><p id="11f5" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">这篇文章中的截图摘自我制作的这个Cloudflare Worker演示。这个演示的源代码可以在GitHub 上找到<a class="ae ky" href="https://github.com/ngshiheng/worker-auth" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="576d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了测试CSRF攻击，看看这个<a class="ae ky" href="https://littletools.app/form?eyJtZXRob2QiOiJQT1NUIiwiYWN0aW9uIjoiaHR0cHM6Ly93b3JrZXItYXV0aC5qZXJyeW5zaC53b3JrZXJzLmRldi9oZWxsbyIsImZpZWxkcyI6W119" rel="noopener ugc nofollow" target="_blank">小工具</a>(致谢:<a class="ae ky" href="https://sharats.me/" rel="noopener ugc nofollow" target="_blank"> Shrikant </a>)。</p><p id="29f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除此之外，我创建了一个名为 <code class="fe nf ng nh ni b"><a class="ae ky" href="https://github.com/ngshiheng/worker-auth/tree/csrf-attack-demo" rel="noopener ugc nofollow" target="_blank">csrf-attack-demo</a></code>的<a class="ae ky" href="https://github.com/ngshiheng/worker-auth/tree/csrf-attack-demo" rel="noopener ugc nofollow" target="_blank">分支，您可以在本地运行它来模拟CSRF对我们演示站点的攻击。</a></p><h1 id="f8b1" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">参考</h1><p id="ab67" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我感谢以下所有参考资料:</p><ul class=""><li id="b211" class="nr ns it lb b lc ld lf lg li nt lm nu lq nv lu nw nx ny nz bi translated"><a class="ae ky" href="https://www.youtube.com/watch?v=67mezK3NzpU" rel="noopener ugc nofollow" target="_blank"> 100%无状态的JWT (JSON Web Token)作者Hubert Sablonnière </a></li><li id="c67a" class="nr ns it lb b lc oa lf ob li oc lm od lq oe lu nw nx ny nz bi translated"><a class="ae ky" href="https://blog.ropnop.com/storing-tokens-in-browser/" rel="noopener ugc nofollow" target="_blank">如何在浏览器中存储会话令牌(以及每个令牌的影响)</a></li></ul></div><div class="ab cl op oq hx or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="im in io ip iq"><pre class="kj kk kl km gt oh ni oi oj aw ok bi"><span id="16a0" class="mt lx it ni b gy ol om l on oo"><strong class="ni iu">Want to Connect?</strong></span><span id="bfb4" class="mt lx it ni b gy ow om l on oo">This article was originally published at <a class="ae ky" href="https://jerrynsh.com/all-to-know-about-auth-and-cookies/" rel="noopener ugc nofollow" target="_blank">jerrynsh.com</a></span></pre></div></div>    
</body>
</html>