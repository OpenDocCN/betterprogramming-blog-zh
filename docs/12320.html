<html>
<head>
<title>Dynamically Increase Your AWS EBS Volumes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">动态增加您的AWS EBS数量</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/dynamically-increase-your-aws-ebs-volumes-ed9683632510?source=collection_archive---------7-----------------------#2022-05-27">https://betterprogramming.pub/dynamically-increase-your-aws-ebs-volumes-ed9683632510?source=collection_archive---------7-----------------------#2022-05-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9d15" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">还能省下一大笔钱！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1a227eb444c770d2a999a4afd76926cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NrAV50aFzt8cbXbO"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@igalness?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">伊加尔内斯</a>拍摄</p></figure><p id="197e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">免责声明:如果您考虑在生产中使用这个脚本，我真的建议您在现实生活中测试它，并确保您已经知道您的应用程序是如何消耗磁盘空间的。即使节省一些钱听起来是一个好主意，但让您的业务正常运行也比系统由于一些磁盘问题而受损要好。</p><p id="fce6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我这边，这个脚本只在非prod环境中运行。</p><p id="a0d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在考虑使用这个脚本之前，也请仔细阅读AWS警告。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/86456b4afd44e93840493bba6e6dd250.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bs3HgwHdCsQmxPcpvjgLBg.png"/></div></div></figure><p id="52b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您不在每一个级别优化成本，运行多个环境会耗费大量成本。一个典型的例子是，您不需要让环境全天候运行，因为大部分时间您的用户都不在工作。<br/>但是你还有很多其他的优化技巧，可以用来节省更多的钱。我们今天将讨论一个问题，即EBS卷未使用的磁盘空间。</p><p id="204d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在继续之前，我们必须假设您满足一些先决条件，以符合我们将讨论的逻辑:</p><ol class=""><li id="f687" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">您使用的是GP3卷，这意味着默认情况下您有3，000个IOPS —这对于GP2卷是不可能的，因为使用GP2卷，总IOPS是由AWS(总磁盘空间* 3)计算的</li><li id="1a8a" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">你运行的是Linux(我相信同样的逻辑也可以适用于Windows，但是我对Win Server并不是很熟悉)——官方的resize文档可以在<a class="ae ky" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</li><li id="3130" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">每个EC2实例只能连接一个EBS卷。该脚本目前适用于单个分区(您可以配置)，但可以改进以处理多个驱动器(我这边没有这种需求)。</li><li id="d5e7" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">站点注释:您只能每六小时请求一次相同数量的EBS增加。所以，慎重选择你的门槛！</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/a0a52372afb2ac07dc90ac34081b7d31.png" data-original-src="https://miro.medium.com/v2/resize:fit:764/format:webp/1*nuNysNiovIiEwcqdxm4fBA.jpeg"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们将要开发的逻辑的概述</p></figure><p id="b240" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的模式描述了脚本的工作方式:</p><ol class=""><li id="1a1e" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">cron作业将每隔X分钟(比如10分钟)触发我们的脚本</li><li id="dbe3" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">当被触发时，脚本将评估我们的分区是否需要扩展。我们有两个选择:</li><li id="62ff" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">1.不需要扩展——因此脚本将等待下一次执行<br/> 2。需要伸展一下吗？然后，我们将要求AWS扩展我们的EBS驱动器，然后增加我们的本地磁盘/分区</li><li id="643e" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">重复同样的逻辑</li></ol><blockquote class="ml mm mn"><p id="fb6b" class="kz la mo lb b lc ld ju le lf lg jx lh mp lj lk ll mq ln lo lp mr lr ls lt lu im bi translated">我们将要讨论的代码都是关于Python的。注意，我没有找到任何处理文件系统的好方法，所以我主要使用os模块和一些awk命令。任何替代方案将不胜感激！如果你只对剧本本身感兴趣，请跳到文章末尾</p></blockquote><p id="e50e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了让您更好地理解引擎，我将脚本分成三部分:第一部分与FS磁盘使用有关，第二部分与AWS有关，最后一部分是关于扩展我们的本地驱动器。</p><h1 id="c8c0" class="ms mt it bd mu mv mw mx my mz na nb nc jz nd ka ne kc nf kd ng kf nh kg ni nj bi translated"><strong class="ak">分析磁盘使用情况</strong></h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="3966" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我们有三项职能。他们在这里:</p><ol class=""><li id="98a7" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated"><code class="fe nm nn no np b">check_usage</code> = &gt;这个函数将文件系统作为一个参数(这里是<code class="fe nm nn no np b">/</code>)，并将运行一个shell ( <code class="fe nm nn no np b">df -h / | tail -1 | awk '{sub("%","");print $5}'</code>)命令来获取当前的使用情况。请注意，我在这里只处理Go…</li><li id="4fc3" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><code class="fe nm nn no np b">get_current_partition_size</code> = &gt;与第一个类似，取一个<code class="fe nm nn no np b">FS</code>作为参数，这次返回分区大小。将在第三种方法中使用。</li><li id="6634" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><code class="fe nm nn no np b">calculate_value_to_provision</code> = &gt;应用一个简单的数学函数<code class="fe nm nn no np b">(current_fs_usage / minimum_percentage * 100) — current_fs_size </code>将你的分区增加到预定义的阈值。注意，如果需要的空间小于<code class="fe nm nn no np b">5go</code>，我们将它转换为<code class="fe nm nn no np b">5go</code>，以避免增加很小的空间。</li></ol><h1 id="c39d" class="ms mt it bd mu mv mw mx my mz na nb nc jz nd ka ne kc nf kd ng kf nh kg ni nj bi translated">AWS Ebs —通过API增加本地音量</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="6b88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里定义了更多的方法，但仍然是在我们开始掌握的AWS逻辑中。他们在这里:</p><ol class=""><li id="9bd2" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated"><code class="fe nm nn no np b"><em class="mo">get_instance_id</em></code> = &gt;使用EC2元数据检索实例id</li><li id="3743" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><code class="fe nm nn no np b"><em class="mo">get_region</em></code> = &gt;使用EC2元数据返回实例运行的区域</li><li id="e76f" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><code class="fe nm nn no np b"><em class="mo">init_ec2_client</em></code> = &gt;返回一个EC2客户端，参数为实例区域</li><li id="5051" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><code class="fe nm nn no np b"><em class="mo">identify_ebs_volume</em></code> = &gt;使用我们的实例id作为参数查询AWS EC2 API，并返回EBS id。请注意，仅当我们连接了一个驱动器时，才起作用</li><li id="6988" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><code class="fe nm nn no np b"><em class="mo">get_volume_size</em></code> = &gt;返回我们的EBS卷大小。它将用于检查从AWS的角度来看是否已经进行了扩展，但是在操作系统方面没有成功</li><li id="4cf5" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><code class="fe nm nn no np b"><em class="mo">extend_volume</em></code> = &gt;向AWS请求更多关于我们的EBS的信息</li><li id="c10e" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">等待我们的新存储在本地可用。注意，boto3中没有原生的waiter(如果你想实现的话，戳AWS！)在EBS修改之后。所以我不得不根据文档做一点调整，文档上说一旦EBS的状态被优化，我们就可以使用它。</li></ol><h1 id="9a05" class="ms mt it bd mu mv mw mx my mz na nb nc jz nd ka ne kc nf kd ng kf nh kg ni nj bi translated">扩展我们的本地磁盘和文件系统</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="2770" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里又是三个函数，让我们保持简单！</p><ol class=""><li id="0b69" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated"><code class="fe nm nn no np b"><em class="mo">get_main_disk</em> </code> = &gt;我们需要根据分区来确定磁盘名称。一点点lsblk就好了！以字符串形式返回磁盘名称(如<code class="fe nm nn no np b">nvme0n1</code>)</li><li id="8223" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><code class="fe nm nn no np b"><em class="mo">extend_disk</em> </code> = &gt;将新找到的磁盘扩展到EBS大小。如果您的EBS是50Go，而您的磁盘是40，那么您的新磁盘大小将变成50。</li><li id="42a2" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><code class="fe nm nn no np b"><em class="mo">extend_partition</em></code> = &gt;最后一步是扩展分区。因为一个磁盘可以有多个分区，所以即使我们在示例中只运行一个分区，也需要执行这个步骤。在任何情况下，磁盘和分区都必须分开管理。</li></ol></div><div class="ab cl nq nr hx ns" role="separator"><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv nw"/><span class="nt bw bk nu nv"/></div><div class="im in io ip iq"><p id="2362" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们完了。最后一步是在<code class="fe nm nn no np b">__main__</code>下创建你的算法逻辑，你就可以开始了！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/8eb0207e31d1aad71e013b9062073640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7trx_sM6wjTj3-Ar4OYgFA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">您可以实现的逻辑示例</p></figure><p id="55eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你需要，可以在git 上找到完整的脚本<a class="ae ky" href="https://gist.github.com/gmariette/d85f113b0a80f85f1ecab1bf31593d18" rel="noopener ugc nofollow" target="_blank">。请随意评论任何建议/问题，我将非常乐意帮忙！</a></p><p id="e6a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你(不)喜欢这篇文章，请告诉我！</p><p id="f06f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一篇AWS文章再见。</p></div></div>    
</body>
</html>