<html>
<head>
<title>Writing Tests Using a Real Database (for Higher Confidence)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用真实的数据库编写测试(为了更高的可信度)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/writing-tests-using-a-real-database-for-higher-confidence-ea509d2c9843?source=collection_archive---------9-----------------------#2021-06-10">https://betterprogramming.pub/writing-tests-using-a-real-database-for-higher-confidence-ea509d2c9843?source=collection_archive---------9-----------------------#2021-06-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="08fd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">因为没有一个内存数据库提供程序能够很好地模拟真实情况</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/36d2a1bf4d381c35486f3432accd287b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J_zLquFjy1mLMfR71gD3RQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">尼克拉斯·米勒德拍摄的图片</p></figure><p id="470e" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">总有一天，单元测试和嘲笑不会解决问题。</p><p id="0bdf" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">给定一些预期的输入，当您想要验证一段代码是否正确运行时，使用模拟数据库编写单元测试可能会非常有用。</p><p id="fe7e" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">下一步自然是使用内存提供程序。但是，尽管内存提供者很有用，但与真正的东西相比，它只是一个空壳。例如，在内存数据库中测试时成功的查询在实际数据库中执行时可能会失败。</p><p id="d527" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">内存数据库给你一种虚假的自信感。</p><p id="ffce" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">您最终需要确信您的数据访问层将在生产环境中运行，指向一个真实的数据库。</p><p id="3e58" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">许多开发人员专注于编写自动化单元测试，然后通过启动整个应用程序、设置调试点或诸如此类的东西，并看到它成功，来手动执行“集成”测试。</p><p id="5103" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这是一个繁琐的过程。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="2551" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">正确优先于速度</h1><p id="90c3" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">通常有两个反对在自动化测试设置中使用真实数据库的理由:</p><ol class=""><li id="da20" class="na nb it lc b ld le lg lh lj nc ln nd lr ne lv nf ng nh ni bi translated">每次供应和使用真实数据库的成本都很高。</li><li id="7ddf" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">很慢。在网络上运行查询会花费更多时间，并减慢反馈循环。</li></ol><p id="c5ae" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">但是我要说的是:用真实的东西进行测试提供了一种信心，这是任何模拟或内存替代方法都无法提供的。</p><p id="29b9" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">此外，在测试过程中发现问题比让最终用户发现错误要好。在发布之前修复Bug是很便宜的。修复已发布版本的错误可能是一场噩梦——尤其是在处理丢失或损坏的数据时。</p><p id="9e54" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">您可以轻松地在本地安装一个版本的数据库并使用它，使用Docker很容易做到。</p><p id="8bf0" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">如果您需要在CI/CD管道中运行集成测试，您可以编写资源模板来提供数据库，创建一个集成用户，运行测试，然后再次拆除整个系统。</p><p id="2e87" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在如此短的时间内运行一个数据库的成本可以忽略不计，您甚至可以在管道中使用Docker。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="2c61" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">你不需要测试所有的东西</h1><p id="1ef3" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">这显然取决于您的领域、行业标准和法规遵从性，但是在某些情况下，您通常可以只使用真正的数据库。</p><p id="5949" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我会优先确保我的迁移脚本能够完美工作，并且查询比简单的“选择”和“插入”工作更复杂。</p><p id="81fa" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">如果您使用存储库模式——只有您的存储库可以直接访问数据——覆盖存储库的公共接口也是有意义的。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="778a" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">这是一个简单的三步过程</h1><p id="8414" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">在提供数据库之后，您需要将三个简单的步骤合并到您的测试设置中:</p><ol class=""><li id="2fb5" class="na nb it lc b ld le lg lh lj nc ln nd lr ne lv nf ng nh ni bi translated">确保数据库已被删除。</li><li id="d95f" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">创建数据库。</li><li id="5700" class="na nb it lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">应用迁移。</li></ol><p id="5761" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">本质上，您总是希望从一个干净的数据库开始您的测试。删除现有的集成数据库是正确的做法。很明显，您可以截断所有的表或以某种方式清除数据，但更容易的是放弃所有的东西。</p><p id="f06b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">然后创建数据库。我通常选择与主名称相同的名称，但使用一个后缀，如“. integrationtests”</p><p id="1387" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">顺便说一下，不要使用您的数据库管理员帐户来创建和运行测试。相反，创建一个专门的集成或测试用户，该用户具有创建数据库的权限，并撤销对主数据库的所有权限。</p><p id="66a8" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">最后，您可以运行您的迁移。我总是喜欢编写迁移脚本，然后在集成数据库上运行脚本。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="3be5" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">你的主要收获</h1><p id="4ca5" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">使用模拟的或内存中的数据库测试您的数据访问层只能为您提供一定程度的信心。</p><p id="c84a" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">甚至可能是虚假的自信。</p><p id="d277" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在测试中切换到使用真实的数据库是关于优先考虑正确性而不是速度。刚开始启动并运行它似乎很难，但只需要三个简单的步骤。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="187b" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">让我们保持联系！</h1><p id="c086" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated"><a class="ae no" href="https://nmillard.medium.com/subscribe" rel="noopener">点击这里</a>订阅时事通讯，获取类似文章的通知，并查看YouTube新频道<a class="ae no" href="https://www.youtube.com/channel/UCaUy83EAkVdXsZjF3xGSvMw" rel="noopener ugc nofollow" target="_blank"><em class="np">(@尼可拉斯·米勒德)</em> </a></p><p id="d0a4" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><em class="np">连接上</em> <a class="ae no" href="https://www.linkedin.com/in/nicklasmillard/" rel="noopener ugc nofollow" target="_blank"> <em class="np"> LinkedIn </em> </a></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="b4f0" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">好奇者的资源</h1><ul class=""><li id="fefb" class="na nb it lc b ld mv lg mw lj nq ln nr lr ns lv nt ng nh ni bi translated"><a class="ae no" href="https://docs.microsoft.com/en-us/ef/core/testing/" rel="noopener ugc nofollow" target="_blank">在微软文档中测试使用EF核心</a>的代码</li></ul></div></div>    
</body>
</html>