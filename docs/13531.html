<html>
<head>
<title>How To Set Up a Next.js Supabase Auth for Your App’s Frontend and Backend</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为应用程序的前端和后端设置Next.js Supabase身份验证</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-set-up-a-next-js-supabase-auth-for-your-apps-frontend-and-backend-ae23a892693e?source=collection_archive---------9-----------------------#2022-09-05">https://betterprogramming.pub/how-to-set-up-a-next-js-supabase-auth-for-your-apps-frontend-and-backend-ae23a892693e?source=collection_archive---------9-----------------------#2022-09-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5c7d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">开发者分步指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f53545d9a3f928e71de44e4de31e8bc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kQpB8Cec9-j2K52D"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@firmbee?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Firmbee.com</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="5c5f" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">什么是Supabase？</h1><p id="53ea" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">正如他们所描述的，Supabase是Firebase的开源替代品。这是一个托管的Postgres环境，具有额外的功能，如身份验证、存储和实时功能。</p><h2 id="425f" class="mn la it bd lb mo mp dn lf mq mr dp lj ma ms mt ll me mu mv ln mi mw mx lp my bi translated">你将学到什么</h2><p id="a9f0" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本文中，我将向您展示如何在前端和后端设置Supabase auth。这里我们将使用Next.js作为一个例子。出于演示目的，我们将使用<a class="ae ky" href="https://github.com/ykdojo/supabase-nextjs-simple-auth" rel="noopener ugc nofollow" target="_blank">这个示例回购</a>。</p><h2 id="5498" class="mn la it bd lb mo mp dn lf mq mr dp lj ma ms mt ll me mu mv ln mi mw mx lp my bi translated">阅读这篇文章之前，你需要知道什么</h2><p id="065b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我假设你至少对Supabase有所了解。先前对Next.js的了解将会有所帮助，但是理解本文并不是必需的。</p><h2 id="7c83" class="mn la it bd lb mo mp dn lf mq mr dp lj ma ms mt ll me mu mv ln mi mw mx lp my bi translated">先决条件</h2><p id="36d5" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们将在本文中使用npm，所以要确保它安装在您的系统中。一定要注册一个Supabase账户。</p><p id="2994" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">现在，让我们进入本教程的主要部分。</p><h1 id="4e2d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤1:克隆示例回购</h1><p id="fba6" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">一旦你具备了先决条件，在这里找到示例回购<a class="ae ky" href="https://github.com/ykdojo/supabase-nextjs-simple-auth" rel="noopener ugc nofollow" target="_blank">，然后克隆它。</a></p><h1 id="79bf" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">第二步:做一个关于supabase.com的新项目</h1><p id="7b85" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在Supabase的网站上创建一个新的组织和项目。</p><h1 id="1ec9" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤3:在本地设置项目</h1><p id="63b0" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">然后，进入克隆的目录，将. env.template复制到. env。</p><p id="3c01" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">去Supabase，进入你的项目-&gt;设置-&gt; API。将您的密钥复制并粘贴到您新创建的。环境文件。</p><p id="fbcd" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">然后，运行:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="ff09" class="mn la it nf b gy nj nk l nl nm">npm install</span><span id="7ec8" class="mn la it nf b gy nn nk l nl nm">npm run dev</span></pre><p id="b4be" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">然后，您应该能够看到类似这样的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/13f0a37f68d617ce5b3542749977c2eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h1w7va-qj3hZ2CzH9GKVUg.png"/></div></div></figure><h1 id="f39a" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤3.5:检查路径</h1><p id="4298" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">此应用程序中提供了以下路径:</p><p id="3503" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated"><code class="fe np nq nr nf b">/ (index)</code>:向数据库发送数据的主窗体。如果用户未登录，重定向至<code class="fe np nq nr nf b">/signup</code>。</p><p id="3cf3" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated"><code class="fe np nq nr nf b">/signup</code>、<code class="fe np nq nr nf b">/signin:</code>报名和签到表格。如果用户已登录，则重定向到索引。</p><p id="05a2" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated"><code class="fe np nq nr nf b">/logout</code>:注销用户。</p><p id="3e98" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">现在，您应该能够使用这些路径注册、登录和注销。</p><h1 id="1e3e" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤4:在Supabase中创建新表</h1><p id="5b95" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本例中，我们将创建一个简单的职位发布web应用程序。</p><p id="02bd" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">因此，我们将创建一个名为<code class="fe np nq nr nf b">jobs</code>的表。</p><p id="8f3e" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">转到您的项目并单击创建新的<code class="fe np nq nr nf b">table</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/3871338c4fc0035e825c6211c6a48ae5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MUm7fF9uurk-1MKfsnEZ5g.png"/></div></div></figure><p id="4d58" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">将其命名为<code class="fe np nq nr nf b">jobs</code>，启用行级安全性，并添加以下字段:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/5ef80c9670f21b4df8a1228ffdd479b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6lTgdvSGzcDncv7rySMi5Q.png"/></div></div></figure><p id="d025" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated"><code class="fe np nq nr nf b">created_by</code>应该是<code class="fe np nq nr nf b">auth.users</code>表的外键。</p><p id="c0c9" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">如果这是一个真正的应用程序，它可能需要更多的列，但让我们保持简单。</p><p id="34fa" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">注意我们有<code class="fe np nq nr nf b">is_public column</code>，默认情况下它被设置为false。</p><p id="5bc1" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">这里的假设是，当用户在网站上发布一个新的招聘信息时，我们不想让它自动出现在网站上。我们希望有一些批准过程，以便网站管理员可以决定哪些职位发布是合法的，足以显示在网站上。</p><h1 id="cdef" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">第五步:提交职位发布表！</h1><p id="d716" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">转到根路径，并尝试提交表单！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/e8030ef8e71128d7bd3976755fdbe102.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gQd_YEHmm98c8tFR51YQnw.png"/></div></div></figure><p id="f341" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">应该管用的！你可以在Supabase的仪表盘上核实一下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/450ee98d4d2f5c56676f95e7acd7d984.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I1bK8Ns9YToJ3GG0hBgVlg.png"/></div></div></figure><p id="2033" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">那是怎么发生的？</p><h1 id="f68a" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤6:了解前端</h1><p id="f277" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">进入<code class="fe np nq nr nf b">src/pages/index.tsx</code>，你会看到这个处理表单提交的功能:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="6161" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">重要的是，我们在请求头中发送Supabase的访问令牌/ JWT。</p><p id="f66b" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">这是这一部分:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="be29" class="mn la it nf b gy nj nk l nl nm">headers: {<br/>  Authentication: session.access_token,<br/>},</span></pre><p id="a7d4" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">简而言之，JWT是验证用户是否登录的密钥。</p><p id="8bdc" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">通过将它发送到我们API路径上的后端代码，我们可以发送用户已登录的后端证明。</p><h1 id="3186" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">步骤7:了解后端</h1><p id="134c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">转到<code class="fe np nq nr nf b">src/pages/api/submit_job_posting.js</code>。让我们试着一节一节地理解这个文件。</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="168e" class="mn la it nf b gy nj nk l nl nm">const supabase = createClient(supabaseUrl, supabaseAnonKey);<br/>const supabaseSecret = createClient(supabaseUrl, supabaseServiceKey);</span></pre><p id="fac4" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">^These顶部的两行以两种不同的方式创造客户。</p><p id="660a" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">第一个是与前端相同类型的客户端——公开使用它是安全的:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="51cf" class="mn la it nf b gy nj nk l nl nm">const supabase = createClient(supabaseUrl, supabaseAnonKey);</span></pre><p id="9c5d" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">第二个使用Supabase的秘密服务密钥。它对您的数据具有管理员级别的访问权限:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="6753" class="mn la it nf b gy nj nk l nl nm">const supabaseSecret = createClient(supabaseUrl, supabaseServiceKey);</span></pre><p id="6993" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">然后:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="33c3" class="mn la it nf b gy nj nk l nl nm">const input_data = JSON.parse(req.body);<br/>const jwt = req.headers.authentication;</span></pre><p id="1655" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">^these两行解析前端发送的数据，然后从报头中检索JWT。</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="b3ff" class="mn la it nf b gy nj nk l nl nm">const { data: user, userError } = await supabase.auth.api.getUser(jwt);</span><span id="de3d" class="mn la it nf b gy nn nk l nl nm">const id = user.identities[0][‘id’];</span></pre><p id="43ef" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">^Then，这两行检索登录的用户，我们得到他们的ID。</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="da44" class="mn la it nf b gy nj nk l nl nm">const { data, error } = await supabaseSecret.from(‘jobs’).insert([input_data]);</span></pre><p id="4ebc" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">^Finally，这一行使用管理员级别的访问将数据插入到我们的表中。</p><h1 id="6422" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">为什么我们需要管理员级别的访问权限？</h1><p id="1ffe" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">另一种可能的方法是—我们可以使用行级安全性直接从前端插入数据。然而，这样一来，每个用户都可以手动将<code class="fe np nq nr nf b">is_public</code>设置为true，这不是我们想要的。</p><p id="55d2" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">为了避免这种情况，我们需要使用管理员级别的访问权限将其设置为false，从使用我们的后端代码开始。</p><h1 id="5080" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">通过实际例子了解更多信息</h1><p id="7265" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">感谢您阅读本文！</p><p id="cba5" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">如果你想了解更多关于如何在现实应用中使用这种特殊模式的信息，请随意查看我的开源项目中使用的<a class="ae ky" href="https://github.com/ykdojo/defaang" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>