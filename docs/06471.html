<html>
<head>
<title>Creating Google Cloud Functions With Kotlin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Kotlin创建谷歌云功能</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/creating-google-cloud-functions-with-kotlin-c9fd552d6b20?source=collection_archive---------6-----------------------#2020-10-05">https://betterprogramming.pub/creating-google-cloud-functions-with-kotlin-c9fd552d6b20?source=collection_archive---------6-----------------------#2020-10-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7b06" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">构建一个Kotlin HTTP函数，并将其部署到GCP</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a1c33092889314223afb0f15c77f1b3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bnpoEyFgjwqPj90O"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@pjrvs?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> p j </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄。</p></figure><p id="69ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2020年5月，谷歌宣布Java 11即将到来<a class="ae ky" href="https://cloud.google.com/blog/products/application-development/introducing-java-11-on-google-cloud-functions" rel="noopener ugc nofollow" target="_blank">谷歌云功能</a>。很自然，我的第一个想法是“太好了，但是我能用其他基于JVM的语言编写函数吗，比如Kotlin？”</p><p id="8cbd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">谢天谢地，没有这样的限制。事实上，您可以用自己选择的任何JVM语言编写函数。</p><p id="c03e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">这个例子的源代码可以在GitHub上找到:</em></p><div class="lw lx gp gr ly lz"><a href="https://github.com/mwhyte-dev/kotlin-google-cloud-function" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd iu gy z fp me fr fs mf fu fw is bi translated">mwh yte-dev/kot Lin-Google-cloud-function</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">grad Lew run function-prun function . target = com . code neural . function . app-prun function . port = 8080g cloud配置集…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mi l"><div class="mj l mk ml mm mi mn ks lz"/></div></div></a></div></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="fb34" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">先决条件</h1><p id="9eed" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">这个例子需要一些东西:</p><ul class=""><li id="4e55" class="ns nt it lb b lc ld lf lg li nu lm nv lq nw lu nx ny nz oa bi translated">Java 11</li><li id="c042" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated">格拉德勒</li><li id="23ca" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated">访问GCP并创建一个示例<a class="ae ky" href="https://cloud.google.com/resource-manager/docs/creating-managing-projects" rel="noopener ugc nofollow" target="_blank">项目</a></li><li id="c686" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated">gcloud <a class="ae ky" href="https://cloud.google.com/sdk/#Quick_Start" rel="noopener ugc nofollow" target="_blank">已安装</a>并通过认证</li><li id="b76b" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated">克隆并导入到您选择的IDE中的源代码</li></ul></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="06ce" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">主要功能</h1><p id="590a" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">主函数很简单，可以让我们开始使用——一个基本的HTTP端点，当被触发时，它将返回字符串<code class="fe og oh oi oj b">“FUNCTION COMPLETE”</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="2798" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个类从<a class="ae ky" href="https://cloud.google.com/functions/docs/functions-framework" rel="noopener ugc nofollow" target="_blank">函数-框架</a>库中扩展了<code class="fe og oh oi oj b">HttpFunction</code>，<code class="fe og oh oi oj b">service</code>函数以一个<code class="fe og oh oi oj b">HttpRequest</code>和一个<code class="fe og oh oi oj b">HttpResponse</code>对象作为参数。</p><p id="58a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于非HTTP方式<a class="ae ky" href="https://cloud.google.com/functions/docs/calling" rel="noopener ugc nofollow" target="_blank">触发云函数</a>，可以使用<code class="fe og oh oi oj b">RawBackgroundFunction</code>或类型化变量。</p><p id="c4cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如:</p><pre class="kj kk kl km gt om oj on oo aw op bi"><span id="ad7e" class="oq mw it oj b gy or os l ot ou">BackgroundFunction&lt;PubSubMessage&gt;</span></pre><p id="fc01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">触发功能的一些其他选项包括云发布/订阅、云存储、云Firestore和各种基于Firebase的触发器。</p><p id="ca6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在<a class="ae ky" href="https://github.com/GoogleCloudPlatform/functions-framework-java" rel="noopener ugc nofollow" target="_blank">functions-framework-Java</a>readme中找到其他触发机制的例子。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="721e" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">Gradle构建文件</h1><p id="5a60" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">对于这个例子，我们使用<a class="ae ky" href="https://docs.gradle.org/current/userguide/kotlin_dsl.html" rel="noopener ugc nofollow" target="_blank"> Gradle的Kotlin DSL </a>来配置我们的项目。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><h2 id="87de" class="oq mw it bd mx ov ow dn nb ox oy dp nf li oz pa nh lm pb pc nj lq pd pe nl pf bi translated">属国</h2><p id="e5c5" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">有几个关键的依赖因素。</p><ul class=""><li id="7645" class="ns nt it lb b lc ld lf lg li nu lm nv lq nw lu nx ny nz oa bi translated"><a class="ae ky" href="https://github.com/GoogleCloudPlatform/functions-framework-java" rel="noopener ugc nofollow" target="_blank"> Functions-framework-api </a>允许我们编写在许多不同环境下运行的轻量级函数，包括Google Cloud Functions和cloud-run。</li><li id="b62c" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated">Java-function-invoker使我们能够在本地运行函数进行测试。</li></ul><h2 id="11c4" class="oq mw it bd mx ov ow dn nb ox oy dp nf li oz pa nh lm pb pc nj lq pd pe nl pf bi translated">运行功能任务</h2><p id="af20" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">Gradle构建文件中的<code class="fe og oh oi oj b">runFunction</code>任务触发了java-function-invoker，它封装了函数并使用jetty web服务器提供服务。</p><p id="36a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在本地运行该函数，使用Gradle包装器调用<code class="fe og oh oi oj b">runFunction</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(为了可读性，日志记录被缩短)</p></figure><p id="c6e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，您可以覆盖一些参数:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">(为了可读性，日志记录被缩短)</p></figure><h2 id="d12b" class="oq mw it bd mx ov ow dn nb ox oy dp nf li oz pa nh lm pb pc nj lq pd pe nl pf bi translated">buildFunction任务</h2><p id="9f6f" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">Gradle构建文件中的<code class="fe og oh oi oj b">buildFunction</code>任务与<a class="ae ky" href="https://github.com/johnrengelman/shadow" rel="noopener ugc nofollow" target="_blank"> Gradle Shadow </a>插件一起创建一个胖jar，并将其复制到构建/部署目录，准备上传到GCP云存储。</p><p id="19d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要执行此操作，请使用Gradle包装器:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="3f01" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">使用gcloud部署</h1><p id="9434" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">因此，您已经在本地测试了您的功能，构建了它，现在是时候部署了。使用<a class="ae ky" href="https://cloud.google.com/sdk/docs/downloads-interactive" rel="noopener ugc nofollow" target="_blank"> gcloud命令行实用程序</a>可以轻松实现部署。</p><p id="5e6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，确保您正在部署您选择的GCP项目:</p><pre class="kj kk kl km gt om oj on oo aw op bi"><span id="47a0" class="oq mw it oj b gy or os l ot ou">gcloud config get-value project my-functions-project</span></pre><p id="a9ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后选择您希望部署到的地区:</p><pre class="kj kk kl km gt om oj on oo aw op bi"><span id="7e2b" class="oq mw it oj b gy or os l ot ou">gcloud config set functions/region europe-west1</span></pre><p id="241a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，部署功能:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="80d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:<code class="fe og oh oi oj b">entry-point</code>参数是函数的全限定类名，来源是我们fat jar的位置。</p><p id="047d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您打开GCP控制台并导航至云功能，您将看到该功能:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/af39f3e64fa2fea23bad9620d8fd63c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ClItN8JaaFNioezT.png"/></div></div></figure><p id="a512" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从这里，您可以打开它并查看各种信息，包括触发器。或者，您可以从gcloud运行一个<code class="fe og oh oi oj b">describe</code>:</p><pre class="kj kk kl km gt om oj on oo aw op bi"><span id="13c9" class="oq mw it oj b gy or os l ot ou">gcloud functions describe my-test-function</span></pre><p id="2e31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击触发URL，您将看到函数返回预期的响应:</p><pre class="kj kk kl km gt om oj on oo aw op bi"><span id="492f" class="oq mw it oj b gy or os l ot ou">❯ curl https://europe-west1-slice-poc.cloudfunctions.net/my-test-function <br/>FUNCTION COMPLETE%</span></pre></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><p id="9f08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不是中等会员？支持我成为其中一员:</p><div class="lw lx gp gr ly lz"><a href="https://mwhyte.dev/membership" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd iu gy z fp me fr fs mf fu fw is bi translated">加入媒体与我的推荐链接-迈克尔威特</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">mwhyte.dev</p></div></div><div class="mi l"><div class="ph l mk ml mm mi mn ks lz"/></div></div></a></div></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="b194" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">参考</h1><p id="69c7" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">我们已经看到将Kotlin函数部署到GCP是多么容易。为了进一步探索这个主题，我推荐以下文档:</p><div class="lw lx gp gr ly lz"><a href="https://github.com/mwhyte-dev/kotlin-google-cloud-function" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd iu gy z fp me fr fs mf fu fw is bi translated">mwh yte-dev/kot Lin-Google-cloud-function</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">grad Lew run function-prun function . target = dev . mwh yte . function . app-prun function . port = 8080g cloud配置集…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mi l"><div class="pi l mk ml mm mi mn ks lz"/></div></div></a></div><div class="lw lx gp gr ly lz"><a href="https://cloud.google.com/functions/docs" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd iu gy z fp me fr fs mf fu fw is bi translated">云函数文档|云函数文档</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">亲自尝试云功能创建一个帐户来评估我们的产品在真实场景中的表现。新…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">cloud.google.com</p></div></div><div class="mi l"><div class="pj l mk ml mm mi mn ks lz"/></div></div></a></div><div class="lw lx gp gr ly lz"><a href="https://github.com/GoogleCloudPlatform/functions-framework-java" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd iu gy z fp me fr fs mf fu fw is bi translated">Google cloud platform/functions-framework-Java</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">一个用于编写可移植Java函数的开源FaaS(函数即服务)框架</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mi l"><div class="pk l mk ml mm mi mn ks lz"/></div></div></a></div><div class="lw lx gp gr ly lz"><a href="https://github.com/GoogleCloudPlatform/functions-framework-java/issues/35" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd iu gy z fp me fr fs mf fu fw is bi translated">使用Gradle &amp; Kotlin (build.gradle.kts)运行函数第35期…</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">谢谢你把这些放在一起！我试图让本地调用者在我的本地机器上工作，这是设置…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mi l"><div class="pl l mk ml mm mi mn ks lz"/></div></div></a></div></div></div>    
</body>
</html>