# 云架构

> 原文：<https://betterprogramming.pub/architecting-for-the-cloud-ad3c4505e053>

## 公共云应用设计入门

![](img/1bb7ffb30d775e6c3202ab9c9d2f1552.png)

SpaceX 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的

上图可能是火箭科学，但是改变你为公共云开发程序的方式不是！

有许多方法可以成功地编写在 Microsoft Azure、Amazon Web Services、Google Cloud Platform 或 IBM Cloud 中运行的代码。我在这里不是为了宣传一个平台优于另一个平台，所以请不要问哪个更好。

在这篇文章中，我将提到垂直和水平缩放。如果你不知道，这里有一个快速的定义。

*   垂直扩展—向服务器添加硬件资源(CPU、RAM、磁盘空间)以处理更多请求。
*   水平扩展—添加负载平衡的服务器实例来处理更多请求。

如果您不熟悉各种 x-as-a-Service 的定义，这里有一篇整洁的文章使用 pizza 来描述它们是如何工作的。

[](https://medium.com/@pkerrison/pizza-as-a-service-2-0-5085cd4c365e) [## 披萨即服务 2.0

### 最近，我试图描述可用于现代 IT 部署的各种类型的云服务。像许多人一样，我…

medium.com](https://medium.com/@pkerrison/pizza-as-a-service-2-0-5085cd4c365e) 

如果这些定义现在对你来说没有太大意义，继续读下去——我会尽我所能来澄清它们。

# 微型整体服务与微型服务

在编写任何代码之前，你有一个预先的问题要问你自己或你的团队。您是想创建一个整体风格的应用程序、一个微服务，还是一组微服务，它们都执行完整服务的一小部分？

理解您想要使用哪一个取决于您编写微服务(或单片)的舒适程度或者您想要如何部署您的代码。(例如，虚拟机、容器映像、无服务器)

我们来比较一下各自的利弊。

## 虚拟机(又称 IaaS)

✔︎非常适合单片应用。当你必须跟踪应用程序的状态时，✔︎很容易使用。
✔︎完全控制服务器的构建方式(用户、组、其他应用程序)。

*   垂直扩展比水平扩展更容易，因为它需要设置负载平衡器。

✘还需要更多的工作来建立。
✘你负责系统更新。
✘便携性较差，需要更多时间才能转移到另一台主机上。

## 集装箱(又名 CaaS)

✔︎适合单片和微服务应用。
✔︎易于跨环境部署。
✔︎如果服务终止于无效状态，重启容器会将应用程序重置为初始状态。
✔︎需要适度的工作来设置，大部分是用脚本来完成的。
✔︎非常便携的代码，很容易从一个地方转移到另一个地方。

*   水平缩放比垂直缩放更容易。默认情况下，几乎所有的容器部署都在负载均衡器之后。
*   被当作牛而不像宠物，意味着你不应该关心寿命，只是应用程序的目的。

因为[这个可怕的漏洞](https://duo.com/decipher/docker-bug-allows-root-access-to-host-file-system)，✘容器要求你用标准用户来设置它们，(也就是[无根容器](https://rootlesscontaine.rs/))。
✘容器需要一个单独的数据存储来进行持久存储。维护者✘管理镜像更新，除非你复制镜像。

## 无服务器(又名 FaaS)

✔适合微服务应用。
✔没有服务器或软件维护。
✔易于跨环境部署
✔应用程序只有在被另一个服务调用时才运行。

*   仅水平缩放，每次并行运行时缩放。

✘你不应该使用长时间运行的函数。
✘ It 需要独立的数据存储。
✘ It 需要对代码进行中度到高度的优化，以保持成本低廉。

虽然还有很多其他因素需要考虑，但这些是你最常问自己的问题。

![](img/eccd7fd5d379bf7d18c07b110ae01bfa.png)

杰夫·哈迪在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

# 发展环境

无论您做出什么决定，您都需要确保您的开发环境以这样一种方式配置，即它以各种可能的方式反映生产*除了*数据。

最好的 IDE 应该是你最熟悉的 IDE。虽然我写了很多 Python，并且喜欢用 PyCharm 写，但是我的邻居更喜欢 Visual Studio 代码。在我楼上，开发人员倾向于使用 Eclipse for Java，我的另一个邻居更喜欢 IntelliJ IDEA，在楼下，他们使用 VS 代码。

## 五金器具

因为硬件可能很贵，所以最好将所有性能投入生产环境，而不是测试环境。在相同的硬件上测试相同数量的数据，同时模拟相同数量的每秒请求是理想的——这是完全不切实际的。

相反，保持测试服务器的低功耗。为什么？如果它在不好的硬件上运行良好，那么它在合适的硬件上会运行得很好。

## 账户隔离

说到差异，不要在不同的环境之间共享帐户和密码。您的服务的用户名和密码在开发、集成、QA、UAT 和生产中应该是不同的。确保帐户不同时代码相同的最佳方法是使用环境变量来存储这些值。

## 数据隔离

如果您的测试区域中有生产数据，那么您就有严重的问题，应该立即向您的安全团队提出。测试环境中的生产数据是一家公司面临诉讼的捷径。

## 软件

如果您使用的是基于 Red Hat 的 Linux 发行版，那么您的开发环境应该是相同的 CentOS。如果是 Debian，你应该使用基于 Debian 的发行版，最好是一样的。Windows 和 macOS 也是如此。您的操作系统和软件版本也应该在不同的环境中匹配。你的代码应该是独立于操作系统/软件的，但有时这是不可能的。

当我们编写容器时，我们在使用相同操作系统和版本的服务器或容器上执行开发。我们在一个容器中执行所有的单元测试，然后将我们的代码部署到一个映像中，该映像可以在不同的环境之间重用。唯一改变的是环境变量。

![](img/f4b3323af18a00566b521e548d85f368.png)

[绿色变色龙](https://unsplash.com/@craftedbygc?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

# 编写代码

当您开始分析时，您应该记住可能有多个代码实例同时运行。这意味着您需要考虑共享数据存储或数据库上的竞争条件。

有一些方法可以解决这个问题，比如使用 Celery 或 RabbitMQ 这样的消息队列系统。在写入数据库之前，您还可以使用内存中的数据存储(如 Redis)来保存最近使用的数据的最新版本。

您应该编写代码，就好像任何资源都可能在任何时候发生变化。通过使用 HTTPS 请求和 API 版本控制，减少对其他项目或外部资源的依赖。创建访问每个资源时使用的任何外部源环境变量的 URL。这样，您可以在程序运行时更改环境变量，新的端点将会得到反映，而无需重新编译您的代码。

简而言之，让你的代码如此独立，以至于当你的环境发生变化时，即使它是一种解释型语言，你也不必重新编译它。最好的理解是，任何语言都应该能够与任何语言兼容。

如果你正在写微服务，你应该保持你的程序足够小，如果它只被使用几个月然后被删除，你也不会有问题。您应该能够轻松地删除这些代码，甚至在其他事情发生变化时重新编写代码。

就我个人而言，我可以删除总共少于 500 行的程序。如果我超越了这一点，我将询问其他人是否可以重构他们如何与我的服务交互。这完全是一种看法——有些人说少于 100 行是理想的。

如果你决定不使用服务器，确保你的算法是快速的，因为你是按函数完成任务的时间计费的。在部署代码之前对其进行优化。如果你有一个无限循环，你会有一个相当大的账单。

当您使用云时，您希望将您的整体应用程序分解成较小的部分，以便在不使用时可以关闭。通过依赖更少或单个 CPU 进行所有处理，节省了资金并减少了瓶颈。用 10，000 个水平扩展的容器(pod)处理 100 万个并发请求要比用两台服务器处理这些请求容易得多，每台服务器有 128 个 CPU。它也便宜得多，因为当流量较低时，你可能只需要支付 100 个 pod。

*保持小规模，保持灵活，保持快速。*

查看 12factor.net[的](https://12factor.net/)以获得更深入的解释。

![](img/8eebbbd824123594eef56280471013a6.png)

照片由 [Marina Khrapova](https://unsplash.com/@mimiori?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

# 代码库

你所有的代码都应该被版本控制。注意我说的是“代码”编译后的程序不应该和它们的源代码一起存在。下一节将详细介绍编译后的代码。

你应该努力只拥有一个提供者(GitHub，GitLab，BitBucket 等等。)来保存你所有的源文件。

什么进入源代码控制:

*   源代码
*   源代码测试
*   单元测试数据
*   配置文件
*   许可证协议
*   降价文件(README.md、contributing.md 等。)
*   生成文件

什么不进入源代码控制:

*   用户名
*   密码
*   秘密
*   键盘标签
*   群组名称
*   SSH 私钥

那么，如何将测试所需的东西放入源代码中呢？

*   您可以创建一个包含所有测试秘密的容器映像。
*   您可以使用`[sed](https://unix.stackexchange.com/a/159369)`或`[Powershell](https://stackoverflow.com/a/17144445)`来替换测试运行文件中的文本。
*   在管道中，您可以将机密作为环境变量注入。

![](img/8b56123c1f20f69452a58c67bce806b2.png)

Iker Urteaga 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

# 管道

管道对于快速准确地部署新代码至关重要，可以节省开发人员、测试人员或管理员的时间。

作为开发人员，他们可以帮助你节省测试代码的时间。您将代码推送到 repo，管道接管，运行您所有的单元测试，可能还会使用 SonarQube 做一些静态分析。您的管道应该是指挥者，根据需要启动任务，也许是并行的。如果您的代码需要编译，管道将根据需要构建您的代码，并将结果构件部署到部署服务器。

我通常在特性分支上进行管道单元测试，然后在合并到主分支时执行静态分析。如果一切顺利，我就通过从主分支合并到生产分支来部署到生产分支。

最终目标是让一个管道接管整个流程。也就是说——我在我的机器上运行本地单元测试，然后将我的代码推送到 repo。当代码上传后，管道将执行测试覆盖，然后将代码合并到主分支，并开始部署到集成测试服务器。

如果合并成功，管道将运行静态分析，包括对包和容器映像的漏洞扫描。如果所有这些关卡都通过了，代码将被提交到 QA，在 QA 中，将会进行一组更高级的测试，试图破坏应用程序，以及负载测试。

根据应用程序的关键程度，我可能会将它手动推向生产，或者进行一些用户验收测试，要求最终用户进行手动测试。

最后，代码将被合并到生产分支，生产分支将代码部署到生产服务器。

是的，初始设置是痛苦的。但是如果你花一周的时间来完善这个过程，你会节省自己的时间，因为你不必到处设置环境，手动测试一切。

从管理员的角度来看，所有这些都发生在后台。随着代码被测试的次数和方式越来越多，这意味着通过测试的错误越来越少。

另外，您甚至可以使用一些基础设施作为代码语言，比如 Terraform，来为您在管道中构建环境。

![](img/9f0e8b8087dff1c22e2c5f83042d8271.png)

凯利·西克玛在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

# 记录

日志记录至关重要，尤其是在涉及管道的时候。如果管道由于任何原因失败，您需要知道失败的原因、失败的位置、失败的原因，以及如何修复它的合理提示。

启动项目后，您应该导入您使用的任何日志库，并记录所有内容。在我的 Flask 项目中，我尝试立即设置日志记录，并且总是在服务器启动时记录日志。如果有一个无效的配置，我会知道，即使该进程作为不同的用户运行。

写日志时，我使用接近如下的格式:

```
[Tue Jan 28 22:14:42 2020] INFO main:do_stuff : Server Started
```

如果用户在一天中的某个时候遇到问题，我可以使用如下命令来查找我想要的内容:

```
$ sudo cat /var/log/messages | grep ERROR | grep "Jan 28"
```

虽然这可能不是最简洁的写作方式，但它使寻找问题变得更容易。

另一种使您的工作更容易的方法是记录您的服务所来自的 IP 地址请求。当用户遇到问题时，您查找他们的 IP 地址，命令会发生变化:

```
# cat /var/log/messages | grep ERROR | grep "clientip=10.0.1.105"
```

现在，我只看到来自该用户的请求，以及导致错误的请求。在许多请求都是 HTTP 请求的情况下，这种可见性是至关重要的。

![](img/768c1b7765b408871f1f93c219627d58.png)

克里斯·帕纳斯在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

# 安全性

如果在互联网上，它需要是安全的。云服务根据您的产品提供数据中心和服务器安全性，但它们不能保护您的应用程序。

当您编写应用程序时，应该尽快开发安全性。这意味着您需要有效、可信的证书，一些适当的身份验证和授权过程，以及一种审核成功和失败的方法。

你不应该在云应用中使用不安全的通信方法。对于大多数服务来说，这就像在应用程序前面设置一个反向代理一样简单。在 OpenShift 或 Kubernetes 中，这通常由内置的负载平衡器自动处理。在其他服务器上，您可能需要使用 Apache、NGINX 或 IIS 作为反向代理。利用 LetsEncrypt 等服务获得免费的 SSL 证书，您可以在测试中使用，或者用于生产应用程序。(不要忘记实现自动更新证书的功能)。

您应该始终限制对您的应用程序的访问。如果应用程序仅供内部使用，您应该设置一个网关，拒绝来自组织外部 IP 地址之外的任何请求，或者使用 VPN。你的应用程序应该总是强制认证，使用用户名和密码或者 [OAuth](https://oauth.net/) 。应该通过检查验证用户名和密码或用户的组成员身份来提供授权。使用 Fail2Ban 之类的软件让可疑用户远离。

审计是至关重要的，它与上面的日志技术密切相关。记录所采取的操作、经过身份验证的用户、发起请求的 IP 地址以及审计员可能询问的任何其他内容，并将其放在以后可以轻松检索的地方。

![](img/1046aeabdbf52730b3149ec81afa5c79.png)

照片由[张秀坤镰刀](https://unsplash.com/@drscythe?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

# 自动化

你应该做的最后一件事是找到尽可能多的任务自动化的方法。即使像 OpenShift 或 Kubernetes 这样的 PaaS 可以自动化许多事情，例如负载平衡和 pod 管理，但您最终还是要负责将代码/容器放到 PaaS 中。

但是，如果我们缩小一分钟，是什么创建了虚拟机？什么配置虚拟机及其运行的主机？

如果您有物理服务器，您或您的基础设施团队负责安装和打开服务器，甚至可能设置对这些服务器的 ssh 访问。

为了向您的服务器部署新的虚拟机，您可以使用诸如 Terraform 或 CloudFormation 之类的工具来创建一个虚拟机群，以满足您的需求。使用 Ansible 或 Chef 等配置工具来保护服务器，并确保所有的 web、数据库或应用程序服务器都以相同的方式设置。

通过自动化日常任务，这种自动化可以为您节省几天甚至几周的时间。第一条规则是尽可能的懒惰——不打字你能做多少事情？

![](img/592670bcdc4c5fa37bbfa3316addbfea.png)

照片由[克里斯蒂娜面粉](https://unsplash.com/@tinaflour?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 拍摄

# 秘密

虽然这可能会受到安全保护，但它本身就非常重要。如何在不将用户名和密码或 API 令牌存储在代码中的情况下对服务器进行身份验证？

最基本的方法是将您的秘密存储在一个加密文件中，只有运行该应用程序的服务帐户才可读。这一点也不安全，但总比不加密的文件好。只有在没有其他选择的情况下才使用此选项。

您总是可以将秘密放在环境变量中，但是如果您在 VM 中运行，您不希望每个人都可以使用它们。如果是这种情况，那么您希望在将它们存储为环境变量时对它们进行加密。

这是容器真正闪光的地方。当您运行容器时，您在 shell 会话中运行您的应用程序。关于 shell 会话的伟大之处在于，只要您没有将环境变量记录或打印到控制台，它们就被认为是安全的。如果有人闯入你的容器，他们将在不同的会话中结束，并且不能看到那些秘密。

可能最好的选择是使用一个秘密管理器，比如 Vault，来处理所有的秘密。当您有数百甚至数千个 API 时，您最不想做的事情就是在每次它们改变时手动将秘密注入到您的应用程序中。你难道不想换一个地方，然后把它处理掉吗？

为了在无需重新加载应用程序的情况下更新密码，您不能让您的程序在应用程序启动时读入密码。相反，你需要在每次需要的时候把秘密读进去。如果您使用 API 令牌来访问资源，那么您应该在每次需要身份验证时从 secrets manager 或环境中读取它。

![](img/60b8ea16040e4955857e26f2ece1021e.png)

格伦·卡斯滕斯-彼得斯在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

# 测试

说到测试，你不仅需要对你的代码进行单元测试，还需要检查是否缺少外部资源。

快速失败，经常失败，但是要用正确的方法去做！

你的目标应该是让你的代码在开发过程中有所突破，并在突破时感到兴奋。您在开发过程中打破它并解决问题的次数越多，它在生产中被打破的可能性就越小。

## 快速失败

当你失败时，你应该在尽可能接近错误的地方失败，并给出一些出错的提示。这意味着，如果您正在进行五次函数调用，无法正常响应错误消息，那么您需要冒泡异常，直到您能够正常响应。

## 经常失败

你应该想尽一切办法破解你的代码。即使前端服务正在调用您的后端服务，您也需要测试奇怪的请求，并尽可能成功、优雅地处理它们。

所有的大玩家，如谷歌、网飞、微软和 Instagram，都在生产中使用诸如混沌猴(Chaos Monkey)之类的工具测试他们的代码，这些工具旨在模拟像网络故障这样影响深远的问题。您的代码应该具有很强的弹性，这样您就可以在关闭部分服务的同时仍然能够处理请求。

![](img/3b67594f41809639d5c10a1d5a5b8222.png)

由[卢克·切瑟](https://unsplash.com/@lukechesser?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 拍摄的照片

# 采用现场可靠性工程原则

站点可靠性工程(Site-Reliability Engineering)是一套指导方针，它将使您的开发和运营工作更加舒适。它与变更管理、风险、服务水平目标(SLO)和监控有更多的关系，但是它教导开发人员要警惕明显的错误。这有助于业务部门在监测工作中更加警惕。这有助于管理可能很快发生的混乱。

这里面涉及的内容太多了，你可以把它写进一本书里——谷歌就是这么做的。我将提供一个链接，链接到免费在线版本的[书](https://landing.google.com/sre)和[练习册](https://landing.google.com/sre/workbook/toc/)，这样当你准备好的时候就可以浏览它们。

大多数时候，你会有一个 SRE 人或一个 SRE 团队，但是人们越了解 SRE，他们的工作效率就越高。我强烈推荐阅读或至少浏览这本书。

![](img/3dbee9412caee96539c794b1f9b053aa.png)

图片由 [NESA 制作](https://unsplash.com/@nesabymakers?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

# 收养 DevOps

DevOps 不是你购买、安装然后打开的东西。DevOps 是一种心态——也可以说是一种文化。

DevOps 有两个方面，它们都在名称中:

*   开发人员在那里计划、编码、构建和测试。
*   运营团队在那里*测试*，发布、部署、操作、监控现有代码，以及*计划*新的变更。

您是否注意到开发人员和运营人员在计划和测试方面一起工作？

运营团队与企业沟通——他们知道需求是什么，以及如何最好地传达给开发人员。有好计划的开发人员会开发出好的程序。

开发人员为被设计为多次使用的代码创建测试，但是他们没有想到用户试图做的所有愚蠢的事情。这时运营部来帮忙了。运营团队知道用户一直试图做的所有疯狂的事情——他们应该要求开发人员为这些情况创建测试。

DevOps 是关于团队高效合作的。团队一直在一起工作，但是你的企业文化是鼓励还是增加了工作的难度？

你听说过敏捷这个术语吗？敏捷宣言怎么样？这就是我们今天所知道的 DevOps 的最初计划。问题是，企业认为这意味着我们需要引入项目经理来处理团队之间的沟通。

我想让你读一下微软关于什么是 DevOps 的页面:

[](https://azure.microsoft.com/en-us/overview/what-is-devops/) [## DevOps 是什么？DevOps 解释|微软 Azure

### 持续集成是一种软件开发实践，在这种实践中，开发人员频繁地将代码变更合并到软件开发过程中

azure.microsoft.com](https://azure.microsoft.com/en-us/overview/what-is-devops/) 

现在我想让你读一下敏捷宣言和敏捷宣言的原则:

 [## 敏捷软件开发宣言

### 我们通过自己动手和帮助他人来发现开发软件的更好方法。这些是我们的价值观和…

agilemanifesto.org](https://agilemanifesto.org/)  [## 敏捷宣言背后的原则

### 我们遵循这些原则:工作软件是进步的主要衡量标准。持续关注技术…

agilemanifesto.org](https://agilemanifesto.org/principles.html) 

在我看来 DevOps 只是对敏捷开发的重温！

项目经理应该是来自上层管理的商业目标的倡导者。信息应该只传递给世界各地的操作团队，以便操作和开发人员可以一起解决问题。

如果你想了解更多，我强烈建议你去看看《凤凰计划[](https://www.amazon.com/Phoenix-Project-DevOps-Helping-Business/dp/1942788290)**》这本书。*这本书有个续作叫 [*独角兽计划*](https://www.amazon.com/Unicorn-Project-Developers-Disruption-Thriving/dp/1942788762) 。*

*云架构不同于内部架构。大部分都是在开发周期中摸索，记住一切都是不稳定的，所以要防御性地编码！与团队紧密合作，采用鼓励沟通的更好的文化，只要你坚持自己的 SLO，失败是可以接受的。*