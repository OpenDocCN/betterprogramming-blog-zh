<html>
<head>
<title>How to Create A POST Request in FastAPI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在FastAPI中创建POST请求</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-create-a-post-request-in-fastapi-3dbd017dd998?source=collection_archive---------3-----------------------#2021-07-27">https://betterprogramming.pub/how-to-create-a-post-request-in-fastapi-3dbd017dd998?source=collection_archive---------3-----------------------#2021-07-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3c52" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">快速和高质量的工作</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/591ddbc2aaa6c8e4567c5ee67ac53aef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oG0_tRU0TotFvt6d"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@casparrubin?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">卡斯帕·卡米尔·鲁宾</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="82a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">互联网上有很多关于如何构建API的资源。对如此多资源的需求表明，构建一个API对我们许多人来说都很困难。但是，这并不是必须的。今天，您将学习如何使用FastAPI创建POST请求。</p><p id="1a85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">POST请求比<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-create-a-get-request-in-fastapi-ecdc794b0cf"> GET请求</a>更难理解，因为它具有创造性。</p><p id="fbfe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文将向您展示如何构建一个带有POST请求的控制器。您将学习如何用单元测试和集成测试来正确地测试它。</p><p id="5c3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，让我们戴上学习帽，开始学习吧！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f928" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建发布请求</h1><p id="4a70" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">首先，您需要准备您的Python环境。在这种情况下，您至少需要FastAPI、<code class="fe mz na nb nc b">pydantic</code>、<code class="fe mz na nb nc b">uvicorn</code>和请求库。</p><p id="d221" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nd">注意:我更喜欢使用虚拟环境来安装Python中的库。它们不会弄乱你的系统，并且很容易与Docker这样的工具结合。</em></p><p id="57c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将创建一个管理图书的API。我们将要使用的数据类型如下所示:</p><pre class="kj kk kl km gt ne nc nf ng aw nh bi"><span id="7c01" class="ni md it nc b gy nj nk l nl nm">class Book(BaseModel):<br/>    isbn: int<br/>    title: str</span></pre><p id="0629" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，你会将这些书存储在数据库中，但就像鲍勃叔叔会说的那样:数据库只是一个细节。这会让事情变得更复杂。在本文中，我想更多地强调POST请求本身。所以，现在，让我们坚持一个列表。</p><blockquote class="nn"><p id="0882" class="no np it bd nq nr ns nt nu nv nw lu dk translated">数据库只是一个细节——罗伯特·c·马丁</p></blockquote><p id="324b" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">POST请求将创建一个资源。我们从一个空的书单开始。所以，我们第一次添加一本书时，它会被添加到列表中。如果我们添加不同的书，它也会被添加到数组中。</p><p id="5042" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有一种特殊的情况，您两次添加相同的资源:</p><ul class=""><li id="d4f8" class="oc od it lb b lc ld lf lg li oe lm of lq og lu oh oi oj ok bi translated">POST请求是严格的:它要么添加资源，要么失败。每次执行POST请求时，API用户都会期望一个新创建的资源。主键通常会自动递增。所以您可以向您的数据类添加一个额外的字段ID，但不是在本例中。ISBN总是唯一的。</li><li id="381e" class="oc od it lb b lc ol lf om li on lm oo lq op lu oh oi oj ok bi translated">处理POST请求的一种可能方式是允许重复。我不认为这是个好主意。除非我们谈论的是可以接受重复的情况(例如，短信、推文)，否则最好尽早阻止不良数据。</li><li id="34e7" class="oc od it lb b lc ol lf om li on lm oo lq op lu oh oi oj ok bi translated">如果可能的话，自己生成主键。由于ISBN注册机构管理ISBN，这是不可能的。</li></ul><blockquote class="oq or os"><p id="fe1b" class="kz la nd lb b lc ld ju le lf lg jx lh ot lj lk ll ou ln lo lp ov lr ls lt lu im bi translated">您可以添加验证，用isbn注册api检查给定的ISBN是否有效。这是更熟悉请求库的一个很好的练习。</p></blockquote><p id="a495" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基于我上面的推理，显示409冲突是你能做的最好的事情。您将防止创建重复，409错误代码对于我们的API用户来说是一个合理的响应。</p><p id="2c29" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在FastAPI中，应该是这样的(取决于您的实现):</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="6ab2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们再看一遍。如果这本书已经在我们的列表中，我们抛出一个冲突错误。否则，我们会将这本书添加到收藏中。就这么简单。</p><blockquote class="oq or os"><p id="6c3e" class="kz la nd lb b lc ld ju le lf lg jx lh ot lj lk ll ou ln lo lp ov lr ls lt lu im bi translated">你可以退回你创作的书，也可以什么都不退回。这种情况下。我倾向于返回它，使这个方法更容易测试。不返回任何东西并没有错，只要和你的设计决策保持一致就好。</p></blockquote></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="56bd" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">如何编写单元测试</h1><p id="f04a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在这一节中，我们还将讨论导致上面代码的单元测试。虽然按照测试驱动的顺序编写测试感觉很自然，但是用这种方式写文章却很难。</p><p id="1332" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到目前为止，我们已经找到了一条快乐路径和一条例外路径。</p><p id="a564" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，您编写一个创建一本书的测试。它将书添加到集合中并返回它。</p><p id="57c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二，您测试当一个现有的书被添加到列表中时抛出409冲突错误。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="98b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了确保未来的修改不会破坏我们的代码，这些单元测试是必不可少的。</p><p id="baa4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，我们在测试中修补了<code class="fe mz na nb nc b">books</code>变量。这样，我们确保每个测试都从干净的数据开始。它还将测试从列表的实际内容中分离出来，这是一个实现细节。</p><p id="6b1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用一个补丁，我们可以添加一个初始状态，这对于第二个测试很方便，我们从一个现有的书开始。</p><p id="53f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，我们也使用了<code class="fe mz na nb nc b">given-when-then</code>结构。Given-when-then允许你一遍又一遍地用相同的形式清楚地定义期望。</p><h1 id="ceb4" class="mc md it bd me mf oy mh mi mj oz ml mm jz pa ka mo kc pb kd mq kf pc kg ms mt bi translated">如何编写集成测试</h1><p id="2fec" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">有时候人们只写单元测试。有时候人们只写集成或者端到端的测试。嗯，有个组合总是好的。如果您试图用单元测试涵盖所有内容，这将会有所帮助。那些是最快的。</p><p id="fdea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，编写一个好的集成测试也有很大的价值(尽管它们运行起来比较慢)。这就是为什么我在这里包括了一个。为你的应用程序的幸福之路写至少一个总是一个好主意。</p><p id="22bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下面的测试中，我们验证了API的行为。我们添加了一本书，我们期望得到200 OK的响应。我们还证明了JSON是我们希望返回的。集成测试相对容易理解。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="4333" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编写集成测试非常类似于用Postman、Swagger或Curl手动测试您的API。只有当你将所有的测试都包含在一个自动化的管道中(例如Jenkins)时，最大的好处才会出现。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6793" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="ab2f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">与其他语言相比，在FastAPI中实现POST请求可以非常快速地完成。</p><p id="e0cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦理解了POST和GET方法，就可以成功地创建和请求资源了。这些类型的请求在开发API时是必不可少的。</p><p id="d33c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您阅读这篇文章。我希望将来能看到更多用这个有用的框架构建的应用程序。一定要亲自尝试代码示例，并让我知道您的体验。</p></div></div>    
</body>
</html>