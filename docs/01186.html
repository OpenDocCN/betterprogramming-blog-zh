<html>
<head>
<title>Code Coverage Reports and Custom Configuration with Istanbul, Jest, and React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">伊斯坦布尔、Jest和React的代码覆盖报告和定制配置</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/code-coverage-reports-and-custom-configuration-with-istanbul-jest-and-react-34e44c968b7c?source=collection_archive---------3-----------------------#2019-08-21">https://betterprogramming.pub/code-coverage-reports-and-custom-configuration-with-istanbul-jest-and-react-34e44c968b7c?source=collection_archive---------3-----------------------#2019-08-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/ed3bb666468658101f706d76ac9d0203.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x_uv0-HlsrF9Hut-2figHQ.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@firmbee" rel="noopener ugc nofollow" target="_blank">威廉·艾文</a>在<a class="ae kf" href="https://unsplash.com" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="24ba" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几个月前，我遇到了独一无二的罗伯特“鲍勃叔叔”马丁(“干净的代码”、“干净的编码者”、“干净的架构”等)。人们向他提出的许多问题之一是，“我的应用程序中的哪些部分需要用单元测试来覆盖？”他的回答是，“嗯，只有你想工作的人。”</p><p id="dd51" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">反响很大吧？</p><p id="787a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我写的代码越多，我就越相信100%(或接近100%)的行覆盖率阈值不是疯狂的，而是强制性的。好的覆盖率的最大好处之一是覆盖率报告对所有文件都是绿色的。</p><p id="24e9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">看到所有的绿色让人开心，他们倾向于保持绿色<em class="le"> </em>(即<em class="le">)。</em>，添加新代码时添加新测试)。没有人想成为那种在文件变绿很长时间后又变红的人。</p><figure class="lg lh li lj gt ju gh gi paragraph-image"><div class="gh gi lf"><img src="../Images/43655f968e84d5d83a86a930306cae47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*U61tgeL90GhwJIx8R8WzJA.png"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">罗伯特·马丁和作者</p></figure><p id="29b4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所以从一开始就有代码覆盖报告和阈值是非常重要的。在本文中，我们在React应用程序上配置伊斯坦布尔，使用Jest作为测试运行程序。</p></div><div class="ab cl lk ll hx lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="im in io ip iq"><h1 id="f884" class="lr ls it bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">我们开始吧</h1><p id="dc14" class="pw-post-body-paragraph kg kh it ki b kj mp kl km kn mq kp kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">先说React app。我们将使用脸书的Create React App <a class="ae kf" href="http://www.github.com/facebook/create-react-app" rel="noopener ugc nofollow" target="_blank">模板</a>。</p><p id="b70c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Create React App不需要任何配置，只需一个命令即可创建一个非常简单的React应用程序:</p><pre class="lg lh li lj gt mu mv mw mx aw my bi"><span id="6f82" class="mz ls it mv b gy na nb l nc nd">npx create-react-app my-app-name</span></pre><p id="5e9d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在您有了React应用程序。更好的是:你在<code class="fe ne nf ng mv b">src/App.test.js</code>有一个Jest测试。</p><p id="22da" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这就是你尝试伊斯坦布尔的全部。如果您想要更多的数据，您可以添加更多的文件并为它们编写测试，或者您可以使用您现有的React项目。</p></div><div class="ab cl lk ll hx lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="im in io ip iq"><h1 id="c96f" class="lr ls it bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">建立伊斯坦布尔</h1><p id="ee07" class="pw-post-body-paragraph kg kh it ki b kj mp kl km kn mq kp kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">好消息是伊斯坦布尔是一个笑话。这意味着配置由Jest直接处理。</p><p id="f8ab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里的问题是，当您使用Create React应用程序模板创建应用程序时，默认情况下伊斯坦布尔不会运行。</p><p id="db7d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当测试脚本被执行时，有两种方式运行伊斯坦布尔和Jest。两者都很简单。</p><p id="94f9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">第一个是用一个<code class="fe ne nf ng mv b">--coverage</code>标志运行您的测试。让我们添加一个名为<code class="fe ne nf ng mv b">test:coverage</code>的新npm脚本，它将在运行测试后使用伊斯坦布尔生成覆盖报告:</p><pre class="lg lh li lj gt mu mv mw mx aw my bi"><span id="fa3b" class="mz ls it mv b gy na nb l nc nd">//package.json<br/>  {<br/>    ...<br/>    "scripts": {<br/>      ...</span><span id="d26a" class="mz ls it mv b gy nh nb l nc nd">      // test run   without coverage report      <br/>      "test": "set CI=true &amp;&amp; react-scripts test",<br/>      <br/>      // run tests in watch mode<br/>      "test:watch": "react-scripts test",  </span><span id="d0fc" class="mz ls it mv b gy nh nb l nc nd">      // test run that generates coverage reports<br/>      "test:coverage": "set CI=true <br/>                          &amp;&amp; react-scripts test --coverage"  <br/>    }<br/>  }</span></pre><p id="bc42" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是向您的应用程序介绍伊斯坦布尔的最佳方式，因为您可以控制是否根据您使用的脚本生成报告。<br/>您不希望总是创建报告的原因是性能——每次运行都生成报告可能会大大降低您的测试速度。<br/>所以当你需要一个覆盖率报告的时候，你运行<code class="fe ne nf ng mv b">npm run test:coverage</code>，但是当你不需要的时候，你使用<code class="fe ne nf ng mv b">npm run test</code>，它有更快更便宜的执行。</p><p id="4fbe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">打开伊斯坦布尔的第二种方法是使用默认为假的<code class="fe ne nf ng mv b">collectCoverage</code>属性。</p><pre class="lg lh li lj gt mu mv mw mx aw my bi"><span id="7e40" class="mz ls it mv b gy na nb l nc nd">//package.json<br/>  {<br/>    ...<br/>    "jest": {<br/>      collectCoverage: true<br/>    }<br/>  }</span></pre><p id="5fc2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这样做将使每个测试运行收集覆盖率并生成报告，这比使用<code class="fe ne nf ng mv b">--coverage</code>标志要灵活得多，并且会对性能产生很大的影响。</p><p id="55f0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我建议总是使用我们讨论的覆盖标志的第一种方式来设置伊斯坦布尔。这样，您将拥有一个完全灵活的配置，当您真正需要覆盖率报告时，它将允许您只支付收集覆盖率的开销。</p></div><div class="ab cl lk ll hx lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="im in io ip iq"><h1 id="0e9e" class="lr ls it bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">自定义覆盖配置</h1><p id="09d5" class="pw-post-body-paragraph kg kh it ki b kj mp kl km kn mq kp kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">伊斯坦布尔有许多属性，让您自定义您的覆盖报告。让我们来看看最有用或者最有趣的。</p><p id="fbc6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">属性<code class="fe ne nf ng mv b">collectCoverageFrom</code> <strong class="ki iu"> </strong>让你定义你想从哪些来源，更重要的是，不想从哪些来源收集报道。</p><p id="bf97" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你总是想排除<code class="fe ne nf ng mv b">node_modules directory</code>，一些第三方代码，测试文件等等。使用<code class="fe ne nf ng mv b">collectCoverageFrom</code>属性使配置变得非常简单。排除是用一个求反运算符完成的:<code class="fe ne nf ng mv b">“!”</code>。</p><pre class="lg lh li lj gt mu mv mw mx aw my bi"><span id="2449" class="mz ls it mv b gy na nb l nc nd">"jest": {<br/>    "collectCoverageFrom": [<br/>      "**/*.{js,jsx}",<br/>      "!**/node_modules/**",<br/>      "!**/coverage/**",<br/>      "!**/serviceWorker.js",<br/>      "!**/index.js"<br/>    ],<br/>}</span></pre><p id="4ce2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">属性<code class="fe ne nf ng mv b"><strong class="ki iu">coverageThreshold</strong></code> <strong class="ki iu"> </strong>将对覆盖率结果实施最小阈值。您可以对每个条目实施最小化伊斯坦布尔措施:分支、方法、行和语句。这里最酷的是，除了全局阈值之外，您可以为任何单独的目录甚至每个文件设置它们。</p><pre class="lg lh li lj gt mu mv mw mx aw my bi"><span id="3db0" class="mz ls it mv b gy na nb l nc nd">"jest": {<br/>    "coverageThreshold": {<br/>      "global": {  // global thresholds<br/>        "branches": 80,<br/>        "functions": 80,<br/>        "lines": 80,<br/>        "statements": 80<br/>      },<br/>      "./src/App.js": {  // file level thresholds<br/>        "lines": 100<br/>      }<br/>    }<br/>  }</span></pre><p id="d772" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">还有很多Jest属性。你真的可以深入研究，做出最适合你的项目的配置。</p></div><div class="ab cl lk ll hx lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="im in io ip iq"><h1 id="1aa6" class="lr ls it bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">结论</h1><p id="500a" class="pw-post-body-paragraph kg kh it ki b kj mp kl km kn mq kp kq kr mr kt ku kv ms kx ky kz mt lb lc ld im bi translated">从长远来看，从一开始就拥有覆盖报告和阈值会有很大的不同。它将保持你的项目干净，持久，并对错误有弹性。</p><p id="244c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">试图在项目生命周期的后期包含测试覆盖阈值、linters和其他规则几乎总是以没有人尊重的失败而告终。</p><p id="4639" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">聪明点，一开始就做。</p></div></div>    
</body>
</html>