<html>
<head>
<title>Cannot Upload Large Files to a Service Deployed in Cloud Run? Migrate to http2!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无法将大文件上传到部署在云运行中的服务？迁移到http2！</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/cannot-upload-large-files-to-a-service-deployed-in-cloud-run-migrate-to-http2-16b5f1668224?source=collection_archive---------7-----------------------#2022-10-20">https://betterprogramming.pub/cannot-upload-large-files-to-a-service-deployed-in-cloud-run-migrate-to-http2-16b5f1668224?source=collection_archive---------7-----------------------#2022-10-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="fbcb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Google Cloud Run限制文件上传/下载，但http2的文件大小没有限制</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/918f8cdb5309b5b274763a3089f1e986.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gZ72CJfmsFNcw_tNxGUJRA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@sigmund?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">西格蒙德</a>在<a class="ae kv" href="https://unsplash.com/s/photos/upload?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="72e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最近，我在使用部署在Google Cloud Run中的API端点上传大文件时遇到了麻烦。当我开始进一步调查时，令我惊讶的是，文件上传似乎仅限于32 MiB，下载也是如此。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/a80424db1798af87bc91f249567da870.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*64ZlXkI8z1URF0xkFPHGfw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">对于HTTP/1服务器，上传限制为32 Mib</p></figure><p id="337e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以解决方案似乎很明显:迁移到http2。除了绕过这个文件大小限制，使用http2协议还有另一个好处；它使信息的传递更加有效。我们将能够允许每个TCP连接建立多个资源线程(多路复用)，传输压缩数据并减少下载时间(头压缩)，可以发送关于最需要哪些资源的请求(资源优先级)，甚至可以在请求之前发送关键文件(服务器推送)。</p><p id="f5e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好吧，那我们怎么做？取决于你如何编写你的API。对我们来说，我们在Python服务中使用了<code class="fe lt lu lv lw b">uvicorn</code>。截至本文撰写之时，它还不支持http2，所以我们改用了T1。解决方案很简单，用<code class="fe lt lu lv lw b">hypercorn.run</code>替换<code class="fe lt lu lv lw b">uvicorn.run</code>，只需将几个标志切换到<code class="fe lt lu lv lw b">hypercorn</code>语法。</p><p id="75a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在docker文件中，它可能看起来像这样简单:</p><pre class="kg kh ki kj gt ly lw lz ma aw mb bi"><span id="6bef" class="mc md iq lw b gy me mf l mg mh">hypercorn gpt_backend.main:app — log-level debug — reload — bind 127.0.0.1:8091</span></pre><p id="2e15" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那么，现在我们所要做的就是在云运行中部署它，它就会工作，对吗？唉，要是生活有那么简单就好了。</p><p id="fdc7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe lt lu lv lw b">hypercorn</code>要求<code class="fe lt lu lv lw b">https</code>能够服务http2请求。否则，它将默认为http1。云运行会自动终止TLS，所以除非我们显式配置云运行来服务http2请求，<code class="fe lt lu lv lw b">hypercorn</code>将会看到没有任何安全证书的请求并服务http1。</p><p id="ad58" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们如何做到这一点？转到您的云运行服务&gt;创建和部署新版本，然后单击连接选项卡。选择复选框以启用http2连接。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/8a600790b6fc23ab6a5b58c750d64a3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*uowZYrhagVr604hfJ9Ni4g.jpeg"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在您的云运行服务上启用http2连接</p></figure><p id="e94c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，点击编辑和部署，工作就完成了？没那么快！</p><p id="578e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">云运行的默认超时时间为五分钟。这项部署的服务将上传/下载大于32 MiB的文件，但前提是必须在五分钟内完成。</p><p id="1ca9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们想上传更大的文件呢？我们将不得不增加我们的云运行服务的超时设置。</p><p id="2ea4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">转到您的云运行服务&gt;创建和部署新版本，然后单击容器选项卡。将最大文件大小的超时时间增加到3600秒，或者增加到适合您的使用情形的持续时间。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/238f2dd5e7e57f1052bdd644baa65e52.png" data-original-src="https://miro.medium.com/v2/resize:fit:982/format:webp/1*3d9GdiIJ1s2UfdNO7TXQ3w.jpeg"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">超时最长可达3600秒</p></figure><p id="ffd6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是了。现在部署，你就可以在你的云运行服务上上传/下载大文件。然而，它仍然不是完全无限的。支持的大小将取决于超时和互联网速度。不过，还是比32 MiB强多了，对吧？</p><p id="8994" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">别忘了留下评论，获取更多有用的技巧/见解！</p></div></div>    
</body>
</html>