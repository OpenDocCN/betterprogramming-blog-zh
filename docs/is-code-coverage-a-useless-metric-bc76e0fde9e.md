# 代码覆盖率是一个无用的度量吗？

> 原文：<https://betterprogramming.pub/is-code-coverage-a-useless-metric-bc76e0fde9e>

## 你应该关心你的测试覆盖率吗？有人应该吗？

![](img/927a4376680eb483946740f8f2ee20f8.png)

乔恩·泰森在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

许多是沾沾自喜的开发人员，他们称赞自己的高覆盖率超过了同行。许多人是愤世嫉俗者，对提及任何此类指标都嗤之以鼻。

我认为我们大多数人都处于这两种立场之间，认识到度量标准的价值，而不是成为它们的奴隶。

我最近在一句话里提到了“100%的测试覆盖率”。我忘记了确切的上下文，但我相信我是在指出，如果你严格遵循 TDD，不可能 100%不出错。

一位同事站了起来，透过他的显示器看着我，这是他大脑中最原始的东西，被“100%测试覆盖率”的说法激怒了。我们就这个问题进行了友好的辩论，我决定把我们讨论的内容写下来。

# 韵律学

测试覆盖率是良好实践的副产品，因此，您的开发团队可能不应该关注它。

作为一名开发人员，您可能已经知道您是否做了足够的测试，所以没有必要用一个度量来证实或反驳这种想法。如果度量标准说你没有做足够的测试，但是你相信你做得足够了，你应该写更多的测试吗？大概不会。

另一方面，你的老板，或者他们的老板，不应该去了解你的代码是否健壮。

不管你喜不喜欢，你的老板想知道你工作做得好不好。这可能包括测试你的代码，我这么说是基于你的老板重视自动化测试的假设。

让我们不要纠结于你的老板不重视测试的可能性，因为覆盖率在这种情况下没有任何帮助。

如果有人(包括你的老板)想知道你的代码测试有多好，他们有三个选择:

1.  和你谈谈。
2.  自己检查你的代码。
3.  查看某种高级指标，让他们有一个大致的概念。

选择一是可行的，但依赖于信任和共同理解。我曾经和一些声称写了足够多测试的团队一起工作过，然而每个拉请求都有实现，却没有测试。

我挑战任何开发人员，让我相信他们不需要测试新功能。

我也和一些人一起工作过，他们不顾一切地不想传递坏消息，以至于对他们的测试质量撒了谎。结果发现根本没有测试。

第二种选择对许多人来说是不现实的。*利益相关者被允许关心测试*，因为如果操作得当，它代表了一个巨大的安全网。但是大多数涉众可能缺乏技术专长、时间和经验来通读一套测试并评估它们的质量。

这就是度量发挥作用的地方。测试覆盖率并不能保证高质量的代码，就像一部电影的质量不能由它赚了多少钱来保证一样。在这两种情况下，给定的指标只是指标，并由权力机构用来作出决定。

代码覆盖率的真正价值是作为一个指标。就像高利润意味着好电影一样，高代码覆盖率意味着经过良好测试的代码库。

当然，也有例外。

《变形金刚》及其许多(许多)续集取得了巨大的票房成功，但该系列中的许多电影却受到观众的严厉批评。与此同时，有无数的电影在经济上难以获得成功，但却获得了普遍的好评。例如，《搏击俱乐部》被视为经典之作，但票房表现平平。

但我们说的是代码质量，不是电影。当我看到 90%的代码覆盖率时，我可能会合理地假设这个项目是经过充分测试的。当我看到 10%的覆盖率时，我可能会合理地认为它不是。

如果我是一个高级领导，低覆盖率可能会告诉我，我的团队没有时间编写测试。这可能表明团队正在追赶最后期限，或者他们不知道如何测试他们的代码。

这可能允许我为了团队和项目的利益做出调整——度量标准成为对话的起点。

更难发现的问题是高代码覆盖率掩盖了低质量。我不常看到这种情况，但确实会发生。通常它发生在没有经验的开发人员独自工作而没有同行评审的时候。

对这种行为的最好治疗是结对编程，尽管大多数团队满足于代码审查。

# 高覆盖率，低质量是什么样子的？

质量差的测试可能有多种形式，但最常见的是，它们只有很少的断言。这种测试作为烟雾测试仍然有一些价值，但往往会掩盖更难发现的问题。

有一次，我正在审查一个 pull 请求，其中所有测试都通过了，并且覆盖率超过了构建管道中设置的任意阈值。

一个测试在测试设置期间创建了一个模拟，唯一的断言是针对模拟的输出。这向我强调了开发人员不理解模拟的目的，当我与他交谈时，他对自己的代码相当挑剔，但对过程更挑剔。

对他来说，蹩脚的测试毫无意义，因为它们只是断言模拟的结果，但却是通过覆盖关卡所必需的。

考虑到有多少拉请求没有得到适当的审查(尤其是测试)，我怀疑我还能找到更多的例子，并想知道围绕测试的冷嘲热讽有多少是基于糟糕的假设。

在上面的例子中，我与有问题的开发人员一起重写了他的测试，以理解单元测试的目的。我相信这对很多人来说都是老生常谈了，但偶尔提醒一下自己也无妨。

*   单元测试应该测试一个类/功能(单元)。
*   单元应该足够小，以便于测试——如果你发现自己在测试同一个单元的几十种不同排列，这可能表明你的单元做得太多了，应该分成更小的单元([单一责任原则](https://en.wikipedia.org/wiki/Single_responsibility_principle))。
*   您应该模仿单元外部的依赖关系，比如 API 调用或其他与这个单元交互的单元(例如，当编写包含几个子组件的组件时，您可能应该模仿子组件并在其他地方测试它们)。
*   你不应该模仿单元内部的任何东西——这种味道通常意味着你应该在类之外重构一些东西。
*   您的断言不应该关心私有属性或方法——只测试单元的输出，而不是内部。

最后一部分尤其重要，因为这是脆弱测试最常见的结束方式之一。这里有一个坏测试与好测试的对比示例:

在第一个例子中，我们的断言并没有真正测试任何对最终用户有价值的东西。用户不关心属性是否被设置——他们关心的是数据在屏幕上是否可见。第二个例子展示了一种更好的断言方式。

例外的情况是当你写一个 API 给其他人使用的时候。此时，您的用户是另一个开发人员，您可能会关心正在设置的属性，因为用户/开发人员将需要这些属性。

但是同样，您应该只测试公共属性，因为它们构成了您与用户的契约。不要去测试你的单元内部。

当然，有许多方法可以编写“坏”的测试，但是大多数时候，即使是“坏”的测试也比没有好。

我敢肯定，也有例外，但在大多数情况下，您编写测试的事实对您的客户和未来的您来说是一个巨大的胜利。

# 度量=怀疑

我看到许多开发人员在团队之外的任何人询问代码覆盖率时变得怀疑。“你为什么需要知道？”往往是下意识的反应。

在某些方面，这是合理的，但这在很大程度上取决于外部一方的动机。开发人员不想感觉到他们的度量标准将被用作惩罚他们的棍棒，也不想感觉到他们必须“玩游戏”才能显得有能力。

这说明了团队和世界其他地方之间的不信任。“他们”想给每支球队排名，惩罚垫底的。“其他团队”将通过编写质量差的测试来增加覆盖率并显得有能力，从而玩弄这个系统。

“我们”在比较中会显得不如我们实际上的能力，因为“我们”有太多的正直去追逐一个标准。

我还没有不愉快地在任何人的领导下工作过，这些人实际上将覆盖率视为一个排名系统或质量的绝对衡量标准。

我毫不怀疑这样的人是存在的，但我确信其中许多人是可以谈论的。如果你认识这方面的人，首先让他们看看这篇文章。

# 最好的测试是失败的测试

记住你测试的目的是告诉你什么时候出了问题。在这方面，一个总是通过的测试是很好的，但最终是无用的。

同样的测试一旦失败就会变得有用。假设它没有因为您更改了测试本身而失败，测试失败表明您的实现有问题。

让您的测试提醒您这个问题比让客户发现它要好得多(或者更糟糕的是，让问题不被注意到，以微小的方式潜移默化地破坏您的应用程序)。

如果我的测试是一个人，一旦它标记的问题得到解决，我会带它出去喝一杯庆祝酒。

# 说重点！

哦，对了，代码覆盖率。嗯，我是这样看的:我很容易达到 100%的覆盖率，但仍然没有足够的测试。100%意味着我的每一行代码都至少运行了一次。可能还是胡言乱语。

一个更悲观的开发人员可能会以此作为 100%是一个愚蠢目标的理由。我想在某种程度上这是对的，但是什么能让 80%更好呢？你没有测试的额外的 20%中有什么？

我更喜欢排除我不想测试的代码，然后在剩下的所有代码上达到 100%的目标。通过这种方式，我明确了我想测试和不想测试的部分。

当然，我的 Java 开发人员朋友指出 getters 和 setters 是不需要测试的代码示例，因为它们是自动生成的，测试它们只是为了达到一个指标是浪费时间。

对此，我说:“来写 JavaScript 吧——这是所有酷孩子都在做的事情。”