<html>
<head>
<title>Building Your Own WotsApp — Part 5</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建您自己的WotsApp —第5部分</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/building-your-own-wotsapp-part-5-d4747e453a00?source=collection_archive---------17-----------------------#2020-03-12">https://betterprogramming.pub/building-your-own-wotsapp-part-5-d4747e453a00?source=collection_archive---------17-----------------------#2020-03-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d83c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用SwiftUI、Combine、通知、CloudKit和加密技术</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b5b79fd6f2ba28e866a403a3f6474be3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uoqH9KNdREvFtmishMxe6g.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@soppeldunk?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">马拉·普鲁西克</a>在<a class="ae ky" href="https://unsplash.com/s/photos/tall-buildings?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄。</p></figure><p id="ff9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我应该以免责声明开始这篇文章:它是基于iOS 13、Swift 5和Xcode 11.x的。如果你正在阅读这篇文章，而那些数字看起来过时了，请预先警告。</p><p id="7f2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还应该提醒你，通知——主要是远程通知——涉及苹果的基础设施，这意味着你需要一个苹果开发者账户才能使用它们。当然，你也需要一个来使用CloudKit。</p><p id="9a0b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，这是一个系列。你不会在20分钟内建立自己的WotsApp。它用了十章。这是最后两个，把我讲过的所有内容都集中到了一起。也就是说，你会在第10章的开头注意到一个长长的待办事项列表。我完了，但我没有。如果你想要更多的这个系列，请留下评论。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0e9e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">第九章</h1><p id="8f26" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在前两章中，我们开始实现消息传递方之间的对话。有很多不同的片段。所以我想最好是把SwiftUI部分移到它自己的章节里。我们开始行动吧。编辑<code class="fe mz na nb nc b">ContentView.swift</code>并创建更多变量:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="c3f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将这段代码添加到<code class="fe mz na nb nc b">Text</code>(“WotsApp”)指令中。请注意，我必须在这里使警告通用化，因为SwiftUI似乎不支持标记到同一个元素的多个<code class="fe mz na nb nc b">.alerts</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="cf0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们在这里也使用了新的<code class="fe mz na nb nc b">PassthroughSubject</code>。请确保您也将此添加到您的<code class="fe mz na nb nc b">ContentView.swift</code>文件的顶部:</p><pre class="kj kk kl km gt nf nc ng nh aw ni bi"><span id="a081" class="nj md it nc b gy nk nl l nm nn">let alertPublisher = PassthroughSubject&lt;(String, String), Never&gt;()</span></pre><p id="1007" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在将<code class="fe mz na nb nc b">enable</code>字段标记到<code class="fe mz na nb nc b">TextField</code>对象上，这样如果请求被拒绝或推迟，我们就可以禁用发送消息的请求。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="a9c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，添加对我们在上一章中放置的新的<code class="fe mz na nb nc b">cloud.authRequest</code>方法的调用。将它贴在拾取轮上。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="dd5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你应该可以再测试一次！去吧。请注意，要获得请求的选项，您需要下拉通知。你应该能够接受、推迟和拒绝通知……如果你同意，还可以互相发送加密短信。</p><p id="7fff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好了，我们开始了。但是我们还没有完全按照预想的那样实施协议。您还记得，当且仅当您知道共享秘密(一个你们都知道的秘密)时，我们希望用户请求允许将您添加到他的私有数据库中。为此，我们需要一个带有文本字段的警告弹出窗口。这在过去是微不足道的，但在SwiftUI中还没有。</p><p id="83bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里有一个解决方案。我并不是说这是<em class="no">的</em>解决方案。这仅仅是一个解决方案。首先，我们需要存储这个秘密，这样我们的<code class="fe mz na nb nc b">appDelegate</code>就可以很容易地访问它。点击此处查看新代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="4cae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">显然，我们需要在第一时间把秘密写出来。这是您在<code class="fe mz na nb nc b">contentView.swift</code>中看到的完整标签:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="99b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其次，我们需要更换我们的出版商。姑且称之为<code class="fe mz na nb nc b">popUpPublisher</code>。当我们在那里的时候，我们应该增加另一个出版商。我们称这个为<code class="fe mz na nb nc b">cestBonPublisher</code>。其目的是如果给出的密码是正确的，则释放消息传递字段。</p><pre class="kj kk kl km gt nf nc ng nh aw ni bi"><span id="cad1" class="nj md it nc b gy nk nl l nm nn">let popUpPublisher = PassthroughSubject&lt;String, Never&gt;()<br/>let cestBonPublisher = PassthroughSubject&lt;Void, Never&gt;()</span></pre><p id="5c69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第三，我们需要响应代码中的<code class="fe mz na nb nc b">PopUpPublisher</code>。将下面的代码标记为<code class="fe mz na nb nc b">Picker View</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7acd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后但同样重要的是，我们需要<code class="fe mz na nb nc b">popUp</code>的代码。将此添加到您的<code class="fe mz na nb nc b">ContentView.swift</code>的底部:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="78a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">哦，在我忘记之前，你显然需要抓住<code class="fe mz na nb nc b">cestBonPublisher</code>。该代码将需要与您已经定义的警报一起进行标记。我展示了完整的代码块，包括我们之前放入的警告:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="719f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以再做一次测试。它应该挑战你，把代码显示在交易中。如果输入错误，它会警告您，您将无法发送消息。正确输入，你不会得到任何警告，你可以发送消息。</p><p id="ccab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，这和我说的不太一样，但是很接近了。我将让读者删除弹出窗口中的代码。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9556" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">第十章</h1><p id="518a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们的最后一章——或许不是。随着项目的推进，我们留下了一些遗留问题。以下是一些开放项目的列表(您可能还能想到更多):</p><ul class=""><li id="509b" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">我们设置了认证握手，它工作了，但是它不能保存您的决定，每次都强制一个授权消息。</li><li id="b782" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">我们很方便地忽略了如果有两个同名的用户会发生什么。</li><li id="f28b" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">就这一点而言，没有对您输入的任何字段进行检查，这是非常糟糕的做法。至少，我们需要限制用户名/消息的长度——最好是字符集。</li><li id="7edd" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">我不应该承认，但我们在一些地方使用了幻数。这不是好的编码实践。我们不应该使用任何。</li><li id="fa3f" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">我们忽略了这样一个事实，如果您有大约100个或更多的用户，那么您只能得到最初搜索返回的一个子集。你必须一次又一次地递归搜索才能得到它们，这是CloudKit的一个特性。</li><li id="9a79" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">在这个问题上，我们确实需要一个更具伸缩性的解决方案来选择要通知的用户。滚动一个100的列表将会是一个束缚。想象一下1000。</li><li id="306c" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">在同一个领域，我们真的需要能够创建我们自己的用户组。拥有一个全球目录在现实世界中是不可行的。</li><li id="0cd4" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">还是在CloudKit这个话题上，没有删除用户的手段。这是糟糕的家务管理。</li><li id="d517" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">我们假设设备登录到iCloud，CloudKit才能工作。如果没有，就会失败。我们需要用一个明确的信息来解决这个问题。</li><li id="ac84" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">事实上，我们几乎在所有地方都跳过了错误报告。我们需要研究这个问题——特别是对于CloudKit和<code class="fe mz na nb nc b">RemoteNotification</code>。</li><li id="bdd0" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">我们建立了一种让多个用户使用一台设备的方法，但是我们没有完成这项功能。您应该还记得，我们使用CloudKit dashboard直接编辑我们的数据库。我们需要一个真正的解决方案。</li><li id="0dd6" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">当同一设备上有多个用户时，它仍会将他们列为源设备上的通知目标。如果你给他们发信息，那就失败了。另外，这毫无意义。</li><li id="4634" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">显然，您的设备需要连接到网络。否则，应用程序将会失败。我们也需要用一个明确的信息来解决这个问题。</li><li id="9e07" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">最后，我认为所有的信息应用程序都可以让你发送照片或语音信息。我们应该做同样的事情，并研究这种增强。</li></ul><p id="2dd1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，继续编码有很大的潜力。我没有按照任何特定的顺序排列这些。如果提交到苹果应用商店，一些开放点甚至可能导致你的应用被拒绝。精神食粮。</p><p id="81ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们完成我们开始的选项—每个设备多个用户。我们需要的只是一个简单的管理界面。对我们来说幸运的是，已经有一个以设置包的形式存在的。我们还将修复上面列表中倒数第二个提到的无意义问题。</p><p id="3ef7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">选择“文件”、“新建文件”,然后在“资源”下选择设置包。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/504b4e2a64cfc7b88f1c3bc648e5981b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*09mS-TX3G5WJsQKBXIqs8Q.png"/></div></div></figure><p id="556f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在将所有项目留在那里以供参考，尽管我们只打算使用开关。展开切换项目并更改标题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/d7ed5d0feb80f40d02539f2a4058058a.png" data-original-src="https://miro.medium.com/v2/resize:fit:932/format:webp/1*uKK9Dg3xKfhZpWwX3RUeIA.png"/></div></figure><p id="77d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在将这段代码添加到<code class="fe mz na nb nc b">appDelegate.swift</code>文件中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="34d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，这仅仅是读取和设置我们的开关的值。我们需要做的是改变读取私有云数据库的方法的行为。在我们的<code class="fe mz na nb nc b">Cloud.swift</code>中，我们这样做:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7c57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好吧，虽然有点笨拙，但它的工作方式是这样的:当你想在同一台设备上添加第二个用户时，你需要在启动应用程序之前打开“更多用户”开关。它将读取您想要更多用户(在同一设备上)的事实，并给你添加用户的菜单。当我们在<code class="fe mz na nb nc b">Cloud.swift</code>文件中时，我还想阻止具有相同令牌ID的用户出现。这是一个完整的方法，在末尾添加了一些新代码。这是为了防止在同一设备上注册的用户成为通知的潜在目标，这显然是无稽之谈。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="af8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以继续再测试一次。您应该能够使用设备向同一设备添加多个用户。让我们看看另一项未完成的工作来结束本章:保存授权对话。</p><p id="311a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们获得与某人交谈的许可时，我们需要将<code class="fe mz na nb nc b">auth</code>值保存在我们的私有数据库中。为了实现更改，我需要在我的<code class="fe mz na nb nc b">Cloud.swift</code>文件中再创建一些方法。当然，我需要在<code class="fe mz na nb nc b">ContentView.swift</code>中的正确时间给他们打电话。先说<code class="fe mz na nb nc b">Cloud.swift</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="e6c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此字段在目录数据库的本地私有副本中按名称查找记录，如果找到，则更新该记录。你需要在这里调用它——这里是发布者，如果你得到正确的密码，弹出窗口就会触发它。</p><pre class="kj kk kl km gt nf nc ng nh aw ni bi"><span id="cb31" class="nj md it nc b gy nk nl l nm nn">.onReceive(cestBonPublisher, perform: { (_) in<br/>self.disableText = false<br/>cloud.updateRex()<br/>})</span></pre><p id="959c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">测试这个比我们到目前为止所做的更具挑战性。因为你需要两个真实的设备登录到不同的AppleIDs。在你的WotsApp应用程序中与用户设置它们，并尝试发送通知、授予权限，然后从头再做一遍。第二次运行时，假设您同意了，它应该已经保存了您的初始协议，您将不会再次弹出下拉通知。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="02df" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="fe8c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这就把我带到了这个系列的结尾。如果你一直在关注并想了解更多，请在下面留言。有一大堆待办事项。我下一步应该处理什么？</p></div></div>    
</body>
</html>