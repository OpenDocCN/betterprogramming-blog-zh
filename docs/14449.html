<html>
<head>
<title>How to Enhance Firebase Emulator Logs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何增强Firebase模拟器日志</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/pretty-up-and-remove-noise-from-firebase-emulator-logs-5991a40736c3?source=collection_archive---------3-----------------------#2022-12-16">https://betterprogramming.pub/pretty-up-and-remove-noise-from-firebase-emulator-logs-5991a40736c3?source=collection_archive---------3-----------------------#2022-12-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0650" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">打扮一下，消除噪音</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ce8f840de4aac3b2f4db05edfa24766a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NhvWhg-i5lYzJS2lbfdmdQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="3c02" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我是Firebase的忠实粉丝，并广泛使用模拟器和我们的<a class="ae lr" href="https://www.ayrshare.com" rel="noopener ugc nofollow" target="_blank">社交媒体API </a>进行本地开发。</p><p id="58f7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">模拟器有很多很棒的功能，比如模拟云功能，Firestore，甚至pub/sub。如果使用<code class="fe ls lt lu lv b">console.log</code>将JSON日志输出到控制台，输出是可以接受的，尤其是使用<code class="fe ls lt lu lv b">JSON.stringify({...}, null, "\t")</code>对其进行格式化时。</p><p id="621c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然而，当你使用Firebase的<a class="ae lr" href="https://firebase.google.com/docs/functions/writing-and-viewing-logs" rel="noopener ugc nofollow" target="_blank">推荐的</a> <a class="ae lr" href="https://firebase.google.com/docs/functions/writing-and-viewing-logs" rel="noopener ugc nofollow" target="_blank">记录器</a>时，事情就变得混乱了。Logger是<a class="ae lr" href="https://cloud.google.com/logging" rel="noopener ugc nofollow" target="_blank"> Google Cloud Logger </a>，它允许你构建你的日志和JSON，这样你就可以在Google Cloud Dashboard中轻松地查看和搜索它们。</p><p id="bab6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">虽然Firebase logger的输出在Google Cloud仪表板上看起来很棒，但在我们的终端输出中却不那么好看:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lw"><img src="../Images/0435e2585de881549c24e00d30b4856d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1dqFzzyDVa8F3rpY8s4YEQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Firebase模拟器日志</p></figure><h1 id="71f6" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">增强Firebase模拟器日志</h1><p id="1a0f" class="pw-post-body-paragraph kv kw iq kx b ky mp jr la lb mq ju ld le mr lg lh li ms lk ll lm mt lo lp lq ij bi translated">我们对Firebase模拟器日志的理想期望是什么？</p><ul class=""><li id="62f1" class="mu mv iq kx b ky kz lb lc le mw li mx lm my lq mz na nb nc bi translated">使用记录器时JSON对象的格式化。</li><li id="57de" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">彩色输出，以便我们可以突出错误。</li><li id="99bc" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated">删除我们可能不关心的无关数据，例如“函数:您正在调试模式下运行函数模拟器(<code class="fe ls lt lu lv b">port=9229</code>)。这意味着功能将按顺序执行，而不是并行执行。”</li></ul><p id="9e7c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因为Firebase“还”没有提供这些功能，所以让我们构建自己的功能。</p><p id="aa9f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将把Firebase模拟器的输出保存到一个文件中，监视文件的变化，处理变化(格式等。)，并将处理后的数据输出到控制台。</p><ol class=""><li id="0fe0" class="mu mv iq kx b ky kz lb lc le mw li mx lm my lq ni na nb nc bi translated">克隆<a class="ae lr" href="https://github.com/ayrshare/firebase-emulator-logging" rel="noopener ugc nofollow" target="_blank"> Firebase模拟器日志GitHub库。</a>这是一个Node.js的app。在克隆的目录中运行典型的<code class="fe ls lt lu lv b">npm install</code>。</li><li id="d043" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq ni na nb nc bi translated">像平常一样启动Firebase模拟器，并输出到一个文件。比如:<code class="fe ls lt lu lv b">firebase emulators:start &gt; save.txt</code>或者<code class="fe ls lt lu lv b">npm run serve &gt; save.txt</code>。</li><li id="0629" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq ni na nb nc bi translated">回到克隆的目录，用<code class="fe ls lt lu lv b">node index.js --file {file location}</code>运行节点应用程序。比如:<code class="fe ls lt lu lv b">node index.js --file ./save.txt</code></li><li id="6112" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq ni na nb nc bi translated">享受新日志吧！</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/7b4a4634a32f9bd0c593c87867f6c3af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M63y_XkqK8bGGfnHsvYRjA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">格式化的Firebase日志</p></figure><h1 id="ab6a" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">增强的日志参数</h1><p id="0a70" class="pw-post-body-paragraph kv kw iq kx b ky mp jr la lb mq ju ld le mr lg lh li ms lk ll lm mt lo lp lq ij bi translated">运行Node应用程序时有几个选项。您已经看到了—文件，但是您也可以将输出设置为quiet，这意味着以“function”或“hosting”开头的系统输出被禁止，并且您可以关闭漂亮的格式设置。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/19754b320d6f28648deed309034f071d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gg914HV2ZvQpnmWL2g8teA.png"/></div></div></figure><h1 id="82d8" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">在幕后</h1><p id="7692" class="pw-post-body-paragraph kv kw iq kx b ky mp jr la lb mq ju ld le mr lg lh li ms lk ll lm mt lo lp lq ij bi translated">如果你想看所有的代码，可以去<a class="ae lr" href="https://github.com/ayrshare/firebase-emulator-logging" rel="noopener ugc nofollow" target="_blank"> GitHub </a>，或者这里是<code class="fe ls lt lu lv b">index.js</code>文件:</p><pre class="kg kh ki kj gt nl lv nm bn nn no bi"><span id="b574" class="np ly iq lv b be nq nr l ns nt">import readline from "readline";<br/>import TailFile from "@logdna/tail-file";<br/>import colorizer from "json-colorizer";<br/><br/>const QUIET_STRING = ["functions", "hosting", "storage", "pubsub"];<br/><br/>const quiet = process.argv.indexOf("--quiet");<br/>const prettyOff = process.argv.indexOf("--pretty-off");<br/>const fileIndex = process.argv.indexOf("--file");<br/><br/>if (fileIndex &lt;= -1 || !process.argv[fileIndex + 1]) {<br/>  console.error(<br/>    "You seem to be missing the --file argument. Please provide a file to tail."<br/>  );<br/>  process.exit(1);<br/>}<br/><br/>const options = {<br/>  pretty: prettyOff &lt;= -1 ? true : false,<br/>  colors: { STRING_LITERAL: "white" },<br/>};<br/><br/>async function startTail() {<br/>  const tail = new TailFile(process.argv[fileIndex + 1]).on(<br/>    "tail_error",<br/>    (err) =&gt; {<br/>      console.error("TailFile had an error!", err);<br/>    }<br/>  );<br/><br/>  try {<br/>    await tail.start();<br/>    const linesplitter = readline.createInterface({<br/>      input: tail,<br/>    });<br/><br/>    linesplitter.on("line", (line) =&gt; {<br/>      if (<br/>        quiet &amp;&amp;<br/>        QUIET_STRING.some((str) =&gt;<br/>          new RegExp(`(?&lt;=^...)(.*)${str}`, "gm").test(line)<br/>        )<br/>      )<br/>        return;<br/><br/>      let newLine = line;<br/>      if (newLine.startsWith("&gt;") &amp;&amp; newLine.endsWith("}")) {<br/>        const overrideOptions = { ...options };<br/><br/>        try {<br/>          const json = JSON.parse(newLine.slice(3));<br/>          switch (json?.severity) {<br/>            case "INFO":<br/>              overrideOptions.colors.STRING_KEY = "blue";<br/>              overrideOptions.colors.BRACE = "blue";<br/>              break;<br/>            case "WARNING":<br/>              overrideOptions.colors.STRING_KEY = "yellow";<br/>              overrideOptions.colors.BRACE = "yellow";<br/>              break;<br/>            case "ERROR":<br/>              overrideOptions.colors.STRING_KEY = "red";<br/>              overrideOptions.colors.BRACE = "red";<br/>              break;<br/>            default:<br/>              break;<br/>          }<br/><br/>          newLine = colorizer(newLine.slice(3), overrideOptions);<br/>        } catch (err) {<br/>          // ignore<br/>        }<br/>      }<br/><br/>      console.log(newLine);<br/>    });<br/>  } catch (err) {<br/>    console.error("Cannot start. Does the file exist?", err);<br/>  }<br/>}<br/><br/>startTail().catch((err) =&gt; {<br/>  process.nextTick(() =&gt; {<br/>    throw err;<br/>  });<br/>});</span></pre><p id="4a90" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用了两个外部NPM包:</p><ul class=""><li id="6b5f" class="mu mv iq kx b ky kz lb lc le mw li mx lm my lq mz na nb nc bi translated"><code class="fe ls lt lu lv b">import TailFile from "@<a class="ae lr" href="https://www.npmjs.com/package/@logdna/tail-file" rel="noopener ugc nofollow" target="_blank">logdna/tail-file</a>";</code>—tail file是一个很棒的包，它允许“跟踪”一个文件——只要有什么变化，就会发生一个事件。</li><li id="8cb4" class="mu mv iq kx b ky nd lb ne le nf li ng lm nh lq mz na nb nc bi translated"><code class="fe ls lt lu lv b">import colorizer from "<a class="ae lr" href="https://www.npmjs.com/package/json-colorizer" rel="noopener ugc nofollow" target="_blank">json-colorizer</a>"; </code>—JSON colorizer是一个包，允许您指定哪些JSON元素获得某种颜色。</li></ul></div></div>    
</body>
</html>