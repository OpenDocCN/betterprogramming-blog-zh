<html>
<head>
<title>How To Process Multiple Files 10x Faster in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Python中将处理多个文件的速度提高10倍</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-process-multiple-files-10x-faster-in-python-4f0ea9c7f64a?source=collection_archive---------5-----------------------#2021-04-15">https://betterprogramming.pub/how-to-process-multiple-files-10x-faster-in-python-4f0ea9c7f64a?source=collection_archive---------5-----------------------#2021-04-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c9db" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">不要循环，同时运行每个迭代</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e03aa4fbe4ddb8559d432610b34267fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mlq6yaAvdPfda34D"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">夏洛特·科内比尔在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="a923" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设您有100个文件需要处理，或者您需要运行一个函数，其中您要修改输入参数数百次。如果处理一个文件或一个函数调用只需要几分之一秒，那么你可以运行一个简单的<code class="fe lv lw lx ly b">for</code>循环。</p><p id="e7de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，如果每次迭代需要五分钟，那么这很容易占用一整天的时间。如果您有幸在具有许多节点的高性能计算机(HPC)上工作，本文将解释如何一次处理多个文件并充分利用HPC，这将节省时间并帮助您提高效率。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="3776" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">什么是Slurm？</h1><p id="046a" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated"><a class="ae ky" href="https://slurm.schedmd.com/documentation.html" rel="noopener ugc nofollow" target="_blank"> Slurm </a>是许多多用户HPC上的作业调度器。它用于对作业进行排队，直到计算资源可用。本文将使用一个bash脚本，该脚本使用<code class="fe lv lw lx ly b"><a class="ae ky" href="https://slurm.schedmd.com/sbatch.html#lbAB" rel="noopener ugc nofollow" target="_blank">sbatch</a></code>向HPC上的调度程序启动多个作业。每个作业将使用不同的输入参数调用相同的Python函数。</p><p id="9842" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有几种不同的方法可以达到这个目标。然而，为每个作业运行单独的任务是最灵活的方法，这也是我在这里介绍它的原因。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="bcbd" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">Python函数</h1><p id="48c0" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">第一步是编写一个适用于单个文件或迭代的Python函数。下面的脚本并没有做任何有用的事情，只是为了说明一个概念。它首先等待五秒钟，然后在进行下一次迭代之前将文件名写入日志文件。在现实世界中，这个脚本会更多地参与进来，做一些有用的事情。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7af8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意在<code class="fe lv lw lx ly b">__main__</code>函数中<code class="fe lv lw lx ly b">process_single_file</code>的参数是<code class="fe lv lw lx ly b">sys.argv[1]</code>。这告诉<code class="fe lv lw lx ly b">submit_slurm_script.sh</code>，我们将提供一个输入参数，这将在下一节讨论。注意是从<code class="fe lv lw lx ly b">1</code>开始而不是<code class="fe lv lw lx ly b">0</code>开始。可以用<code class="fe lv lw lx ly b">sys.argv[2]</code>等指定多个参数。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="d3ce" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">Bash脚本</h1><p id="9bcb" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">下面的bash脚本名为<code class="fe lv lw lx ly b">submit_slurm_script.sh</code>，用于将多个作业部署到集群。该脚本运行十个作业，每个作业都有不同的名称:<code class="fe lv lw lx ly b">py_job_1</code>、<code class="fe lv lw lx ly b">py_job_2</code>等。另外十个同名的作业也在队列中，并在第一个作业完成后开始。例如，一旦名为<code class="fe lv lw lx ly b">py_job_1</code>的第一个作业完成，下一个同名的作业就会开始。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="65df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们浏览一下这个文件中的每一行:</p><ul class=""><li id="98e5" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">#!/usr/bin/env bash</code>是指定语言的shebang。</li><li id="6a51" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">source activate base</code>激活<code class="fe lv lw lx ly b">conda</code>环境。</li><li id="6933" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">cd /burg/home/ljg2157/scripts</code>更改工作目录。</li><li id="dd9a" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">script=”slurm_python_script.py”</code>是我们提交的脚本名称的变量。</li><li id="1d13" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">let jobname=1</code>是增加作业名称的变量。</li></ul><p id="15d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">剩余部分在变量<code class="fe lv lw lx ly b">year</code>上循环。循环的每次迭代使用<code class="fe lv lw lx ly b">sbatch</code>向具有不同<code class="fe lv lw lx ly b">job_name</code>的集群提交不同的作业。注意附加到每个<code class="fe lv lw lx ly b">job_name</code>末尾的<code class="fe lv lw lx ly b">jobnumber</code>的用法。另外，请注意，每次<code class="fe lv lw lx ly b">sbatch</code>提交后<code class="fe lv lw lx ly b">jobname</code>都会增加<code class="fe lv lw lx ly b">1</code>。</p><h2 id="32f1" class="nt mh it bd mi nu nv dn mm nw nx dp mq li ny nz ms lm oa ob mu lq oc od mw oe bi translated">s批次选项</h2><p id="25f6" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">以下是<code class="fe lv lw lx ly b">sbatch</code>命令中每个选项的作用:</p><ul class=""><li id="68f3" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">account</code>:使用的资源将记入该账户。</li><li id="a44f" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">ntasks</code>:告诉Slurm控制器我们最多运行<em class="of"> n </em>个任务。</li><li id="4d4d" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">mem</code>:指定每个节点分配的内存。</li><li id="62bd" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">time</code>:设定每个作业的运行时间限制。这里最好稍微开明一点。</li><li id="e339" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">dependency</code>:用于推迟作业的开始时间。<code class="fe lv lw lx ly b">Singleton</code>设置一个依赖关系，即在具有相同作业名称和用户的任何先前启动的作业终止后，该作业可以开始执行。</li><li id="05c5" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">job-name</code>:这是您提交给集群的作业分配的名称。可以启动多个同名的作业。参见上面的<code class="fe lv lw lx ly b">dependency</code>。</li><li id="d6d3" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">wrap</code>:<strong class="lb iu"/><code class="fe lv lw lx ly b">wrap</code>后的命令字符串在一个简单的shell脚本中启动。这就是我们启动Python脚本的方式。</li></ul><p id="6b86" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这只是您可以传递给<code class="fe lv lw lx ly b">sbatch</code>的可能选项的一个子集。完整的列表可以在Slurm 上找到<a class="ae ky" href="https://slurm.schedmd.com/sbatch.html" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="9797" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">运行Bash脚本</h1><p id="1bfc" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">最后要做的是运行bash脚本，将所有作业提交到队列中:</p><pre class="kj kk kl km gt og ly oh oi aw oj bi"><span id="1055" class="nt mh it ly b gy ok ol l om on">bash submit_slurm_script.bash</span></pre><p id="eda1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查作业的状态以确保它们正在排队或运行总是一个好主意。Slurm使用<code class="fe lv lw lx ly b">squeue</code>来检查作业的状态。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="afd9" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">最后的想法</h1><p id="d4c3" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">希望这有助于您在访问HPC时加快Python <code class="fe lv lw lx ly b">for</code>循环的速度。在本例中，HPC没有在单核上使用传统的<code class="fe lv lw lx ly b">for</code>循环花费100秒，而是通过将任务分散到多个内核上，将时间缩短到仅10秒。如果每次迭代花费几分之一秒的时间，并且您的迭代次数相对较少，那么这种方法可能是多余的。但是，如果您有数百个文件，并且每个文件的处理需要几分钟，这可以节省您一整天的等待时间。</p><p id="9d52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的工作中，我经常需要重新网格化空间数据集，这非常耗时。投入时间去理解这是如何工作的，为我节省了无数的时间，让我更有效率。在HPC上工作而不充分利用它就像买了一个电动螺丝刀然后手动使用一样。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="6289" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">登录档</h1><p id="aa7e" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">下面是<code class="fe lv lw lx ly b">log.txt</code>的输出。注意，前十个文件的时间戳大致相同，并且Slurm脚本没有按照提交的顺序完成。您会注意到，五秒钟后，下一批十个脚本开始运行。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="bd87" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读。我很乐意帮助您解决在HPC上部署多个作业时可能遇到的任何问题。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="23f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="of">感谢阅读和支持媒体作者</em></p><div class="oo op gp gr oq or"><a href="https://lukegloege.medium.com/membership" rel="noopener follow" target="_blank"><div class="os ab fo"><div class="ot ab ou cl cj ov"><h2 class="bd iu gy z fp ow fr fs ox fu fw is bi translated">通过我的推荐链接加入Medium—Luke Gloege博士</h2><div class="oy l"><h3 class="bd b gy z fp ow fr fs ox fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oz l"><p class="bd b dl z fp ow fr fs ox fu fw dk translated">lukegloege.medium.com</p></div></div><div class="pa l"><div class="pb l pc pd pe pa pf ks or"/></div></div></a></div></div></div>    
</body>
</html>