# 交换文件的把戏

> 原文：<https://betterprogramming.pub/the-swap-file-trick-39651253001c>

## 用一种变通方法在 Ghost 上建立和运行我的网站

![](img/6acec556ac88af918325581f034f037e.png)

约纳坦·萨维德拉·佩拉斯在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 拍摄的照片

“嘿，看看我做了什么！”我得意洋洋地对一个朋友说，“它上线了。打开链接就行了！”。我为我的工作感到骄傲。经过几个晚上的疯狂工作，我终于完成了我的小项目，我准备向全世界展示它。

“可我什么也没看见！”我的第一个用户回复，透露出一丝怀疑。"屏幕一片空白。"我吓坏了。我感到被背叛和脆弱。仅仅几个小时后，我那令人惊叹的个人网站就已经关闭了，我不知道为什么。这是我无法忍受的情况。

我的[个人博客](https://blog.lorisocchipinti.com)由 Ghost 管理，这是一个开源的内容创建平台。我想要一个自托管的解决方案，所以我实例化了一个只有 1GB 内存的小型 EC2 实例(是的，它包含在 AWS 免费层中，是的，我是一个小气鬼),并在其上建立了我的博客。我发表了一些帖子，在埃菲尔铁塔下给自己拍了一张漂亮的照片，准备主宰博客世界。我一点也不知道我的小网站会在几个小时内关闭。

# 捉鬼

在盛怒之下，我重启了 EC2 实例，很快，我又可以向我的朋友们展示我的网站了。然而，这个问题被证明是一个特别棘手的问题:就像一个淘气的恶作剧鬼，有东西在我的(虚拟)家里捣乱，每隔几个小时就制造麻烦。但是谁是罪魁祸首呢？当然，流量高峰不在考虑范围之内:没有人知道这个网站，而且这个页面还没有被编入索引。根据 AWS 控制台，CPU 使用率似乎相当稳定，我也有一个轻松的信用余额。此时最合理的结论是 Ghost 出于某种原因耗尽了内存。

在很多博客帖子和用户群中四处搜索，我发现了一些有趣的东西。一些用户注意到 Ghost 可以在 1GB 内存上运行，但是，有时它会窒息而死。原因还不清楚(有人归咎于 Node.js 内存泄漏，图片我很惊讶)。就我而言，我不打算改变实例类型来改善它的规格，也不特别倾向于深入探讨这个问题。

我立刻有了一种直觉。我冲进 EC2 控制台，我证实了我的预感:我只有 1GB 的内存，但我坐在 8GB 的 SSD 上。“嗯，”我想，“可能默认的*交换*分区太小了。让我们看看。”

```
$ free -m
               total    used    free 
Mem:             941    870     71
```

没错。对于精通技术的读者来说，没有在虚拟机中定义交换分区可能并不奇怪。收集了这些信息后，我就能做出决定了。

# 奇妙的东西以及在哪里可以找到它们

首先，我将使用`dd`命令创建一个交换文件(也被友好地称为`data destroyer`):

```
sudo dd if=/dev/zero of=/swapfile bs=128M count=8
```

通过选择八个大小为 128MB 的块，此时我将拥有 1GB 的额外内存供我使用。现在，让我们为交换文件设置适当的读写权限:

```
$ sudo chmod 600 /swapfile
```

有必要告诉 Linux 也创建一个交换区:

```
$ sudo mkswap /swapfile
```

最后，我可以启用交换文件:

```
$ sudo swapon /swapfile
```

运行完这些命令后，我觉得我的虚拟机内存如此之大:

```
$ free -m
               total    used    free 
Mem:             941     411     530 
Swap:           1023     491     532
```

我希望我的实例记住我在启动时创建和使用交换文件的决定。为了指示它这样做，有必要在`/etc/fstab`文件中添加下面一行:

```
# /etc/fstab 
/swapfile swap swap defaults 0 0
```

有人可能会说，依赖交换文件是一种廉价的解决方法。对我来说，这更像是现实生活中的欺骗代码。

# 参考

*   [什么是“交换区”？关于 askubuntu.com 话题的一个极好的帖子](https://askubuntu.com/questions/508870/what-is-a-swap-area)
*   [如何在 EC2 中分配内存作为交换空间](https://aws.amazon.com/premiumsupport/knowledge-center/ec2-memory-swap-file/)

```
**Want to Connect?**

[Join my newsletter for more stories like this](https://blog.lorisocchipinti.com)
```