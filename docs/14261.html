<html>
<head>
<title>AWS Amplify: Mocking Lambda Function, S3 Storage, and GraphQL API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Amplify:模拟Lambda函数、S3存储和GraphQL API</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/aws-amplify-mocking-lambda-function-s3-storage-and-graphql-api-31e1f3cd0a0?source=collection_archive---------8-----------------------#2022-11-22">https://betterprogramming.pub/aws-amplify-mocking-lambda-function-s3-storage-and-graphql-api-31e1f3cd0a0?source=collection_archive---------8-----------------------#2022-11-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7ef3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">模仿服务并将它们部署到Amplify服务器上</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/553938f5cc1a77a6d9edec0e698b195d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*B2gYf-2ZE0VYmZ-s"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">亚历克斯·丘马克在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="e51b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我已经开始研究AWS Amplify，并决定写下我的研究和实验将有助于我更好地理解和记住它，如果它也能帮助你，我会很高兴的！</p><p id="d5f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">AWS Amplify是亚马逊网络服务(AWS)提供的一个完整的解决方案，特别是针对前端开发人员，提供工具来构建、交付和托管全栈应用程序，而无需深入了解开发运营、云工程和后端，也不会影响应用程序的安全性、可扩展性和质量。</p><p id="9dc2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将创建一个简单的项目来尝试mocking服务。什么是嘲讽服务，你为什么要把它添加到你的Amplify项目中？</p><p id="4967" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您编写所有代码，然后在Amplify命令的帮助下，通过终端将Amplify服务添加到您的项目中，或者您在Amplify控制台中创建这些服务。无论哪种方式，你都必须将你生成的代码进行放大，以构建数据库、lambda函数、存储空间等。这需要时间和资源，而这些时间和资源本可以用得更有成效。Mocking允许您在将所有内容发送到服务器之前，在本地应用程序中测试这些服务。</p><p id="c3a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">官方的<a class="ae kv" href="https://docs.amplify.aws/cli/usage/mock/" rel="noopener ugc nofollow" target="_blank">文档</a>非常清晰易懂，我强烈建议在开始应用之前，根据我或任何其他第三方写的内容通读一遍。</p><p id="bc95" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将创建一个迷你商店应用程序，不太关注前端，而是测试模仿本身。我有时会详细讲述这些步骤。如果你有信心，一定要进行下一步。<a class="ae kv" href="https://github.com/RMoriarty4/storeapp" rel="noopener ugc nofollow" target="_blank">项目</a>中使用的技术堆栈如下:</p><ul class=""><li id="042a" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">反应</li><li id="839a" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">以打字打的文件</li><li id="5884" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">AWS放大器</li></ul><p id="b197" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想看如何做下面提到的所有事情，看看Nader Dabit 的这个<a class="ae kv" href="https://www.youtube.com/watch?v=OxrHplxZ8BA&amp;t=803s" rel="noopener ugc nofollow" target="_blank">综合例子。看完文档，我用这个视频作为主要参考来创建项目，和视频里的差不多。主要的区别在于，这些年来一些命令已经发生了变化，所以本文是一个更新的版本。</a></p><h2 id="0ed4" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lf mp mq mr lj ms mt mu ln mv mw mx my bi translated">1.使用TypeScript模板安装React应用程序</h2><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="7823" class="ne mh iq na b be nf ng l nh ni">npx create-react-app storeapp --template typescript</span></pre><h2 id="5c35" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lf mp mq mr lj ms mt mu ln mv mw mx my bi translated">2.通过控制台初始化Amplify项目</h2><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="9a33" class="ne mh iq na b be nf ng l nh ni">amplify init</span></pre><p id="c33e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意</strong>:如果命令不起作用，检查是否全局安装了Amplify CLI。如果不是，安装<a class="ae kv" href="https://docs.amplify.aws/cli/start/install/" rel="noopener ugc nofollow" target="_blank">非常简单。</a></p><p id="bfd5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该命令将提示一系列可能会让初学者感到困惑的问题，以避免以后出现任何错误。我将提供我在本文所有步骤中所做的选择。他们中的大多数都是有目的地为项目选择的，有些是为了简化问题。</p><ul class=""><li id="0870" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">项目名称:<code class="fe nj nk nl na b">storeapp </code> —该名称将被用作Amplify控制台中的项目名称</li><li id="d08a" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">Amplify将自动检测机器、代码编辑器、语言、框架和环境，并为您提供配置细节。如果您愿意，可以更改它们，但是我接受了默认设置，因为对于这个项目来说，更改它们没有任何意义</li><li id="27bf" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">身份验证方法:AWS配置文件</li><li id="3e1a" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">配置文件:默认</li></ul><h2 id="34c3" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lf mp mq mr lj ms mt mu ln mv mw mx my bi translated">3.创建并模仿Lambda函数</h2><p id="3d2a" class="pw-post-body-paragraph kw kx iq ky b kz nm jr lb lc nn ju le lf no lh li lj np ll lm ln nq lp lq lr ij bi translated">现在，让我们创建一个Lambda函数，用于计算商店产品的折扣。在我们的项目中，我们提供与用户年龄成比例的折扣，因此我们的函数将接收用户的年龄和产品价格，并用折扣金额和折扣价格进行响应。</p><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="a422" class="ne mh iq na b be nf ng l nh ni">amplify add function</span></pre><p id="64b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行此命令将提示问题:</p><ul class=""><li id="52c9" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">功能:Lambda函数</li><li id="7069" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">函数名:<code class="fe nj nk nl na b">providediscount</code></li><li id="cafa" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">运行时:NodeJS</li><li id="0824" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">功能模板:Hello World</li><li id="b94d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">高级设置:否</li><li id="40ce" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">立即编辑:是</li></ul><p id="cb50" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将在您的项目文件夹(<code class="fe nj nk nl na b">amplify/backend/function/src</code>)的amplify目录中打开一个新文件夹。自动创建一个<code class="fe nj nk nl na b">index.js</code>文件，其中包含模板代码。删除该代码并添加提供的代码:</p><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="a9e6" class="ne mh iq na b be nf ng l nh ni">/**<br/> * @type {import('@types/aws-lambda').APIGatewayProxyHandler}<br/> */<br/>// eslint-disable-next-line no-undef<br/>exports.handler = async (event) =&gt; {<br/>  let price;<br/>  let age;<br/>  if (event.arguments) {<br/>    price = event.arguments.price;<br/>    age = event.arguments.age;<br/>  } else {<br/>    price = event.price;<br/>    age = event.age;<br/>  }<br/><br/>  const discountAmount = price * (age / 100);<br/>  const discountedPrice = price - discountAmount;<br/><br/>  const response = {<br/>    discountAmount,<br/>    discountedPrice,<br/>  };<br/>  return response;<br/>};</span></pre><p id="4a2c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们检查<code class="fe nj nk nl na b">event.arguments</code>的原因是为了能够通过GraphQL API模拟该函数，这将在接下来的步骤中创建。</p><p id="df6e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为我们的函数需要参数作为模拟数据输入，所以我们必须在某个地方提供该数据，以便amplify知道在哪里引用。为此，<code class="fe nj nk nl na b">events.json</code>文件在功能安装过程中自动创建在同一个文件夹中。我们需要年龄和价格作为模拟数据，所以我们向文件中添加一个JSON对象(在添加事件之前，确保文件为空):</p><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="1e49" class="ne mh iq na b be nf ng l nh ni">{<br/>  "age": 40,<br/>  "price": 100<br/>}</span></pre><p id="0786" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们嘲笑:</p><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="090a" class="ne mh iq na b be nf ng l nh ni">amplify mock function providediscount</span></pre><p id="84a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该命令将询问引用哪个文件，默认为我们已经更新的<code class="fe nj nk nl na b">events.json</code>文件。然后，将在终端中执行该功能并显示结果。因此，我们在终端中得到响应:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/3ee84ab802e8e859ed6588d51b391e2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YTD-lLrfV5rY4F_DsojjzA.png"/></div></div></figure><p id="fd7d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果满足了我们的需求，现在我们的功能已经准备好进行放大、构建并交付生产。</p><h2 id="1a38" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lf mp mq mr lj ms mt mu ln mv mw mx my bi translated">4.创建和模拟存储</h2><p id="085d" class="pw-post-body-paragraph kw kx iq ky b kz nm jr lb lc nn ju le lf no lh li lj np ll lm ln nq lp lq lr ij bi translated">我们希望能够作为用户上传图像，然后尝试从存储中获取图像。这将证明存储服务按预期工作，并为生产做好准备。</p><p id="8bee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">默认情况下，Amplify使用身份验证与S3存储服务进行交互。为了能够将这个服务添加到我们的项目中，我们首先必须添加AWS Cognito认证服务。</p><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="7986" class="ne mh iq na b be nf ng l nh ni">amplify add auth</span></pre><p id="ca13" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行此命令将提示问题:</p><ul class=""><li id="b372" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">配置:默认</li><li id="a7d6" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">登录方式:用户名</li><li id="6de9" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">高级设置:否</li></ul><p id="2fbf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了能够使用它，我们必须推动身份认证服务进行扩展:</p><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="775e" class="ne mh iq na b be nf ng l nh ni">amplify push auth</span></pre><p id="c904" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们可以添加存储服务:</p><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="f8e6" class="ne mh iq na b be nf ng l nh ni">amplify add storage</span></pre><p id="9d5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行此命令将提示问题:</p><ul class=""><li id="bcf6" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">选择服务:内容</li><li id="bc13" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">为资源提供一个名称作为标签:<code class="fe nj nk nl na b">userimages</code></li><li id="1edd" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">存储桶名称:默认</li><li id="1600" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">谁应该有访问权限:来宾和经过身份验证的用户</li><li id="bcfc" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">对于认证用户:创建、更新、读取、删除</li><li id="c556" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">对于客人:阅读</li><li id="1f4f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">λ触发器:否</li></ul><p id="be3c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在需要做的就是创建一个小页面来与两件事情进行交互:与用户进行交互，这样他们就可以登录并上传图像；与存储服务进行交互，将文件存储到某个位置，然后取回文件并显示给用户。</p><p id="03ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了这两个目的，我们将安装两个Amplify包来更新我们的前端:</p><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="7c2b" class="ne mh iq na b be nf ng l nh ni">npm i @aws-amplify/ui-react aws-amplify</span></pre><p id="8099" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装完成后，移动到<code class="fe nj nk nl na b">index.tsx</code>文件或任何包含React项目根元素的文件。我们需要配置Amplify，这样我们使用的对象和方法将在整个项目中可用。<br/>从<code class="fe nj nk nl na b">aws-exports.js</code>文件导入<code class="fe nj nk nl na b">awsConfig</code>，安装时方便放在同一个文件夹中。从<code class="fe nj nk nl na b">aws-amplify</code>导入放大，增加<code class="fe nj nk nl na b">awsConfig</code>放大对象的配置方式:</p><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="cc32" class="ne mh iq na b be nf ng l nh ni">import awsConfig from './aws-exports';<br/>import { Amplify } from 'aws-amplify';<br/><br/>Amplify.configure(awsConfig);</span></pre><p id="db1c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们转到我们的<code class="fe nj nk nl na b">app.tsx</code>文件，在那里实际的页面被编码。</p><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="5d3b" class="ne mh iq na b be nf ng l nh ni">import React from 'react';<br/>import './App.css';<br/><br/>import { Button, Flex, Image, withAuthenticator } from '@aws-amplify/ui-react';<br/>import { Storage } from 'aws-amplify';<br/>import '@aws-amplify/ui-react/styles.css';<br/><br/>const App: React.FC = () =&gt; {<br/>  const [image, updateImage] = React.useState&lt;{<br/>    key: string | null;<br/>    signedUrl: string | null;<br/>  }&gt;({ key: null, signedUrl: null });<br/><br/>  async function getImage() {<br/>    if (!image.key) return;<br/>    const signedUrl = await Storage.get(image.key);<br/>    updateImage({ ...image, signedUrl });<br/>  }<br/><br/>  async function onChange(e: React.ChangeEvent&lt;HTMLInputElement&gt;) {<br/>    const file = e.target.files?.[0];<br/>    if (!file) return;<br/>    const imageInfo = await Storage.put(file.name, file);<br/>    updateImage({ ...image, key: imageInfo.key });<br/>    console.log('image updated,', imageInfo);<br/>  }<br/><br/>  return (<br/>    &lt;div className="App"&gt;<br/>      &lt;header className="App-header"&gt;<br/>        &lt;Flex direction={'column'} maxWidth="900px"&gt;<br/>          &lt;input type="file" accept="image/png" onChange={(e) =&gt; onChange(e)} /&gt;<br/>          &lt;Button variation="primary" size="large" onClick={getImage}&gt;<br/>            Get Image<br/>          &lt;/Button&gt;<br/>          {image.signedUrl &amp;&amp; (<br/>            &lt;Image src={image.signedUrl} alt={image.key as string} /&gt;<br/>          )}<br/>        &lt;/Flex&gt;<br/>      &lt;/header&gt;<br/>    &lt;/div&gt;<br/>  );<br/>};<br/><br/>export default withAuthenticator(App);</span></pre><p id="a7d9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们必须检查这个文件中创建和使用的函数。首先，上传文件S3存储放大器提供了现成的方法对象。一旦用户上传文件，该事件将触发异步存储方法将文件“放”在存储器中。当用户点击查看图像时，从存储器中调用另一个异步的“get”方法。在这两个事件中，我们相应地更新状态，以便能够重新呈现DOM。<code class="fe nj nk nl na b">key</code>和<code class="fe nj nk nl na b">signedUrl</code>是两个键值对，表示文件在存储器中的存储方式。</p><p id="aae0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为什么我们要在导入的<code class="fe nj nk nl na b">withAuthenticator</code>函数中导出我们的<code class="fe nj nk nl na b">App</code>组件？</p><p id="7287" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当你运行<code class="fe nj nk nl na b">npm start</code>时，你会看到在能够上传之前，你必须登录/注册。这个导入的函数为我们提供了一个函数中的整个auth组件和过程，一旦包装在其中，未经授权的用户就无法到达上传部分。请确保也导入这些样式。否则，整个事情看起来就像我们一直在做的一切都是徒劳的(我们也可以定制我们喜欢看到的auth组件，添加社交登录等。，不过那是后话了)。</p><p id="2e95" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">测试存储的一切准备就绪！运行<code class="fe nj nk nl na b">amplify mock</code>在本地启动存储，并在单独的终端运行<code class="fe nj nk nl na b">npm start</code>。您可以注册并上传文件，然后单击“获取图像”按钮。如果图片出现在您的屏幕上，您的存储服务就已经准备好了。</p><h2 id="5e4d" class="mg mh iq bd mi mj mk dn ml mm mn dp mo lf mp mq mr lj ms mt mu ln mv mw mx my bi translated">5.创建和模仿GraphQL API</h2><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="3696" class="ne mh iq na b be nf ng l nh ni">amplify add api</span></pre><p id="10b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行此命令将提示问题:</p><ul class=""><li id="e9e7" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">服务:GraphQL</li><li id="b9be" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">授权类型:Amazon Cognito用户池(我们之前在auth安装过程中创建了这个用户池)</li><li id="fa8f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">其他授权类型:是</li><li id="0d1b" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">附加授权类型:API密钥(我们希望客人能够在没有授权的情况下看到产品)</li><li id="3a1e" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">描述:公共访问</li><li id="f299" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">到期:默认</li><li id="1505" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">模式模板:ToDo(这是最简单的一个)</li></ul><p id="64bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦安装完成，我们将在amplify目录的后端文件夹中创建一个新的API文件夹。在该文件夹中，我们可以找到准备更新的<code class="fe nj nk nl na b">schema.graphql</code>文件。删除里面的所有代码，并添加以下内容:</p><pre class="kg kh ki kj gt mz na nb bn nc nd bi"><span id="dadc" class="ne mh iq na b be nf ng l nh ni">type ProductType<br/>  @model(subscriptions: null)<br/>  @auth(<br/>    rules: [<br/>      { allow: groups, groups: ["Admin"], operations: [create, update, delete] }<br/>      { allow: public, operations: [read] }<br/>    ]<br/>  ) {<br/>  id: ID!<br/>  name: String!<br/>  products: [Product] @hasMany<br/>}<br/><br/>type Product<br/>  @model(subscriptions: null)<br/>  @auth(<br/>    rules: [<br/>      { allow: groups, groups: ["Admin"], operations: [create, update, delete] }<br/>      { allow: public, operations: [read] }<br/>    ]<br/>  ) {<br/>  id: ID!<br/>  name: String!<br/>  price: Float!<br/>}<br/><br/>type Query {<br/>  provideDiscount(price: Float!, age: Float!): PriceInfo<br/>    @function(name: "providediscount-${env}")<br/>}<br/><br/>type PriceInfo {<br/>  discountAmount: Float!<br/>  discountedPrice: Float!<br/>}</span></pre><p id="05b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个模式告诉我们什么？第一种类型的<code class="fe nj nk nl na b">ProductType </code>将让管理员创建一个产品类别，他们希望在其中出售的商品。用户将能够从数据库中读取。如果您查看该类型和产品类型中的授权规则，您会发现只有标签为“Admin”的组可以控制数据。公众只能阅读这些数据。</p><p id="e7e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe nj nk nl na b">DiscountQuery</code>类型将让我们触发我们通过GraphQL创建的Lambda函数，用类型<code class="fe nj nk nl na b">PriceInfo</code>进行响应。</p><p id="b5fb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">模式已经准备好了，现在我们可以通过使用Amplify提供的<code class="fe nj nk nl na b">codegen</code>来创建现成的查询、类型和订阅，从而节省更多的时间。运行<code class="fe nj nk nl na b">amplify add codegen</code>并回答提示的问题:</p><ul class=""><li id="9735" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">语言:打字稿</li><li id="5dc2" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">文件名模式:默认</li><li id="8feb" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">生成代码？:是的</li><li id="7d13" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">深度:默认</li><li id="312c" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">生成代码的文件:默认</li><li id="5411" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">立即生成？:是的</li></ul><p id="e78d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Amplify将生成可供客户端(前端)使用的所有必要代码，并将其放在我们项目的src目录中。基于我们的模式和模式中的关系，所有读取、写入和更新数据的代码都将成为我们在React组件中使用的现成函数，无论我们在哪里需要它们。现在，我们不会真正使用它们，但我们会嘲笑它们。代码生成后，运行<code class="fe nj nk nl na b">amplify mock</code>并等待终端提供AppSync模拟端点。</p><p id="5c03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">单击模拟端点，GraphQL explorer将在一个新的选项卡中打开，侧栏中显示所有可用的请求查询。我们可以继续从请求中检查我们的项目需要的一切。创建产品类型，检查对未授权用户的响应，通过请求模仿功能，等等。</p></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><p id="cf80" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们已经成功地模拟了我们的服务，并准备好部署代码。运行<code class="fe nj nk nl na b">amplify push</code>来部署代码以放大服务器，然后将所有更改推送到您的GitHub帐户，因为在下一步，您将想要将您的GitHub文件夹连接到Amplify以配置CI/CD等等。</p><p id="8cd4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想检查代码或者对它有什么意见，请随时查看<a class="ae kv" href="https://github.com/RMoriarty4/storeapp" rel="noopener ugc nofollow" target="_blank"> GitHub源代码</a>。</p></div></div>    
</body>
</html>