<html>
<head>
<title>Docker Tips: Mind the ‘privileged’ Flag</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">码头工人提示:小心“特权”标志</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/docker-tips-mind-the-privileged-flag-d6e2ae71bdb4?source=collection_archive---------1-----------------------#2018-10-01">https://betterprogramming.pub/docker-tips-mind-the-privileged-flag-d6e2ae71bdb4?source=collection_archive---------1-----------------------#2018-10-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="464e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">确保有意使用它，以避免权限泄露</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c86ae44db0cde81e60c4a395aa1885dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M7csNGG-Hc61ZlqCmKt4Iw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">弗洛里安·伯杰在<a class="ae ky" href="https://unsplash.com/s/photos/key?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="39b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您在运行容器时使用了<code class="fe lv lw lx ly b">--privileged</code>标志，请确保您知道自己在做什么。在这篇文章中，我们将展示其使用可能引发的意想不到的影响。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lz"><img src="../Images/f8492dd1b90a51568597af3f8f8d74ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m5p_SdM4VnAbfH_0YH1Qxg.png"/></div></div></figure></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="5d53" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">设置测试环境</h1><p id="d838" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">首先，我们在VirtualBox上使用<a class="ae ky" href="https://vagrantup.com" rel="noopener ugc nofollow" target="_blank">vagger</a>创建一个虚拟机。</p><p id="e894" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:如果你不知道这个来自<a class="ae ky" href="https://hashicorp.com" rel="noopener ugc nofollow" target="_blank"> Hashicorp </a>的伟大工具，我建议你试一试，因为它超级方便。</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="ad12" class="ni mi it ly b gy nj nk l nl nm"># Init the vagrant box (based on bionic64)<br/>$ vagrant init ubuntu/bionic64</span><span id="5632" class="ni mi it ly b gy nn nk l nl nm"># Launch the VM<br/>$ vagrant up</span><span id="977e" class="ni mi it ly b gy nn nk l nl nm"># ssh in the newly created VM<br/>$ vagrant ssh</span></pre><p id="a875" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一个(非常方便的)命令在我们新创建的Linux机器上安装Docker。</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="6e8f" class="ni mi it ly b gy nj nk l nl nm">$ curl <a class="ae ky" href="https://get.docker.com" rel="noopener ugc nofollow" target="_blank">https://get.docker.com</a> | sh</span></pre></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="67c8" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated"><strong class="ak">特权标志的用途</strong></h1><p id="7b3b" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">运行带有<code class="fe lv lw lx ly b">--privileged</code>标志的容器会赋予容器所有的功能，还可以访问主机的设备(所有东西都在<code class="fe lv lw lx ly b">/dev</code>文件夹下)。我们来看看这个。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/b0cece53dbfc61fa98022290c925608c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3sMT1_aPANeySIooTJxrMA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">不使用- privileged标志运行的容器中的可用设备列表</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/43846b15ba8ccef7c6dc1f09ec9de9cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8HlP4y5huGHRG-WRInMhzw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用- privileged标志运行的容器中的可用设备列表</p></figure><p id="d96a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着容器可以访问连接到主机的硬盘驱动器。因为许多容器是以完全特权根用户运行的，所以后果可能是灾难性的。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="0d82" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated"><strong class="ak">做着龌龊的事情</strong></h1><p id="3f92" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">让我们在基于alpine的容器中运行一个shell，并用<strong class="lb iu"> </strong> <code class="fe lv lw lx ly b">--privileged</code>标志为它提供一些额外的功能。</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="fc40" class="ni mi it ly b gy nj nk l nl nm">$ docker run -ti --privileged alpine</span></pre><p id="3131" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦进入容器，让我们使用对主机设备的访问来做一些非常糟糕的事情，比如删除磁盘分区。首先，我们使用<code class="fe lv lw lx ly b">fdisk</code>工具列出现有的分区。</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="d507" class="ni mi it ly b gy nj nk l nl nm">/ # fdisk -l<br/>Disk /dev/sda: 10 GB, 10737418240 bytes, 20971520 sectors<br/>4209 cylinders, 106 heads, 47 sectors/track<br/>Units: cylinders of 4982 * 512 = 2550784 bytes</span><span id="aaeb" class="ni mi it ly b gy nn nk l nl nm">Device  Boot StartCHS    EndCHS        StartLBA     EndLBA    Sectors  Size Id Type<br/>/dev/sda1 *  0,32,33     281,105,47        2048   20971486   20969439  9.9G 83 Linux<br/>Disk /dev/sdb: 10 MB, 10485760 bytes, 20480 sectors<br/>10 cylinders, 64 heads, 32 sectors/track<br/>Units: cylinders of 2048 * 512 = 1048576 bytes</span><span id="f6a4" class="ni mi it ly b gy nn nk l nl nm">Disk /dev/sdb doesn't contain a valid partition table</span></pre><p id="8e86" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们删除第一个分区。</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="1f86" class="ni mi it ly b gy nj nk l nl nm">/ # fdisk /dev/sda</span><span id="d306" class="ni mi it ly b gy nn nk l nl nm">The number of cylinders for this disk is set to 4209.<br/>There is nothing wrong with that, but this is larger than 1024,<br/>and could in certain setups cause problems with:<br/>1) software that runs at boot time (e.g., old versions of LILO)<br/>2) booting and partitioning software from other OSs<br/>   (e.g., DOS FDISK, OS/2 FDISK)</span><span id="02f6" class="ni mi it ly b gy nn nk l nl nm">Command (m for help): d<br/>Selected partition 1</span><span id="0f0c" class="ni mi it ly b gy nn nk l nl nm">Command (m for help): w<br/>The partition table has been altered.<br/>Calling ioctl() to re-read partition table<br/>fdisk: WARNING: rereading partition table failed, kernel still uses old table: Resource busy</span></pre><p id="ff1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们退出容器并重启主机。</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="d3be" class="ni mi it ly b gy nj nk l nl nm">root@ubuntu-bionic:/home/vagrant# reboot</span></pre><p id="ac8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们看看Virtualbox控制台，似乎发生了不好的事情:虚拟机无法启动了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lz"><img src="../Images/af2c251801798f58a9e9b77cc868e269.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WfmV2BCUCfBV-bBYEJuvyg.png"/></div></div></figure><p id="6deb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们在这里快速演示了如何在特权容器中手动使用<code class="fe lv lw lx ly b">fdisk</code>实用程序来损害我们的主机。但是如果这个任务是在我们不知道的情况下在一个容器中自动完成的呢？其他磁盘工具，如<code class="fe lv lw lx ly b">parted</code>或<code class="fe lv lw lx ly b"> sfdisk</code> <strong class="lb iu">，</strong>可以使这种自动化变得非常简单。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="66ef" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">摘要</h1><p id="c26a" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">如果您运行的图像不是来自可信来源，请小心它是否需要<code class="fe lv lw lx ly b">--privileged</code>标志。当然，有些情况下需要这个标志，例如在Raspberry Pi这样的设备上运行容器时。它确实用于访问GPIO接口，并能够与外部世界进行交互(并使LED闪烁)。</p></div></div>    
</body>
</html>