<html>
<head>
<title>System Design: Build a Real-World Physical Storage Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">系统设计:构建一个真实的物理存储应用程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/system-design-real-world-physical-storage-application-8859c2415175?source=collection_archive---------4-----------------------#2022-03-17">https://betterprogramming.pub/system-design-real-world-physical-storage-application-8859c2415175?source=collection_archive---------4-----------------------#2022-03-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d2b7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">设计、优化、分析</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d3a0d553eda348da69287aa270b2fa06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4QpdBM516FvHCha1B67-Yw.jpeg"/></div></div></figure><p id="4469" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">存储空间应用程序是一个平台，在这个平台上，空间所有者可以连接到需要在特定时间段内存储其商品和项目的客户。</p><h1 id="fa65" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated"><strong class="ak">系统的需求和目标</strong></h1><p id="e184" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">让我们按照以下要求设计应用程序:</p><h2 id="c991" class="mk lo iq bd lp ml mm dn lt mn mo dp lx la mp mq lz le mr ms mb li mt mu md mv bi translated"><strong class="ak">功能需求</strong></h2><p id="f0e4" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated"><strong class="kt ir"> <em class="mw">空间主人:</em> </strong></p><ol class=""><li id="74b5" class="mx my iq kt b ku kv kx ky la mz le na li nb lm nc nd ne nf bi translated">一个新的空间，一个应用程序的仓库</li><li id="974e" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">更新现有空间的信息。可能想要添加或修改该区域。</li><li id="8d01" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">查看特定时间段的预订情况。</li></ol><p id="51e9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir"> <em class="mw">客户:</em> </strong></p><ol class=""><li id="6c68" class="mx my iq kt b ku kv kx ky la mz le na li nb lm nc nd ne nf bi translated">使用搜索标准搜索特定位置的空间存储</li><li id="adfc" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">预订特定时间段的存储。最短持续时间为15天。</li><li id="9a7d" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">检查预订</li></ol><p id="2479" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir"> <em class="mw">附加要求:</em> </strong></p><ol class=""><li id="1b9d" class="mx my iq kt b ku kv kx ky la mz le na li nb lm nc nd ne nf bi translated">空间所有者提供货物的取货和卸货服务</li><li id="941b" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">货物可以是个人的、商业的、文件的、家庭的或汽车的。</li><li id="b2a5" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">观看现场录像的选项(如果空间所有者安装了闭路电视)。这会建立信任。</li><li id="e999" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">由场地所有人提供的货物保险。所有应用程序可以扣留空间所有者的钱，一旦合同结束，完全可以退还并转移回空间所有者。</li><li id="5166" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">分析以检查哪些空间位置和区域工作得最好。</li></ol><h2 id="e8fa" class="mk lo iq bd lp ml mm dn lt mn mo dp lx la mp mq lz le mr ms mb li mt mu md mv bi translated"><strong class="ak">非功能需求</strong></h2><ol class=""><li id="4e58" class="mx my iq kt b ku mf kx mg la nl le nm li nn lm nc nd ne nf bi translated">低延迟</li><li id="01f9" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">高可用性</li><li id="1b28" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">高一致性。</li></ol><h1 id="c845" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated"><strong class="ak">产能估算</strong></h1><p id="06e8" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">让我们假设全球有大约50万空间所有者和大约1000万存储空间。</p><p id="f4cf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">该应用程序将具有较少的活跃用户，因为用户将主要在特定时间段内使用该服务一次。</p><h1 id="26f5" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated"><strong class="ak">系统架构</strong></h1><p id="25d0" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">我们的应用程序主要由三个主要ui组成:</p><ol class=""><li id="be5d" class="mx my iq kt b ku kv kx ky la mz le na li nb lm nc nd ne nf bi translated">面向空间所有者的用户界面/应用程序</li><li id="b958" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">供客户预订的用户界面/应用程序</li><li id="2be0" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">查看预订的通用用户界面/应用程序</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/4aaabadf71e7f279b244d10d8ec83e7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XqZlBLkk0OMpYdQoOVg9cQ.png"/></div></div></figure><p id="5059" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的应用程序将由以下组件组成:</p><ol class=""><li id="f65e" class="mx my iq kt b ku kv kx ky la mz le na li nb lm nc nd ne nf bi translated">负载平衡器:它们将来自所有ui的流量平衡到多个服务器上，帮助应用程序扩展。</li><li id="f22d" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">存储服务:这项服务将让空间所有者保存他们的存储空间细节，还包括blob数据，即图像/视频的地方。</li><li id="c1de" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">NoSql集群:保存存储空间的元数据。为此，我们可以使用任何nosql数据库。</li><li id="c5d0" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">CDN:我们需要CDN在地理上分发信息</li></ol><p id="6c9a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所有信息都将实时更新给客户和空间所有者，以便他们上传新的存储空间进行搜索和预订。为此，我们将使用消息队列，如Kafka或Rabbit MQ。</p><ol class=""><li id="169c" class="mx my iq kt b ku kv kx ky la mz le na li nb lm nc nd ne nf bi translated">卡夫卡:提供从生产者到消费者的数据流。</li><li id="ca53" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">搜索消费者:应用程序中更新的关于新存储的数据将流向搜索消费者，这些消费者将连接到弹性搜索。</li><li id="cb81" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">弹性搜索集群:主要用于快速搜索服务检索以及模糊搜索。</li><li id="aafc" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">搜索服务:搜索服务将能够从弹性搜索中获得结果，并提供给客户界面。</li><li id="136b" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">预订服务:预订服务使客户能够在特定时间段内对特定存储进行数据块存储。这些数据将流向卡夫卡。为什么？因为一旦我们预订了存储空间，我们不希望它在搜索中显示该特定时间段。</li><li id="e783" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">预订服务将与支付服务就支付相关事宜进行沟通。一旦付款成功，我们就可以在nosql集群中成功预订。</li><li id="2367" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">存档服务:用于现场预订。这基本上阻止预订，并将数据存储在Casandra类型的数据库中。也可以使用HBase。</li><li id="b673" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">通知服务:通知所有用户。例如，如果客户进行了预订，则通知空间所有者。否则，如果被空间所有者取消，则通知客户。</li><li id="6902" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">预订管理服务:该服务将与客户和空间所有者对话以查看预订。预订来自NoSQL集群(表示取消，进行中，支付失败，成功)，并通过Casandra db实现实时预订服务。</li><li id="7125" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">Redis:减少我们的数据库集群的负载，并用作快速检索的缓存。</li><li id="82bb" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">Hadoop集群:空间和预订事务流入，我们可以在其上分析和操作一些M.L。</li></ol><h1 id="c717" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated"><strong class="ak"> API和数据库设计</strong></h1><p id="040e" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">我们将有4个主要的API来上传和更新存储:</p><p id="392f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe np nq nr ns b">POST /space</code>(到船上新的空间存储)</p><p id="97a6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe np nq nr ns b">GET /space/:id</code>(获取特定存储以查看信息和书籍)</p><p id="d0f6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe np nq nr ns b">PUT /space/:id</code> <strong class="kt ir"> </strong>(编辑特定空间的信息)</p><p id="c3ab" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe np nq nr ns b">DELETE /space/:id</code>(删除特定空间)</p><p id="178e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="mw">预订我们将有:</em></p><p id="32b1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe np nq nr ns b">POST /booking</code> <strong class="kt ir"> </strong>(在特定的时间间隔内预订特定的存储)</p><p id="f716" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于使用数据库，关系数据库适合这种业务模型，因为它有ACID保证。</p><h2 id="d9a2" class="mk lo iq bd lp ml mm dn lt mn mo dp lx la mp mq lz le mr ms mb li mt mu md mv bi translated"><strong class="ak">太空数据库</strong></h2><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="954a" class="mk lo iq ns b gy nx ny l nz oa">Space: {id, type, name, locality, dimensions, amenities, description, original_images, is_active, price_per_day}</span><span id="cf0f" class="mk lo iq ns b gy ob ny l nz oa">SpaceType ENUMS: [PERSONAL, BUSINESS]</span><span id="a6ab" class="mk lo iq ns b gy ob ny l nz oa">SpaceAmenities: {id, space_id, amenity_id, is_active}</span><span id="0d93" class="mk lo iq ns b gy ob ny l nz oa">SpaceLocality: {id, city_id, state_id, country_id, zipcode, is_active}</span></pre><h2 id="2d2f" class="mk lo iq bd lp ml mm dn lt mn mo dp lx la mp mq lz le mr ms mb li mt mu md mv bi translated"><strong class="ak">预订数据库</strong></h2><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="e55b" class="mk lo iq ns b gy nx ny l nz oa">AvailableSpace: {space_id, date, initial_qty, available_qty &gt; 0}</span><span id="a5be" class="mk lo iq ns b gy ob ny l nz oa">Booking: {booking_id, space_id, user_id, start_date, end_date, status, invoice_id, goods_type}</span><span id="38e2" class="mk lo iq ns b gy ob ny l nz oa">GoodsType ENUMS: [HOUSEHOLD, AUTOMOBILE, OFFICE_ITEMS]</span><span id="5818" class="mk lo iq ns b gy ob ny l nz oa">Status ENUMS: [RESERVED, BOOKED, CANCELLED, COMPLETED]</span></pre><p id="a56b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">API如何从UI与应用服务器交互，然后最终与数据库交互:</p><p id="7863" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe np nq nr ns b">POST /book</code> <em class="mw"> </em>以这些参数为例<em class="mw"> </em> { <code class="fe np nq nr ns b">booking_id</code>、<code class="fe np nq nr ns b">space_id</code>、<code class="fe np nq nr ns b">user_id</code>、<code class="fe np nq nr ns b">start_date</code>、<code class="fe np nq nr ns b">end_date</code> }</p><ol class=""><li id="54aa" class="mx my iq kt b ku kv kx ky la mz le na li nb lm nc nd ne nf bi translated">检查可用空间[每个可用空间/房间]</li><li id="f8ee" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">插入预订数据库并减少<code class="fe np nq nr ns b">available_qty</code></li><li id="37e6" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">在Redis中输入TTL(生存时间),例如10分钟的实时预订，以保留预订，然后预订将过期。一旦令牌过期，Redis将发出通知。我们稍后会处理这个问题。</li><li id="adff" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">放入卡夫卡(消息队列)</li><li id="9593" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">重定向至付款。可选地，可以重定向到聊天，以便所有者和客户之间进行对等交流(更新预订状态帖子)</li></ol><h2 id="c096" class="mk lo iq bd lp ml mm dn lt mn mo dp lx la mp mq lz le mr ms mb li mt mu md mv bi translated"><strong class="ak">如何处理Redis过期令牌？</strong></h2><p id="6c0b" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">Redis密钥最终会过期。</p><ol class=""><li id="0254" class="mx my iq kt b ku kv kx ky la mz le na li nb lm nc nd ne nf bi translated">如果Redis密钥过期，然后付款成功，那么我们可以用多种方式处理，比如将付款退回给用户，通知他请求已过期。或者更聪明的方法是检查是否有可用的存储空间，然后预订。</li><li id="94a7" class="mx my iq kt b ku ng kx nh la ni le nj li nk lm nc nd ne nf bi translated">如果支付成功，那么我们可以忽略Redis令牌是否过期。</li></ol><h1 id="b63c" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated"><strong class="ak">优化</strong></h1><p id="fea6" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">如果支付成功，那么我们可以直接从Redis删除密钥。</p><p id="5372" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们还应该监视整个系统的CPU和内存是如何工作的。</p><p id="3a40" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在整个基础架构中，我们需要密切关注CPU使用率以及内存和磁盘使用率。</p><p id="36f7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">grifana可以进行监控，这是一种工具，我们可以在特定的阈值上设置警报。如果超过任何阈值，开发人员将会收到警告。</p><p id="ed1f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这对于低延迟和高可用性非常重要。</p><h1 id="ed30" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated"><strong class="ak">分析学</strong></h1><p id="13d3" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">我们可以在我们的应用程序中设置Kibana日志，并在kibana dashboard上创建不同类型的图表，以监控如何以及哪些存储工作得最好，特定区域的需求和供应，以及预订的成功率和失败率。</p><p id="ef76" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">基于这些数据，业务部门采取行动，决定应用程序应该如何关注以及关注哪个方向。</p><h1 id="1967" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated"><strong class="ak">分布式数据</strong></h1><p id="bce2" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">我们可以通过在该地区的不同部分建立数据中心来在地理上分布我们的数据，因为空间存储将主要建立在一个特定的区域并且不会移动。</p><p id="b087" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，区域1的用户说印度应该从印度数据中心获取数据，区域2的用户说美国应该从美国数据中心获取数据。</p><p id="07a0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">数据将有复制节点。如果其中一个节点发生故障，另一个节点可以代替它来检索信息/数据。复制也可以与具有区域的数据分区配对，</p></div></div>    
</body>
</html>