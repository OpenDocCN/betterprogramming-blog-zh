# 为 AWS 无服务器项目建立可预测成本模型的 5 个步骤

> 原文：<https://betterprogramming.pub/5-steps-to-making-a-predictable-cost-model-for-aws-serverless-projects-78d78909bb82>

## 无服务器很棒。为您使用的东西付费。但是你怎么知道你会用多少呢？让我们试着弄清楚

![](img/1f080bcde1b80d6f8e4102c4958f8528.png)

Artem Beliaikin 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片。

当我第一次发现 AWS serverless 时，它是自切片面包以来最好的东西。事实上，它比切片面包好吃。这是未来。所以我很快收集了我所有的鸡蛋，并把它们放在 AWS 篮子里。

无服务器的核心原则是你为你所使用的付费。你不需要为在空中托管你的代码支付一笔费用。你不为空闲时间付钱。您需要为存储、计算和数据传输付费。加上 AWS 免费层，从现在开始，你基本上可以免费访问你所有的附带项目。

但是真正的项目呢？生产代码。推动商业的东西。那要花多少钱？为您使用的东西付费似乎是一个好主意，直到您必须计算出您的应用程序在未来一年、三年和五年的运行成本。

# 1.发现碎片

一个无服务器的项目就是 API Gateway，Lambda，DynamoDB，S3，对吧？虽然这在表面上看起来可能是真的，但实际上有许多其他服务参与到拼凑你的应用程序中。CloudFront(内容交付)、Route53 (DNS 路由)和 CloudWatch(日志、指标和警报)通常是一个完整应用程序中被遗忘的组件。

但是除了被遗忘的服务之外，你可能知道也可能不知道在使用这些服务时你将被收费的所有事情。Lambda 不仅仅是每次调用的费用。你还必须为你的 lambdas 运行的时间和消耗的内存付费。对于 API Gateway，您不仅要为每个请求付费，还要为数据传输量付费。

您可以将成本分为两类:计算和存储。

*   计算成本是短暂。上个月用了多少不重要。这个月是一个新的开始。换句话说，成本不会自行增加。
*   存储成本则相反。无论数据是何时添加的，您都需要为存储的所有数据付费。如果你有一个应用程序，每月增加 1 GB 的数据，一年后你将支付 12 GB 的存储空间(如果你不清理这些)。

# 2.了解您的数据

数据传输。没人想过这个问题，但他们需要。几乎每个 AWS 无服务器服务都有数据传输成本。这对我们意味着什么？

![](img/933b7e5c6661218a6af6119ec192a646.png)

由[卢克·切瑟](https://unsplash.com/@lukechesser?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄。

首先，确保您正确地设计了您的解决方案。如果您有一个从 S3 检索文档并通过 API Gateway 传送的端点，您需要为从 S3 和 API Gateway 传送的数据付费。更好的解决方案是返回一个链接到文档的签名 URL，然后让您的客户端下载该文件。但这不是我们在这里要谈的。

如果您想要对成本进行半精确的预测，了解数据大小的粗略估计是至关重要的。

您需要了解您有多少个实体，以及这些实体中包含多少数据。你要通过网络传输整个实体吗？也许只是一个子集？你期望每种类型的实体有多少个？您是否在 S3 之外存储和检索大文件？

当然，您还需要考虑您存储了多少数据。如果您每月存储 100 万个实体，每个实体的大小为 50 KB，这意味着您每月将存储 50 GB。如果您无限期地存储这些数据，您的存储成本将会迅速增加。

# 3.确定您所在的地区

您可能不知道这一点，但 AWS 服务的费用因其运营地区而异。例如，在美国东部(n . Virginia ), 100 万个 lambda 请求的成本为 0.20 美元。但是，如果您在亚太地区(香港)部署，同样的一百万个请求将花费 0.28 美元。如果你在政府云上构建一个应用程序，你会得到另一个全面的价格上涨。

如果您正在部署一个需要在地区之间传输数据的应用程序，那么您也必须为此支付数据传输费用。

幸运的是，如果你在同一个地区，大多数服务之间没有数据传输成本(意味着在 Lambda 和 DynamoDB 之间发送数据没有成本)。

如果您在美国东部(N. Virginia)用完了，以下是一些常见服务的费用明细:

您可能拥有上表中列出的部分、全部或更多服务。只需挑选您使用的服务，并开始构建您的模型。

# 4.对业务流程建模，而不是聚合

我认为这是需要考虑的最重要的事情。我们都知道使用模式在应用程序中并不是均匀分布的。有些事情是一次性操作，比如用户注册。其他事情每天都比其他事情发生得更频繁。

让我们用一个示例应用程序来说明我们的观点。Yelp 是一个网站，允许用户创建一个帐户，查看地方的评级，并添加他们自己的评级。如果我们分解这些主要业务流程的成本，它可能看起来像这样:

**创建账户**

*   兰达斯:3
*   API 网关调用:1
*   用户元数据存储:1 KB
*   Cloudwatch 日志:1kb
    ~费用:0.00000698 美元/创建的账户

**查看收视率**

*   兰姆达斯:1
*   API 网关调用:1
*   API 网关数据传输:. 5 MB
*   S3 数据传输:5 MB(用于用户图像)
*   CloudFront 数据传输:5 MB
*   DDB 读取容量单位:15
*   Cloudwatch 日志:1kb
    ~成本:收视率$0.0009249‬/view+每月 DDB rcu 1.40 美元

**添加评级**

*   兰姆达斯:6
*   API 网关调用:1
*   API 网关数据传输:. 5 MB
*   阶跃函数转换:5
*   社交网络请求:1
*   S3 存储:. 5MB
*   DDB 写容量单位:3
*   Cloudwatch 日志:5kb
    ~费用:0.00019337 美元/新评级+DDB WCUs 每月 1.40 美元

基于这些数字，如果你估计一个月有 1000 个新用户，200 万次评级浏览和 150，000 次新评级，你就可以知道你的应用程序的运行成本了。

这一切都是为了了解您的业务流程，以及您希望它们被使用到什么程度。

相反，如果您只是汇总了 10 个 lambdas、三个端点和一些 S3 存储，您的估计会受到影响。

# 5.负载测试它

AWS 并没有让预测你的无服务器应用变得非常容易。获得合理估计的一种方法是对其进行负载测试。更好的是，用上面的公式估计所有的东西，然后运行一个负载测试来衡量准确性。

在你的数学中做必要的调整，并磨练你的预测。记住，预测不应该被认为是事实。您的应用程序将根据使用情况计费。不可能做到完全正确。

有几种不同的方法可以对无服务器应用程序进行负载测试。你可以使用像[火炮](https://artillery.io/)这样的第三方公司来做负载测试，或者你可以使用 [AWS 解决方案](https://aws.amazon.com/solutions/distributed-load-testing-on-aws/)。无论哪种方式，这将是你的应用程序将花费多少钱的最有力的来源之一。

负载测试的一个明显的缺点是每次测试都要付费，但是我们这里说的是无服务器测试。与传统解决方案相比，它的成本很低。

# 结论

在一个没有服务器的世界里，预测比过去需要更多的努力。成本模型是可预测的，但这一切都归结于您的应用程序的业务流程。

您对有多少人将使用您的应用程序以及哪些业务流将比其他业务流使用得更多的估计越准确，您的预测就越准确。

祝你的无服务器之旅好运。享受灵活性、移动性和成本效益的世界！