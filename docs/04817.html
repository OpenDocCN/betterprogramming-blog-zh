<html>
<head>
<title>How to Harden Your Microservices on Kubernetes Using Istio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Istio强化Kubernetes上的微服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-harden-your-microservices-on-kubernetes-using-istio-29c23dd90670?source=collection_archive---------6-----------------------#2020-05-12">https://betterprogramming.pub/how-to-harden-your-microservices-on-kubernetes-using-istio-29c23dd90670?source=collection_archive---------6-----------------------#2020-05-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2339" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Istio如何为您的微服务实现安全性</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f76c85d9f807d436f264913aea553886.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g0zGM7_4j0jmEo4IEzhnhQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="http://xilophotography" rel="noopener ugc nofollow" target="_blank">卡蒂</a>在<a class="ae ky" href="http://xilophotography.com" rel="noopener ugc nofollow" target="_blank">西洛摄影</a></p></figure><p id="4fc9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在生产中运行<a class="ae ky" href="https://en.wikipedia.org/wiki/Microservices" rel="noopener ugc nofollow" target="_blank">微服务</a>有很多好处。其中一些是独立的可伸缩性、敏捷性、变更范围的缩小、频繁的部署和可重用性。然而，他们也有自己的一系列挑战。</p><p id="2991" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于monolith，安全性的概念围绕着保护单个应用程序。然而，一个典型的企业级微服务应用可能包含数百个相互交互的微服务。</p><p id="4616" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kubernetes 为托管和编排您的微服务提供了一个出色的平台。但是，默认情况下，微服务之间的所有交互都是不安全的。它们通过明文HTTP进行通信，这可能不足以满足您的安全需求。</p><p id="30ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在微服务上应用您将在典型企业整体架构上使用的相同原则，您需要确保以下几点:</p><ul class=""><li id="0b78" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">微服务之间的所有通信都经过加密，以防止中间人攻击</li><li id="c059" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">服务之间存在访问控制，因此只有正确的微服务才能相互连接</li><li id="95ac" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">捕获、记录和审核遥测数据，以了解流量行为并主动检测入侵</li></ul><p id="9ee6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>提供了开箱即用的特性，安装和管理的简单性使开发人员、系统管理员和安全团队能够适当地保护他们的微服务应用，而不会互相影响。</p><p id="622b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">借助Istio，您可以实施强大的身份和访问管理、透明的TLS和加密、身份验证和授权以及审计日志记录，所有这些都使用单一控制平面。</p><p id="4cc7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个故事是对“<a class="ae ky" href="https://medium.com/better-programming/how-to-visualise-your-istio-service-mesh-on-kubernetes-209c7b439a41" rel="noopener">如何在Kubernetes </a>上可视化您的Istio服务网格”的跟进今天，我们来讨论使用Istio来强化您在Kubernetes上运行的微服务。</p><p id="65e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文假设您对Kubernetes和Istio有基本的了解。如果没有，我建议您查看“<a class="ae ky" href="https://medium.com/better-programming/how-to-manage-microservices-on-kubernetes-with-istio-c25e97a60a59" rel="noopener">如何使用Istio </a>管理Kubernetes上的微服务”以获得快速介绍。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="add3" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">Istio安全性的工作原理</h1><p id="5131" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">如果您正在阅读本系列，您应该知道Istio会自动在您的pods中注入sidecar代理，并修改您的Kubernetes集群的IP表，只允许通过代理进行连接。</p><p id="88b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认情况下，此设置启用TLS加密。您不需要为您的微服务做任何特殊的配置，因为Envoy代理通过TLS相互通信。</p><p id="4ebe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然默认设置允许基本的安全性并防止中间人攻击，但通过实施策略来进一步强化您的微服务是有意义的。然而，在深入研究这些特性之前，让我们先来看看安全性如何在Istio上工作的高级概述。</p><p id="c8be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Istio包含以下用于加强安全性的组件:</p><ul class=""><li id="bebe" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">用于管理密钥和证书的认证机构</li><li id="bee0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">配置API服务器，向特使代理分发认证策略、授权策略和安全命名信息</li><li id="17e3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">sidecar代理通过提供策略执行点来帮助保护网格。这是根据提供给它的策略进行操作的组件。</li><li id="6654" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">特使代理扩展允许遥测数据收集和审计</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/7c3b472ad7588dcab438d5978de9ad45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V8KAdUmBjtFhkXA0GChsHQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://istio.io/docs/concepts/security/arch-sec.svg" rel="noopener ugc nofollow" target="_blank"> Istio security </a></p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="494e" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">Istio如何管理身份和证书</h1><p id="8a3b" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">Istio需要识别每个微服务，以便在其上应用策略。Istio通过X509 TLS证书建立身份，每个Envoy代理都使用这些证书。</p><p id="709c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Envoy代理包含Istio代理，它与istiod进行对话，为每个微服务提供并轮换证书和私钥。这允许额外的安全性，因为您不需要担心轮换证书。</p><p id="d526" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果某个密钥被破解，Istio会很快用新密钥替换它，从而大幅减少攻击面。</p><p id="6295" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Istio使用以下步骤来实施它。</p><ol class=""><li id="dad1" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu no mb mc md bi translated">特使使用特使秘密发现服务(SDS) API发送证书和私钥请求</li><li id="43b3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">Istio代理通过为代理生成CSR和私钥来响应这个请求，然后将CSR及其凭证发送给Istio</li><li id="8703" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">istiod托管的证书颁发机构(CA)验证请求凭据并签署CSR以生成证书</li><li id="7869" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">然后，istio代理下载证书，并通过SDS API将其发送给特使代理</li></ol><p id="5c4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该过程定期重复，以提供证书和私钥轮换。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/dcaafebdadeb571a348ada3c7112140e.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*6YOsS98-RbDUlbJMy0K0XA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://istio.io/docs/concepts/security/id-prov.svg" rel="noopener ugc nofollow" target="_blank"> Istio证书管理</a></p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="9058" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">Istio认证</h1><p id="459b" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">Istio提供两种类型的身份验证:</p><ul class=""><li id="f14e" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><strong class="lb iu">对等认证</strong> — Istio在两个微服务相互交互时应用这种认证。Istio使用相互TLS进行对等身份验证。</li><li id="c507" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">请求认证</strong> — Istio允许最终用户和系统使用请求认证与Istio微服务进行交互。它使用<a class="ae ky" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JSON Web令牌</a> (JWT)来实现这一点。您还可以将Istio与任何使用<a class="ae ky" href="https://oauth.net/" rel="noopener ugc nofollow" target="_blank"> OAuth、</a>的定制身份验证提供者挂钩，例如<a class="ae ky" href="https://openid.net/connect/" rel="noopener ugc nofollow" target="_blank"> OpenID Connect </a>和<a class="ae ky" href="https://www.google.com/landing/2step/" rel="noopener ugc nofollow" target="_blank"> Google Auth </a>。</li></ul><p id="e902" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Istio使用<code class="fe nq nr ns nt b">PeerAuthentication</code>策略来确定认证和加密要求的级别。默认情况下，Istio以<code class="fe nq nr ns nt b">PERMISSIVE</code>模式验证客户端。这意味着除了允许来自对等体的TLS流量之外，它还接受来自源的明文流量。</p><p id="cadc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最近引入Istio的组织可能需要它，因为他们正在将其工作负载迁移到Istio。</p><p id="48c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这消除了由于各种原因升级源以使用Istio的运营商的大量开销。这为组织提供了无缝的入职体验。</p><p id="2be6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦你拥有了整个企业，或者你是从零开始，你应该关闭<code class="fe nq nr ns nt b">PERMISSIVE</code>模式，启用<code class="fe nq nr ns nt b">STRICT</code> mutual TLS only模式。这不仅可以防止中间人攻击，还可以确保通过您的网络的所有流量都是加密的。</p><p id="7ecd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果需要，您可以通过在<code class="fe nq nr ns nt b">DISABLE</code>模式下运行Istio认证来关闭微服务之间的相互TLS。这是不推荐的，除非您提供定制的安全解决方案，否则您不应该使用它。</p><p id="cd25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在全局级别、名称空间级别或工作负载级别实施<code class="fe nq nr ns nt b">PeerAuthentication</code>策略。您的具体用例决定了您希望如何应用它。</p><p id="42cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的YAML在<code class="fe nq nr ns nt b">foo</code>命名空间层应用<code class="fe nq nr ns nt b">STRICT</code> <code class="fe nq nr ns nt b">PeerAuthentication</code>策略。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="abfb" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">Istio授权</h1><p id="c456" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">现在让我们进入下一个阶段。到目前为止，我们已经确保Istio中的微服务之间的通信是加密的，并且服务了解他们的客户是谁。</p><p id="4148" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，如果您希望确保只有正确的微服务相互接口，该怎么办呢？例如，如果您有一个前端微服务、一个业务层微服务和一个后端，您不会希望允许前端微服务直接与后端进行通信。相反，您会希望通过业务层路由这种通信。</p><p id="3e90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用<code class="fe nq nr ns nt b">AuthorizationPolicy</code>资源来启用微服务之间的授权，并使用以下内容来建立适当的流量通道:</p><ul class=""><li id="69c8" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe nq nr ns nt b">selector</code>字段指定策略目标</li><li id="6813" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe nq nr ns nt b">action</code>字段指定是将请求<code class="fe nq nr ns nt b">allow</code>还是<code class="fe nq nr ns nt b">deny</code></li><li id="f2f2" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe nq nr ns nt b">rules</code>部分使用<code class="fe nq nr ns nt b">from</code>、<code class="fe nq nr ns nt b">to</code>和<code class="fe nq nr ns nt b">when</code>属性定义何时应用<code class="fe nq nr ns nt b">action</code></li></ul><p id="ab93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看一个例子来进一步理解。</p><p id="9850" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是一个微服务的典型实现，它允许来自OAuth场景中经过Google认证的源的请求。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="d493" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">YAML档案:</p><ul class=""><li id="b828" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">选择所有标有<code class="fe nq nr ns nt b">app: httpbin</code>和<code class="fe nq nr ns nt b">version: v1</code>的目标</li><li id="5ae0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">当提供的<code class="fe nq nr ns nt b">JWT</code>的发布者声明具有值<code class="fe nq nr ns nt b"><a class="ae ky" href="https://accounts.google.com" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com</a></code>时，允许来自使用服务帐户<code class="fe nq nr ns nt b">cluster.local/ns/default/sa/sleep</code>的容器和来自<code class="fe nq nr ns nt b">dev</code>名称空间中的所有容器的请求仅指向目标的<code class="fe nq nr ns nt b">GET</code>方法</li></ul><p id="52a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看一些更简单的东西。只允许从<code class="fe nq nr ns nt b">foo</code>名称空间到<code class="fe nq nr ns nt b">httpbin:v1</code>微服务的所有请求怎么样？</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="dd1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你仔细观察YAML，它实现了一个<code class="fe nq nr ns nt b">DENY</code>动作。不要搞混了，因为来源是<code class="fe nq nr ns nt b">notNamespaces</code>。这意味着该策略拒绝所有请求，除非它来自<code class="fe nq nr ns nt b">foo</code>名称空间。</p><p id="c4ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">拒绝策略优先于允许策略。它首先评估拒绝策略，以确保无论允许策略如何，与拒绝策略匹配的请求都会被拒绝，因此在设计策略时请记住这一点。</p><p id="5361" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看一个不同的场景。如何只允许对<code class="fe nq nr ns nt b">products</code>应用程序的<code class="fe nq nr ns nt b">GET</code>和<code class="fe nq nr ns nt b">HEAD</code>方法的请求？</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="ed76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于Istio Envoy代理在第7层上工作，您还可以在主机名、URL路径和HTTP头等方面进行匹配。下面的例子允许对<code class="fe nq nr ns nt b">products</code>微服务的路径<code class="fe nq nr ns nt b">/test/*</code>和<code class="fe nq nr ns nt b">*/info</code>的所有请求。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="b2e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Istio提供了许多实施授权策略的方法，上面的列表并不详尽。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="f395" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="9621" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">感谢您通读。我希望你喜欢这篇文章。</p><p id="9163" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一部分“<a class="ae ky" href="https://medium.com/better-programming/enable-mutual-tls-authentication-between-your-kubernetes-workloads-using-istio-65338c8adf82" rel="noopener">使用Istio </a>在您的Kubernetes工作负载之间启用相互TLS认证”中，我们将通过实际操作演示深入探讨Istio认证，下一篇文章再见！</p></div></div>    
</body>
</html>