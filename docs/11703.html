<html>
<head>
<title>Creating a VPC With Autoscaling in AWS CLI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS CLI中创建具有自动缩放功能的VPC</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/creating-a-vpc-with-autoscaling-in-aws-cli-45708c953ab5?source=collection_archive---------6-----------------------#2022-04-09">https://betterprogramming.pub/creating-a-vpc-with-autoscaling-in-aws-cli-45708c953ab5?source=collection_archive---------6-----------------------#2022-04-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="502d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用CloudWatch设置扩展策略</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/58968bca1ce442ed780e727fe412db3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uLIV2nXU1BAd7ydU"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@tateisimikito?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Jukan Tateisi </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="0d9d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个项目的目标是创建一个具有自动缩放组的VPC。我将在两个实例上安装apache，并在CPU利用率超过40%后使用CloudWatch进行扩展。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="b82f" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated"><strong class="ak">先决条件:</strong></h2><ul class=""><li id="f6a3" class="mv mw it lb b lc mx lf my li mz lm na lq nb lu nc nd ne nf bi translated">IAM用户的AWS帐户</li><li id="4f49" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">适当的IAM权限</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="7c79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们将创建一个cidr为10.10.0.0/16的VPC。使用以下命令:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="12ff" class="mc md it nm b gy nq nr l ns nt">aws ec2 create-vpc --cidr-block <strong class="nm iu"><em class="nu">10.10.0.0/16</em></strong></span></pre><p id="fcc8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您的屏幕应该是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/70be7a37b03230919c9a64bec346dc39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*t-7W0qQDYblcD45GqZlSsw.png"/></div></figure><p id="9ea4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保复制下VpcId。我个人在Windows上使用记事本应用程序，并将ID存储在那里以备后用。如你所见，我的VPC ID是<code class="fe nw nx ny nm b">vpc-081aa807895d15ecb</code></p><p id="e16b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将为VPC创建子网。</p><p id="41a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我使用以下网站来确定子网地址:</p><div class="nz oa gp gr ob oc"><a href="https://www.site24x7.com/tools/ipv4-subnetcalculator.html" rel="noopener  ugc nofollow" target="_blank"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd iu gy z fp oh fr fs oi fu fw is bi translated">IPv4的IP子网计算器|在线子网掩码计算器-24x7站点</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">子网划分有时会出现网络变得太大而难以管理，性能指数创历史新低的情况…</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">www.site24x7.com</p></div></div></div></a></div><p id="f6fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里是我的cidr块和16个子网的结果，这将允许4091个IP地址。子网掩码/20就足够了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/5ceeb42116a8f32b8d1b343197c36fe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FKlFinnL5w_PynQBk--19A.png"/></div></div></figure><p id="1c12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将使用前两个子网id创建两个公共子网。为此，请使用以下命令:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="b844" class="mc md it nm b gy nq nr l ns nt">aws ec2 create-subnet --vpc-id <strong class="nm iu"><em class="nu">vpc-081aa807895d15ecb</em></strong> --cidr-block <strong class="nm iu"><em class="nu">10.10.0.0/20</em></strong></span></pre><p id="d451" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您输入上面的命令后，您的屏幕将看起来像这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/05ca473a1d3540b10194cc8a2292b5e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6xgQYmAnR1-8SQnyylZ6hg.png"/></div></div></figure><p id="143f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">复制您的子网Id。重复该命令，但确保指定不同的可用性区域。我的第一个子网位于AZ us-east-1a，因此对于我的下一个子网，我将把它放在us-east-1b。请注意，我使用的是第二个子网ID中的地址</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="7d09" class="mc md it nm b gy nq nr l ns nt">aws ec2 create-subnet --vpc-id <strong class="nm iu"><em class="nu">vpc-081aa807895d15ecb</em></strong> --cidr-block <strong class="nm iu"><em class="nu">10.10.16.0/20</em></strong> --availability-zone <strong class="nm iu"><em class="nu">us-east-1b</em></strong></span></pre><p id="a0e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，您可以通过键入以下命令来列出子网:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="4ef4" class="mc md it nm b gy nq nr l ns nt">aws ec2 describe-subnets --filters "Name=vpc-id,Values=<strong class="nm iu"><em class="nu">vpc-081aa807895d15ecb</em></strong>"</span></pre><p id="dcec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该会看到关于您创建的两个子网的信息。确保记下两个子网id。</p><p id="9fee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将必须修改子网属性，以便所有进入我们子网的实例都被分配一个公共IPv4地址。对每个子网使用以下命令:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="3ac0" class="mc md it nm b gy nq nr l ns nt">aws ec2 modify-subnet-attribute --subnet-id <strong class="nm iu"><em class="nu">subnet-007be26e340495888</em></strong> --map-public-ip-on-launch</span></pre><p id="4762" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦为两个子网都完成了这一步，就可以再次描述子网，并注意输出显示“MapPublicIpOnLaunch”:true</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="6ab5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，让我们为VPC连接一个互联网网关。首先，我们必须创建一个互联网网关。在CLI中，键入:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="c27f" class="mc md it nm b gy nq nr l ns nt">aws ec2 create-internet-gateway</span></pre><p id="004b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输出应该如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/212b30988454b88364442c3b2d0fc4c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:856/format:webp/1*7QmxSwFYJLyv0a4iTOYjnw.png"/></div></figure><p id="0330" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">复制InternetGatewayId，并在下一个命令中使用它将网关连接到您的VPC。</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="fe4a" class="mc md it nm b gy nq nr l ns nt">aws ec2 attach-internet-gateway --vpc-id <strong class="nm iu"><em class="nu">vpc-081aa807895d15ecb</em></strong> --internet-gateway-id <strong class="nm iu"><em class="nu">igw-0cfc4b3e94995400e</em></strong></span></pre><p id="2487" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您的屏幕不应有任何输出，这表明Internet网关已成功连接到VPC。要查看附件，请使用您的网关ID输入以下命令:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="ef73" class="mc md it nm b gy nq nr l ns nt">aws ec2 describe-internet-gateways --internet-gateway-ids <strong class="nm iu"><em class="nu">igw-0cfc4b3e94995400e</em></strong></span></pre><p id="825e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该看到您的网关已连接到您的VPC</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/a0b8e7be73ca45b53fb70819a7ec1193.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*DZNGw1z5ys1Repea79qP6w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">附上</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="d927" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们创建子网时，AWS会自动将其与VPC的默认路由表相关联。让我们来描述这个路由表:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="0454" class="mc md it nm b gy nq nr l ns nt">aws ec2 describe-route-tables --filters "Name=vpc-id,Values=<strong class="nm iu"><em class="nu">vpc-081aa807895d15ecb</em></strong>"</span></pre><p id="2f88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保记下RouteTableID:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/f28946413825cb3a10f169a4afc8c203.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JRx06dQX7h-QmXXdqGHr6Q.png"/></div></div></figure><p id="fe32" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">主路由表不包含到internet网关的路由。我们需要创建一个自定义路由表，其中包含将出站流量发送到internet网关的路由。</p><p id="b305" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要为IPv4流量创建自定义路由表，请输入以下命令:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="533f" class="mc md it nm b gy nq nr l ns nt">aws ec2 create-route --route-table-id <strong class="nm iu"><em class="nu">rtb-07ca16e6a996bd002</em></strong> --destination-cidr-block <strong class="nm iu"><em class="nu">0.0.0.0/0</em></strong> --gateway-id <strong class="nm iu"><em class="nu">igw-0cfc4b3e94995400e</em></strong></span></pre><p id="3142" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该会收到以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/f565af4fe84b05e17284ce9ec65e237a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/1*8C0ONK2aJyRiD2pJ-ExPTA.png"/></div></figure><p id="c0cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们再次描述路由表，以确保我们的新路由是关联的:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="e5bd" class="mc md it nm b gy nq nr l ns nt">aws ec2 describe-route-tables --route-table-id <strong class="nm iu"><em class="nu">rtb-07ca16e6a996bd002</em></strong></span></pre><p id="d2f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在输出中，您将看到CreateRoute处于活动状态:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi or"><img src="../Images/1977b554cfda5e175f91c2d5f0e90cc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:950/format:webp/1*Ee6dpvkdqBBCnizmKQjwew.png"/></div></figure><p id="ca1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个子网必须与一个路由表相关联。子网隐式地与VPC的主路由表相关联。我们创建的两个子网都与路由表相关联。要在CLI中查看，请尝试以下命令:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="f8f6" class="mc md it nm b gy nq nr l ns nt">aws ec2 associate-route-table --subnet-id <strong class="nm iu"><em class="nu">subnet-007be26e340495888</em></strong> --route-table-id <strong class="nm iu"><em class="nu">rtb-07ca16e6a996bd002</em></strong></span></pre><p id="3e50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我对每个子网运行了两次上述命令，收到的输出如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi os"><img src="../Images/0c4dad00003be270ed42580070778d8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-A-Rgs5ToINxgOPJt7ogdQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">与路由表相关联的子网</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="a638" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们将创建一个新的安全组，并添加允许来自互联网的入站流量的规则。然后，您可以将该安全组与公共子网中的实例相关联。</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="d6fe" class="mc md it nm b gy nq nr l ns nt">aws ec2 create-security-group --group-name <strong class="nm iu"><em class="nu">vpc-sg-traffic</em></strong> --description "<strong class="nm iu"><em class="nu">VPC SG Traffic</em></strong>" --vpc-id <strong class="nm iu"><em class="nu">vpc-081aa807895d15ecb</em></strong></span></pre><p id="726c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">记下您从上述命令的输出中看到的GroupId。</p><p id="d8ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们需要向安全组添加规则，以允许传入流量。</p><p id="b0d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下命令将添加一个安全ID组为<strong class="lb iu"> <em class="nu"> sg-00d5f5f589f2a3bce的HTTP(端口80)访问规则。</em> </strong>允许所有人访问:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="6271" class="mc md it nm b gy nq nr l ns nt">aws ec2 authorize-security-group-ingress --group-id <strong class="nm iu"><em class="nu">sg-00d5f5f589f2a3bce</em></strong> --protocol tcp --port 80 --cidr 0.0.0.0/0</span></pre><p id="c957" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要允许端口22上的所有入站流量，请对同一安全组中的实例启用SSH:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="0785" class="mc md it nm b gy nq nr l ns nt">aws ec2 authorize-security-group-ingress --group-id <strong class="nm iu"><em class="nu">sg-00d5f5f589f2a3bce</em></strong> --protocol tcp --port 22 --cidr 0.0.0.0/0</span></pre><p id="8ea4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在CLI中查看您的安全组的更改，您可以运行以下命令:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="a383" class="mc md it nm b gy nq nr l ns nt">aws ec2 describe-security-groups --group-ids <strong class="nm iu"><em class="nu">sg-00d5f5f589f2a3bce</em></strong></span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="ad85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们将在实例上安装apache和AWS压力工具，所以我们将创建一个脚本来引导实例。使用以下文本进入vim或您选择的文本编辑器。在Windows中，您必须找到保存的脚本文件并复制路径，以便稍后启动EC2实例时使用。</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="c270" class="mc md it nm b gy nq nr l ns nt">#!/bin/bash<br/>sudo yum -y update<br/>sudo yum -y install httpd<br/>systemctl start httpd<br/>systemctl enable httpd<br/>amazon-linux-extras install epel -y<br/>yum install stress -y</span></pre><p id="f5b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将为自动扩展创建启动配置:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="b4be" class="mc md it nm b gy nq nr l ns nt">aws autoscaling create-launch-configuration --image-id <strong class="nm iu"><em class="nu">ami-0c02fb55956c7d316</em></strong> --instance-type <strong class="nm iu"><em class="nu">t2.micro</em></strong> --key-name <strong class="nm iu"><em class="nu">keypairweek7</em></strong> --security-groups <strong class="nm iu"><em class="nu">sg-00d5f5f589f2a3bce</em></strong> --user-data <strong class="nm iu"><em class="nu">file://"C:\Users\mjcdy\OneDrive\Documents\User Data\apache_stress.sh"</em></strong> --launch-configuration-name <strong class="nm iu"><em class="nu">lauchconfig</em></strong></span></pre><p id="9627" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我使用了现有的密钥对。我还使用了与us-east-1区域相关联的AMI。要找到合适的空闲层AMI，可以键入以下命令:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="fff8" class="mc md it nm b gy nq nr l ns nt">aws ec2 describe-images --owners amazon --filters "Name=name,Values=amzn2-ami-hvm-2.0.????????.?-x86_64-gp2" "Name=state,Values=available" --query "reverse(sort_by(Images, &amp;Name))[:1].ImageId" --region us-east-1 --output text</span></pre><p id="38c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建启动配置后，您可以查看描述:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="1717" class="mc md it nm b gy nq nr l ns nt">aws autoscaling describe-launch-configurations</span></pre><p id="b50c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们可以创建一个自动缩放组:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="c5fe" class="mc md it nm b gy nq nr l ns nt">aws autoscaling create-auto-scaling-group --auto-scaling-group-name <strong class="nm iu"><em class="nu">autoscaling</em></strong> --availability-zones <strong class="nm iu"><em class="nu">us-east-1a us-east-1b</em></strong> --vpc-zone-identifier <strong class="nm iu"><em class="nu">"subnet-007be26e340495888, subnet-05dd76f3530bd0a82"</em></strong> --launch-configuration-name <strong class="nm iu"><em class="nu">lauchconfig</em></strong> --max-size <strong class="nm iu"><em class="nu">5</em></strong> --min-size <strong class="nm iu"><em class="nu">2</em></strong></span></pre><ul class=""><li id="dc52" class="mv mw it lb b lc ld lf lg li ot lm ou lq ov lu nc nd ne nf bi translated">如果您可能注意到了，我将我的启动配置命名为“lauchconfig”确保在创建自动缩放组时使用相同的拼写，否则您将收到一个错误。</li><li id="5f45" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">另外，第一次运行这个命令时，我没有使用vpc-zone-identifier。我的实例不会启动，因为我没有指定要利用哪些子网。</li></ul><p id="1c2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您创建了自动缩放组之后，您将需要启用指标收集，以便您可以使用CloudWatch来监控您的实例。使用以下命令:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="2888" class="mc md it nm b gy nq nr l ns nt">aws autoscaling enable-metrics-collection --auto-scaling-group-name <strong class="nm iu"><em class="nu">autoscaling</em></strong> --granularity <strong class="nm iu"><em class="nu">"1Minute"</em></strong></span></pre><p id="91c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们需要应用一个目标跟踪伸缩策略，告诉Amazon EC2 Auto Scaling在应用程序的负载发生变化时动态地改变组中正在运行的EC2实例的数量。下面的JSON文件是一个目标跟踪配置，它将平均CPU利用率设置为40%。保存这个文件，并确保复制路径，因为我们将在下一个命令中使用它。</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="65f9" class="mc md it nm b gy nq nr l ns nt">{<br/>  "TargetValue": 40.0,<br/>  "PredefinedMetricSpecification": <br/>    {<br/>      "PredefinedMetricType": "ASGAverageCPUUtilization"<br/>    }<br/>}</span></pre><p id="6186" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您要运行来添加扩展策略的命令是:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="3eb9" class="mc md it nm b gy nq nr l ns nt">aws autoscaling put-scaling-policy --auto-scaling-group-name <strong class="nm iu"><em class="nu">autoscaling</em></strong> --policy-name <strong class="nm iu"><em class="nu">cpu40-target-tracking-scaling-policy</em></strong> --policy-type <strong class="nm iu"><em class="nu">TargetTrackingScaling</em></strong> --estimated-instance-warmup <strong class="nm iu"><em class="nu">60</em></strong> --target-tracking-configuration <strong class="nm iu"><em class="nu">file://"C:\Users\mjcdy\OneDrive\Documents\cpuutilization.json"</em></strong></span></pre><p id="bf25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您看到的屏幕看起来会像这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/0d65978762d45e6aa12361b284f3b708.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JbxcwJqFve46pfRT98obDw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">警报已创建</p></figure><p id="d44d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以使用以下命令查看实例是否已经启动:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="d8d6" class="mc md it nm b gy nq nr l ns nt">aws autoscaling describe-auto-scaling-groups --auto-scaling-group-name <strong class="nm iu"><em class="nu">autoscaling</em></strong></span></pre><p id="5726" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，您可以检查Apache服务器是否已安装并激活，从每个实例中复制您的公共IPv4地址，通过键入以下命令可以找到该地址:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="2484" class="mc md it nm b gy nq nr l ns nt">aws ec2 describe-instances --query "Reservations[*].Instances[*].PublicIpAddress" --output=text</span></pre><p id="7ac4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，在地址栏中键入以下内容:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="8585" class="mc md it nm b gy nq nr l ns nt">http://<strong class="nm iu"><em class="nu">public_ip_address</em></strong></span></pre><p id="55b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您看到这样的屏幕，那么您的Apache web服务器已经启动并正在运行:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/74e2d5946064adae44cb1887550a3331.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KhYrkYqEhZ5o7qdRYFpvxA.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="34fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后…</p><p id="7a83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将进入AWS控制台。前往CloudWatch，您应该会发现我们之前使用自动缩放put-scaling-policy创建的警报:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/e21c41e9f8fbb7ff5d8c29cbad2983ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*29VmA3bqTz6TlJYMVIJ0tw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我之前做了一些压力测试，然后重新初始化了警报</p></figure><ul class=""><li id="b88b" class="mv mw it lb b lc ld lf lg li ot lm ou lq ov lu nc nd ne nf bi translated">我曾尝试在CPU利用率超过80%后，使用CloudWatch运行扩展策略进行扩展。这不起作用，因为我的自动缩放策略适用于2个实例。每个实例的CPU利用率只能达到50%。</li></ul><p id="5600" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SSH到您的一个实例中:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="efc5" class="mc md it nm b gy nq nr l ns nt">ssh -i "C:\Users\mjcdy\OneDrive\Documents\KeyPair\keypairweek7.pem" ec2-user@<strong class="nm iu"><em class="nu">public_ip_address</em></strong></span></pre><p id="72e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Windows中，确保使用密钥对的文件路径。</p><p id="6443" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们进行一次压力测试！</p><p id="aa93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在EC2实例中，输入命令:</p><pre class="kj kk kl km gt nl nm nn no aw np bi"><span id="5094" class="mc md it nm b gy nq nr l ns nt">sudo stress --cpu 1 --timeout 300</span></pre><p id="f793" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在AWS控制台中，您应该看到CloudWatch警报在几分钟后响起，一个新的EC2实例启动，并且您的自动缩放组中的实例增加。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/eedaa43aa2555611bf1e11b6eb8009e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lhKg386XuXn2CoTQO5ONmQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">超过阈值</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pa"><img src="../Images/3389e2de85a6868c0cc10e03f47e7511.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kLbd1LWHSh-I-uQg3dMP9w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">结果创建了第三个实例</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/a8647d45d347a5669622aa5712d9b0ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UThinFm4FsjLuMjYPK2DrQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">3个实例而不是2个</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/473e6a0d5ef6f2509afd59fd8de844d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5N2wCnpXzyjVEOGn_dnakQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">自动缩放已执行</p></figure><p id="db26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你已经走了这么远，恭喜你。记住终止任何可能产生额外费用的资源！感谢您的阅读。</p></div></div>    
</body>
</html>