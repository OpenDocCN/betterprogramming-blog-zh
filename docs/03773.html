<html>
<head>
<title>Optimizing Queries in Your SQL Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">优化SQL Server中的查询</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/optimizing-queries-in-your-sql-server-b8f13082fde5?source=collection_archive---------24-----------------------#2020-03-03">https://betterprogramming.pub/optimizing-queries-in-your-sql-server-b8f13082fde5?source=collection_archive---------24-----------------------#2020-03-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2570" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">调查执行计划</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/40472e9ca3d751d76392ae7c2264e93c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*e2MpK7fHvZ5e-rQC"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kv" href="https://unsplash.com/@helloquence?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Helloquence </a>拍摄的照片</p></figure><p id="11f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇文章概述了我们在检查执行计划时需要知道的基本知识。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="a296" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">介绍</h1><p id="78f6" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">您是否曾经在指出性能瓶颈时不得不优化SQL查询？</p><p id="7e82" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这种情况下，SQL Server为您提供的执行计划就派上了用场，您最好能够正确地解释它，因为它显示了许多关于查询优化器如何执行查询等的重要信息。</p><p id="9c0e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一个查询声明性地指定了我们需要检索什么数据，但是步骤是什么取决于查询处理器。因此，查询计划(或者还有<em class="mw">执行计划</em>)向我们揭示了SQL Server是如何决定检索我们所请求的数据的。</p><p id="8973" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一个常见的误解是，SQL Server选择了最佳计划，而实际上它选择了一个“足够好”的计划，因为可能有许多可能的序列，执行所有这些序列可能会花费太多时间。</p><p id="2e32" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将讨论执行计划中显示的主要操作符，以及在研究它时需要记住的一些要点。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="0b92" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">什么是执行计划，在哪里可以找到？</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/1c3f83cfd76126b00bd95edcfca589bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/format:webp/1*nnzbJbqehYI0UegZ5G-BDg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">一个非常基本的执行计划如下所示</p></figure><p id="1c8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有两种类型的执行计划—估计的和实际的。</p><p id="df30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第一个是在不执行T-SQL查询的情况下生成的，因此不包含运行时信息。您可以通过点击特定查询上的<em class="mw">显示预计执行计划</em> <strong class="ky ir"> </strong>工具栏按钮来显示。</p><p id="de3c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">实际的执行计划是在执行T-SQL查询之后生成的，并且包含运行时信息，例如实际的资源使用度量和运行时警告(如果有)。点击<em class="mw">包含实际执行计划</em> <strong class="ky ir"> </strong>工具栏按钮即可显示。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="361c" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">经营者</h1><p id="e53a" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">让我们来看看您可能在执行计划中看到的一些操作符:</p><ul class=""><li id="91c2" class="my mz iq ky b kz la lc ld lf na lj nb ln nc lr nd ne nf ng bi translated">索引扫描—索引扫描意味着SQL Server读取表中的所有行，然后返回满足搜索条件的行。当表很小或者大多数行符合谓词条件时，这是一种有效的策略。</li><li id="8ca9" class="my mz iq ky b kz nh lc ni lf nj lj nk ln nl lr nd ne nf ng bi translated">索引查找—另一方面，索引查找意味着它只接触包含这些合格行的行。因此，在只返回一小部分记录的情况下，这是最有益的。</li><li id="ca14" class="my mz iq ky b kz nh lc ni lf nj lj nk ln nl lr nd ne nf ng bi translated">排序——这是你能做的最昂贵的操作之一，所以应该尽可能避免。对列进行索引是减少使用该操作符的需要的方法之一。</li><li id="5206" class="my mz iq ky b kz nh lc ni lf nj lj nk ln nl lr nd ne nf ng bi translated">哈希连接-哈希连接是开销最大的连接操作之一，因为它需要哈希表来执行连接。这是最适合大型未排序输入的连接。它首先读取其中一个输入并对连接列进行哈希运算，然后将结果哈希和列值放入内存中构建的哈希表中。然后，它读取第二个输入中的所有行，对这些行进行哈希处理，并检查结果哈希桶中的行，以查找连接的行。</li><li id="2578" class="my mz iq ky b kz nh lc ni lf nj lj nk ln nl lr nd ne nf ng bi translated">嵌套循环-通过循环一个输入的所有行，并针对每一行循环第二个输入的所有行来查找匹配项。</li><li id="00b1" class="my mz iq ky b kz nh lc ni lf nj lj nk ln nl lr nd ne nf ng bi translated">合并连接-通过遍历两个输入、比较行并输出匹配行来工作。两个输入都必须在联接列上排序，这样联接才有可能。</li></ul><p id="a693" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当然，这份清单绝非详尽无遗。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="b3d0" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">我们实际上如何阅读执行计划？</h1><p id="34b4" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们从查看右上角的操作符开始解释这个计划，然后沿着箭头的方向向左看。</p><p id="61d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运算符之间的箭头代表数据的流向。它们也有不同的厚度——它们越厚，运算符之间读取的行数就越多。</p><p id="b0d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在每个经营者的下面，显示了该经营者相对于所有其他经营者的成本百分比。这些相对成本有时可以帮助您确定性能瓶颈在哪里。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/9c6af4c8f8ed8b17707082ce49fcf4d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:448/format:webp/1*NmDdhEwNpqbdZgn-5qghOA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">示例运算符及其成本百分比。</p></figure><p id="94f1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您还可以通过将鼠标悬停在任何操作员图标或任何箭头上来检查<em class="mw">估计行数</em>和<em class="mw">实际行数</em>。</p><p id="6de5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一件需要注意的事情是有时出现在操作员右下角的警告标志。它们表明操作员中有警告。悬停时我们可以了解更多信息。</p><p id="a9a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最常见的警告之一是操作员向<code class="fe nn no np nq b">tempdb</code>泄漏数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/dffdffa175e5ff7a34ed76fd72842b92.png" data-original-src="https://miro.medium.com/v2/resize:fit:544/format:webp/1*2u7kCq_R1K93SqArQj_KvA.png"/></div></figure><p id="cb59" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常，原因是估计的行数和实际的行数之间有很大的差异。</p><p id="a512" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当估计值太低时，查询优化器分配的内存会比需要的少，这会导致向<code class="fe nn no np nq b">tempdb</code>写入数据，这显然会更慢。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="48e0" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="53f9" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">在本文中，我们介绍了SQL Server中执行计划的基础知识——如何找到它们、一些操作符以及如何解释它们。当然，这个主题比我们在这里讨论的要深刻得多。</p><p id="8a18" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果有任何不准确或您有任何问题，请不要犹豫评论。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="5832" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">资源</h1><ol class=""><li id="c0bb" class="my mz iq ky b kz mr lc ms lf ns lj nt ln nu lr nv ne nf ng bi translated"><a class="ae kv" href="https://docs.microsoft.com/en-us/sql/relational-databases/performance/display-an-actual-execution-plan?view=sql-server-ver15" rel="noopener ugc nofollow" target="_blank">显示实际执行计划</a></li><li id="4b60" class="my mz iq ky b kz nh lc ni lf nj lj nk ln nl lr nv ne nf ng bi translated"><a class="ae kv" href="https://bertwagner.com/2019/08/06/5-things-you-need-to-know-when-reading-sql-server-execution-plans/" rel="noopener ugc nofollow" target="_blank">阅读执行计划时要知道的5件事</a></li><li id="de07" class="my mz iq ky b kz nh lc ni lf nj lj nk ln nl lr nv ne nf ng bi translated"><a class="ae kv" href="https://blog.sqlauthority.com/2007/03/30/sql-server-index-seek-vs-index-scan-table-scan/" rel="noopener ugc nofollow" target="_blank"> SQLAuthority </a></li></ol></div></div>    
</body>
</html>