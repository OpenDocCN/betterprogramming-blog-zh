<html>
<head>
<title>Angular: Keeping the User from Losing Data by Leaving the Page Before Submit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">角度:通过在提交前离开页面来防止用户丢失数据</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/angular-how-keep-user-from-lost-his-data-by-accidentally-leaving-the-page-before-submit-4eeb74420f0d?source=collection_archive---------0-----------------------#2017-12-13">https://betterprogramming.pub/angular-how-keep-user-from-lost-his-data-by-accidentally-leaving-the-page-before-submit-4eeb74420f0d?source=collection_archive---------0-----------------------#2017-12-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/702385e762cd457a21e0aac9003bffaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OFRGP4jrkR0i9ODcI1Eaow.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">由<a class="ae kf" href="https://unsplash.com/@headwayio?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">车头时距</a>在<a class="ae kf" href="https://unsplash.com/search/photos/website-form?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">挡泥板</a>上拍摄</p></figure><p id="ea6d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当用户在表单中填写了许多详细信息，然后单击back，或者关闭/刷新选项卡时，我们希望警告用户页面上有未保存的数据。</p><p id="d4e1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们希望用户只有同意下面的消息才能离开。</p><p id="4fad" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该消息将如下所示:</p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div class="gh gi le"><img src="../Images/4480d8f2a37b85890d3a9f8c9dcbb36c.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/format:webp/1*ACnHuS1NNhzHo_GGLRKkRQ.png"/></div></figure></div><div class="ab cl lj lk hx ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="im in io ip iq"><h1 id="4ace" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">如何让它工作</h1><p id="5577" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们需要把这个问题分解一下。当用户关闭或刷新选项卡时。<br/> 2。当导航改变时(用户点击后退或前进)。</p><p id="d054" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Angular有两种不同的处理方式:</p><h2 id="773e" class="mt lr it bd ls mu mv dn lw mw mx dp ma kr my mz me kv na nb mi kz nc nd mm ne bi translated">1.处理选项卡关闭/刷新事件</h2><p id="633a" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">如果用户有未保存的数据，我们需要注册<code class="fe nf ng nh ni b">window:beforeunload</code>并显示一条消息。(在大多数浏览器中，你不能改变显示的信息。)</p><p id="4c0c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如:</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h2 id="b874" class="mt lr it bd ls mu mv dn lw mw mx dp ma kr my mz me kv na nb mi kz nc nd mm ne bi translated">2.处理导航更改事件</h2><p id="1339" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们需要实现一个<em class="nl">可以停用</em>的守卫。</p><p id="23c1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要做到这一点，有三个步骤:</p><ol class=""><li id="cbf4" class="nm nn it ki b kj kk kn ko kr no kv np kz nq ld nr ns nt nu bi translated">实现<code class="fe nf ng nh ni b">CanDeactivate</code>接口(<a class="ae kf" href="https://angular.io/" rel="noopener ugc nofollow" target="_blank">角度</a>接口):</li></ol><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="16f0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们必须实现方法<code class="fe nf ng nh ni b">canDeactivate</code>，它获取组件实例并返回一个<code class="fe nf ng nh ni b">true</code>或<code class="fe nf ng nh ni b">false</code>。</p><p id="a5e3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本例中，如果弹出消息并且用户确认，将返回<code class="fe nf ng nh ni b">true</code>。否则，路由不会改变。</p><p id="1a8a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">2.将<code class="fe nf ng nh ni b">CanDeactivateGuard</code>添加到<code class="fe nf ng nh ni b">ngModule</code>提供程序中。</p><p id="305a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">3.将<code class="fe nf ng nh ni b">CanDeactivateGuard</code>添加到路由配置:</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="nj nk l"/></div></figure><h1 id="6822" class="lq lr it bd ls lt nv lv lw lx nw lz ma mb nx md me mf ny mh mi mj nz ml mm mn bi translated">实现确认对话框的一般方法</h1><p id="2824" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">我们看到，我们需要为每个组件提供许多不同的东西，我们需要为导航改变和标签关闭/刷新提供不同的实现。</p><p id="8c58" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要一种通用的方法来实现所有导航案例和所有基于表单的组件的确认对话框。</p><p id="1487" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，当我需要创建一个新的表单组件时，事情将开箱即用，无需考虑和了解上述任何事情。</p></div><div class="ab cl lj lk hx ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="im in io ip iq"><h1 id="a29e" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">我们开始吧</h1><ol class=""><li id="1fc8" class="nm nn it ki b kj mo kn mp kr oa kv ob kz oc ld nr ns nt nu bi translated">让我们创建一个通用类<code class="fe nf ng nh ni b">ComponentCanDeactivate</code>，它将监听浏览器<code class="fe nf ng nh ni b">window:beforeunload</code>，并具有抽象API: <br/> <code class="fe nf ng nh ni b">abstract canDeactivate():boolean;</code></li></ol><p id="5ea2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">像这样:</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="ec73" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">2.为任何表单组件添加通用实现:</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="439d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">基本上，在任何形式中，数据在两种情况下可以不保存:</p><ol class=""><li id="15dc" class="nm nn it ki b kj kk kn ko kr no kv np kz nq ld nr ns nt nu bi translated">当形式还没有<code class="fe nf ng nh ni b">submitted </code>的时候。</li><li id="f376" class="nm nn it ki b kj od kn oe kr of kv og kz oh ld nr ns nt nu bi translated">肯定是<code class="fe nf ng nh ni b">dirty</code>。(如果用户只是打开表单并立即离开，我们不希望该消息出现。)</li></ol><p id="4ff0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所以，<code class="fe nf ng nh ni b">canDeactivate</code>检查的只是这两个条件。</p><p id="91d4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意，我对表单进行了抽象<code class="fe nf ng nh ni b">getter</code>。任何组件都需要实现它并返回它的形式。</p><p id="833c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是任何表单组件在所有导航情况下获得警告消息所需要做的唯一事情。</p><p id="b6d6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">3.实施<code class="fe nf ng nh ni b">CanDeactivateGuard</code>，但对于通用组件:</p><figure class="lf lg lh li gt ju"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="444d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">4.将<code class="fe nf ng nh ni b">CanDeactivateGuard</code>添加到路由配置中。和以前一样，我们仍然需要为每个组件指定保护。</p><p id="b2d1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我的表单组件现在要干净得多；它只有一个<code class="fe nf ng nh ni b">form</code>字段:</p><pre class="lf lg lh li gt oi ni oj ok aw ol bi"><span id="baae" class="mt lr it ni b gy om on l oo op">@ViewChild(‘form’)<br/>form: NgForm;</span></pre></div><div class="ab cl lj lk hx ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="im in io ip iq"><h1 id="2ca5" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">包裹</h1><p id="45e1" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">为了防止用户由于Angular应用程序或浏览器级别的导航改变(如关闭/刷新)而丢失数据，我们需要创建一个通用组件来处理任何表单组件。</p><p id="23e0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个抽象组件将被注册到浏览器事件中，angular guard将调用它的API: <code class="fe nf ng nh ni b">canDeactivate</code>。它将返回数据未保存时，该表单实际上是离开，没有提交和肮脏的。</p><p id="f578" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，任何实现的组件都只需要扩展抽象组件并设置其表单实例，仅此而已。</p></div><div class="ab cl lj lk hx ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="im in io ip iq"><h1 id="ba50" class="lq lr it bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">代码示例和消息检查</h1><p id="feee" class="pw-post-body-paragraph kg kh it ki b kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ms lb lc ld im bi translated">这里有一个<a class="ae kf" href="https://stackblitz.com/edit/angular-rgsa51" rel="noopener ugc nofollow" target="_blank">的完整代码示例</a></p><p id="5d14" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">检查消息:</p><ul class=""><li id="8ba6" class="nm nn it ki b kj kk kn ko kr no kv np kz nq ld oq ns nt nu bi translated">点击<code class="fe nf ng nh ni b">add new user</code>链接。</li><li id="d508" class="nm nn it ki b kj od kn oe kr of kv og kz oh ld oq ns nt nu bi translated">在新用户表单中，填写名称，但不要单击提交。</li><li id="2261" class="nm nn it ki b kj od kn oe kr of kv og kz oh ld oq ns nt nu bi translated">单击返回:将出现一条消息。</li><li id="ae6d" class="nm nn it ki b kj od kn oe kr of kv og kz oh ld oq ns nt nu bi translated">在不填写姓名的情况下尝试同样的操作:消息不会出现，因为没有变化。当您填写名称并单击提交时，情况也是如此。</li></ul><p id="37ac" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢阅读！</p></div></div>    
</body>
</html>