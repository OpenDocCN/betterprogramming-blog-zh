<html>
<head>
<title>Build a Login System in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Node.js中构建一个登录系统</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-login-system-in-node-js-f1ba2abd19a?source=collection_archive---------0-----------------------#2020-07-20">https://betterprogramming.pub/build-a-login-system-in-node-js-f1ba2abd19a?source=collection_archive---------0-----------------------#2020-07-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f204" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何在您的节点应用程序中使用Passport.js进行用户验证</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5fb33fb8f43a55ab119f3969341c77b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4liXAK1EfzU2OZfa6W9JOQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@fredmarriage?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">弗雷迪婚姻</a>在<a class="ae ky" href="https://unsplash.com/s/photos/gate?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="757e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你是一个极受欢迎的天才网络开发人员。一次又一次，你证明了自己有能力构建极其复杂的应用程序并取得巨大成功。</p><p id="5721" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">先说个例子。当地一所学校希望学生能直接从应用程序上查看他们的学业进展和家庭作业。由于你热情洋溢的推荐，学校自然会雇用你。这些是他们的要求:</p><ul class=""><li id="a60f" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">学生首先使用他们的电子邮件和所需的凭据登录应用程序。如果找不到现有帐户，系统会提示他们创建一个帐户。</li><li id="f10f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">如果找到一个现有的帐户，学生现在可以查看他们的学业进展和家庭作业。</li><li id="f01f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">还提供了一个注销选项，如果学生使用公共计算机，他们可以从应用程序中注销。</li><li id="96c6" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">除非学生登录，否则他们无法访问仪表板。</li></ul><p id="2ba2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本教程将集中在网站的登录和注销系统部分。这称为用户认证。如果您使用JavaScript，名为<a class="ae ky" href="http://www.passportjs.org/" rel="noopener ugc nofollow" target="_blank"> Passport.js </a>的库可以用于用户认证。Passport.js本质上是Node.Js中用于认证的中间件。</p><p id="6456" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是您的目标，因为它符合客户的要求:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/31261753a4219aede5b977d914d094f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/1*2p73RPFc3BffEvrO9XTfnA.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">本教程的目标是</p></figure></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="0fb9" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">开始</h1><p id="0a4b" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在键入任何代码之前，首先安装以下模块:</p><ul class=""><li id="e893" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe no np nq nr b">express</code>用于处理您的路线</li><li id="0d47" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">express-session</code>用于建立用户会话</li><li id="840e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">express-ejs-layouts</code>支持<code class="fe no np nq nr b">ejs</code>在快递中的布局</li><li id="65b0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">connect-flash</code>将用于显示flash消息。稍后我们将对此进行详细介绍。</li><li id="7787" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">passport</code>处理用户认证</li><li id="05ed" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">passport-local</code>，这是一种带有用户名和密码的策略(认证机制)</li><li id="fcac" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">mongoose </code>用于在数据库中存储用户</li><li id="8030" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">bcrypt</code>用于在将密码存储到数据库之前对其进行加密。出于明显的安全原因，绝对不要以纯文本形式存储密码。</li><li id="5c93" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">ejs</code>模块将数据从Express发送到<code class="fe no np nq nr b">ejs</code>文件</li></ul><p id="bb9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是您应该运行的命令:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="d3eb" class="nw ms it nr b gy nx ny l nz oa">npm i express express-session express-ejs-layouts connect-flash passport passport-local mongoose bcrypt ejs</span></pre><p id="f0f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，按照下面列出的初始阶段的进一步步骤。</p><h2 id="6e46" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">index.js路线</h2><p id="a8d7" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在项目目录中创建一个名为<code class="fe no np nq nr b">route</code>的文件夹。在这里，创建一个名为<code class="fe no np nq nr b">index.js</code>的JavaScript文件。最终，<code class="fe no np nq nr b">index.js</code>T32的位置会在<code class="fe no np nq nr b">routes/index.js</code>。</p><p id="fb36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe no np nq nr b">routes/index.js,</code>中编写以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><ul class=""><li id="d4de" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe no np nq nr b">line 4</code>:当用户导航到<code class="fe no np nq nr b">root </code>目录(执行<code class="fe no np nq nr b">GET </code>请求)时，呈现<code class="fe no np nq nr b">welcome.ejs</code>页面。</li><li id="aabe" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">line 8</code>:当用户对<code class="fe no np nq nr b">register</code>页面做<code class="fe no np nq nr b">GET</code>请求时，渲染<code class="fe no np nq nr b">register.ejs</code>页面。</li><li id="d8e1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">line 12</code>:导出路由器实例，以便在其他文件中使用。</li></ul><h2 id="5f3a" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">users.js路线</h2><p id="ce49" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">转到您的<code class="fe no np nq nr b">routes</code>文件夹，创建一个名为<code class="fe no np nq nr b">users.js</code>的文件，这样<code class="fe no np nq nr b">users.js</code>的位置就是<code class="fe no np nq nr b">routes/users.js</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="6df9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe no np nq nr b">routes/users.js</code>中，</p><ul class=""><li id="9c87" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe no np nq nr b">Lines 5 to 9</code>:处理各自的<code class="fe no np nq nr b">GET </code>请求并呈现适当的页面</li><li id="3e07" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">Lines 12 to 14</code>:处理各自的<code class="fe no np nq nr b">POST </code>请求。它们将在本教程的后面部分进行填充。</li></ul><h2 id="b44c" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">app.js</h2><p id="6639" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">这将是您的主文件。在您的根目录中，创建一个名为<code class="fe no np nq nr b">app.js</code>的文件。在这里，编写以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><ul class=""><li id="5286" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe no np nq nr b">line 11</code>:告诉Express您将使用<code class="fe no np nq nr b">ejs</code>作为您的模板引擎</li></ul><p id="588c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在您已经定义了您的路线，让我们创建将呈现到屏幕上的<code class="fe no np nq nr b">ejs</code>文件。</p><p id="8023" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的根目录中创建一个<code class="fe no np nq nr b">views</code>文件夹，并编写以下文件。这些是标准的静态文件。你可以在<a class="ae ky" href="https://ejs.co" rel="noopener ugc nofollow" target="_blank"> EJS文档网站</a>中找到代码的解释。</p><h2 id="1a65" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">布局. ejs</h2><p id="8757" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在<code class="fe no np nq nr b">views/layout.ejs</code>中:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="9671" class="nw ms it nr b gy nx ny l nz oa">&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Node.Js and Passport App&lt;/title&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;%- body %&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><h2 id="79a7" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">注册. ejs</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><h2 id="5987" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">欢迎. ejs</h2><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="83c6" class="nw ms it nr b gy nx ny l nz oa">&lt;html&gt;<br/>&lt;h1&gt;Welcome!&lt;/h1&gt;<br/>&lt;p&gt;Create an account or login&lt;/p&gt;<br/>&lt;a href="/users/register"&gt;Register&lt;/a&gt;<br/>&lt;a href="/users/login"&gt; Login&lt;/a&gt;<br/>&lt;/html&gt;</span></pre><h2 id="f146" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">login.ejs</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="3a9d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:您已经为表单中的元素使用了<code class="fe no np nq nr b">name</code>属性，因为您将通过按名称识别每个元素来提取表单中的值。</p><p id="9bb5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要运行这段代码，请转到命令行来运行<code class="fe no np nq nr b">app.js</code>文件。</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="14ca" class="nw ms it nr b gy nx ny l nz oa">node app</span></pre><p id="6147" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到<code class="fe no np nq nr b">localhost:3000</code>，您会发现您的输出与此相同:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/c323f3d78231c2fce93b860b5d5c1041.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/1*Z4bjnXB0VlJjxt7zBgkhHg.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">显示每条相应路线的代码输出</p></figure><p id="d6d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你终于完成了你的开始阶段。现在是时候使用<a class="ae ky" href="https://mongoosejs.com/docs/" rel="noopener ugc nofollow" target="_blank">mongose</a>来保存数据库中的用户了。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="3894" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">将用户保存到数据库</h1><h2 id="90ed" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">用户模式和模型</h2><p id="87ea" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">通常，在创建文档并将其保存到数据库之前，必须定义一个模式。首先，创建<code class="fe no np nq nr b">models</code>目录，在那里创建一个名为<code class="fe no np nq nr b">user.js</code>的文件，这样它就是<code class="fe no np nq nr b">models/user.js</code>。首先，让我们在<code class="fe no np nq nr b">user.js</code>中创建一个模式。接下来，我们将从该模式中创建一个模型。</p><p id="0544" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe no np nq nr b">models/user.js</code>中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="50d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着您的模型将有一个名称、一个电子邮件、相关的密码和创建日期。</p><p id="bf36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe no np nq nr b">line 20</code>上，我们将在您的<code class="fe no np nq nr b">User</code>模型中使用该模式。您的所有用户都将拥有这种格式的数据。</p><h2 id="a5f2" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">处理对注册目录的POST请求:验证检查</h2><p id="e3f4" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在这一步中，您将使用客户机提供的数据在MongoDB数据库中创建一个文档。</p><p id="f456" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe no np nq nr b">routes/users.js</code>文件的开头，导入Mongoose库，并导入刚刚创建的<code class="fe no np nq nr b">User</code>模型。</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="9aec" class="nw ms it nr b gy nx ny l nz oa">const User = require("../models/user.js")</span></pre><p id="7073" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，在<code class="fe no np nq nr b">routes/users.js</code>文件中，找到下面这段代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/8765e427253ccc90b87d2ececf2097d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QEalBntKDxPSedPQsM6G0w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">处理注册发布请求</p></figure><p id="dbdf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在此句柄中，编写以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><ul class=""><li id="6be7" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe no np nq nr b">Line 1</code>:从表单的元素中提取值。你拿出邮件，用户名，密码。最后一个字段(<code class="fe no np nq nr b">password2</code>)是一个验证检查，确保用户已经确认他们输入的密码是正确的。</li><li id="dde3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">Lines 4-6</code>:如果有任何字段未填写，则向<code class="fe no np nq nr b">error</code>数组添加适当的信息。</li><li id="67e5" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">Lines 8–10</code>:如果密码不匹配，将适当的消息添加到<code class="fe no np nq nr b">error</code>数组。</li><li id="e2c8" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">Lines 13–15</code>:检查密码是否至少有六个字符。</li><li id="45dd" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">Lines 16–23</code>:如果<code class="fe no np nq nr b">error</code>数组中存在任何内容，重新呈现<code class="fe no np nq nr b">register.ejs</code>页面，然后将适当的数据与<code class="fe no np nq nr b">errors</code>数组一起发送。该数组的所有内容都将显示在页面上。</li><li id="ff5c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">Lines 24–36</code>:您已经成功通过验证！现在，您将首先通过电子邮件发现数据库中是否已经存在一个用户。如果有，那么您将重新呈现<code class="fe no np nq nr b">register.ejs</code>页面并显示相关错误。否则，使用提供的电子邮件、名称及其相关密码创建一个新用户。记住你还没有保存它。您将在加密密码后保存它。</li></ul><p id="badc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，让我们运行代码并输入一个单字符密码，以便重新呈现页面:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/de138f9411a83e1c7c0e6214f7c446ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/1*KvkHgTwEovsnas1u8BldZQ.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">故意输入错误选项后输出的代码</p></figure><p id="3c5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你现在需要显示错误，也就是显示<code class="fe no np nq nr b">errors</code>数组的内容。</p><h2 id="f425" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">显示错误</h2><p id="bfde" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">现在转到<code class="fe no np nq nr b">views/register.ejs</code>并找到下面这段代码(这将在文件的开头附近):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi op"><img src="../Images/6ca0daf9df50ce08ccef9616cbc86efe.png" data-original-src="https://miro.medium.com/v2/resize:fit:912/format:webp/1*sQGXA-NcQcUQ1y0xlxdNbg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">要在views/register.ejs中查找的代码</p></figure><p id="4735" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当你找到它时，在这个<code class="fe no np nq nr b">h1</code>标签下写下下面一行:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="3a26" class="nw ms it nr b gy nx ny l nz oa">&lt;%- include ('./partials/messages') %&gt;</span></pre><p id="49a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这一行意味着导入一个新文件，这将有助于显示消息。</p><p id="b944" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到您的<code class="fe no np nq nr b">views</code>目录，创建一个名为<code class="fe no np nq nr b">partials</code>的新目录，并在<code class="fe no np nq nr b">partials</code>中创建一个名为<code class="fe no np nq nr b">messages.ejs</code>的文件。在那里，编写下面的代码。</p><p id="a205" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe no np nq nr b">views/partials/messages.ejs</code></p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="e212" class="nw ms it nr b gy nx ny l nz oa">&lt;% if(typeof errors!= 'undefined') { %&gt;<br/>&lt;%    errors.forEach(function(error){ %&gt;<br/>&lt;p&gt; &lt;%= error.msg %&gt;&lt;/p&gt;<br/>&lt;%    })        %&gt;<br/>&lt;% } %&gt;</span></pre><p id="2487" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这段代码告诉我们，如果存在任何错误，那么用它自己的paragraph( <code class="fe no np nq nr b">p</code>)元素显示数组的内容。</p><p id="ced3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">重新运行代码并编写一个单字符密码。这将是输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/31d938817052005bbfcf2799c91c08a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:724/format:webp/1*fUHBx1Y0CKhJ-N6mdpfKyw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">请注意，您现在已经显示了错误消息</p></figure><p id="baff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您将任何字段留空，您将收到以下错误消息:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi or"><img src="../Images/84ce6b2314c5246866a5039ccbd72459.png" data-original-src="https://miro.medium.com/v2/resize:fit:696/format:webp/1*zeQ8yZgwO66D1XgSb9NBdw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">此表单中显示两条错误消息</p></figure><p id="25d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使两个密码字段包含不同的值:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi os"><img src="../Images/074710b3ae14ddc93b5f711727d21803.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*S8vyt3kmMG_GS10vrFobPA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">该表单中显示了三条错误消息</p></figure><h2 id="85f3" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">处理对注册的POST请求:将用户保存到数据库</h2><p id="29a7" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在这一步中，您将把注册用户保存到MongoDB数据库中。您将首先加密他们的密码，然后将它们保存到数据库中。</p><p id="54f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe no np nq nr b">routes/users.js</code>中，找到下面这段代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/07cd1c8b4e3448654b60a27cbd68bcd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_dsR4QTivHv_vxYYvhVoag.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">routes/users.js中的代码</p></figure><p id="4e27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个<code class="fe no np nq nr b">else</code>块中，编写以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="0514" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，在这里结束<code class="fe no np nq nr b">else</code>语句。</p><ul class=""><li id="4e7f" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe no np nq nr b">Lines 2–7</code>:生成一个salt，散列用户的密码。将这个加密值分配给用户的密码，然后将客户端保存到数据库。</li><li id="842b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">Line 10 </code>:当文档保存无误后，将用户重定向到<code class="fe no np nq nr b">login</code>目录，用户现在将使用其凭证登录。</li></ul><p id="1b4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将是您将自己注册为用户时的代码输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/32bb59b1394836a2b306a398bad7b677.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/1*ndH9uLz4AXzmKtR0m21H9Q.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码输出</p></figure><p id="de58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为您已经在控制台中注销了文档的内容，所以控制台中的输出如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/28d4975e4b602a45eec1dcff8ed66bd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1214/format:webp/1*g5R67YwcubBJljDjXmgTfw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">新用户文档的内容</p></figure><p id="d1d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输入注册的电子邮件。不出所料，您会收到一条错误消息，告诉您电子邮件已经被存储:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/3f8c6fd76188f52d80b5cca431ea0d9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/format:webp/1*haxJThwHqP-DhUVq9Bsktw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码输出显示您有一个错误</p></figure><p id="9d1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过这一步，您最终将用户保存到了数据库中。让我们继续使用Express创建即时消息。</p><p id="bbf0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本节的最后，您的代码看起来是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="1219" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">使用Express发送即时消息</h1><p id="c545" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">当您在网站上注册帐户时，请注意它会将您重定向到登录页面，并显示一条成功信息，表明您已成功登录。该成功消息被称为<em class="ow">快速消息</em>。<br/>在这一部分，我们将创建一条简讯。</p><p id="852c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在继续之前，首先在<code class="fe no np nq nr b">app.js</code>中导入以下两个库。</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="2662" class="nw ms it nr b gy nx ny l nz oa">const session = require('express-session');<br/>const flash = require('connect-flash');</span></pre><h2 id="7df9" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">成功快讯</h2><p id="80f8" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">当用户注册并被重定向到登录页面时，您将显示此消息。</p><p id="2ca6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到项目目录中的<code class="fe no np nq nr b">app.js</code>,找到下面几行代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/fbf6df991e459985347ef69db1ddb959.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VLgFXVnBltwuYM4K3yz1ww.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app.js中的代码</p></figure><p id="a78d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在编写<code class="fe no np nq nr b">CODE TO BE ENTERED</code>的地方，编写下面的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="ed85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这段代码现在基本上允许你在应用程序中使用flash消息。</p><p id="dd65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在转到<code class="fe no np nq nr b">routes/users.js</code>，找到下面几行代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/4488afb8ae74fdc3a9e1f2f57bab5326.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ssJs_kI8IEKF85y-g32AOQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">routes/users.js</p></figure><p id="ded8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在写<code class="fe no np nq nr b">CODE HERE</code>(<code class="fe no np nq nr b"> line 7</code>)的地方写下下面一行代码:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="f166" class="nw ms it nr b gy nx ny l nz oa">req.flash('success_msg','You have now registered!')</span></pre><p id="db12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，你还没有完成。去<code class="fe no np nq nr b">views/login.ejs</code>找到这段代码。它位于文件的开头。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/17bda85822d7ea085115f0f26373c954.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*Ia1Iwd5ZsbwVOrVh7wXO6A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">views/login.ejs中的代码</p></figure><p id="f2d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就在这一行之后，键入这一行:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="bfad" class="nw ms it nr b gy nx ny l nz oa">&lt;%- include ('./partials/messages') %&gt;</span></pre><p id="d0dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您已经导入了您的<code class="fe no np nq nr b">messages</code>文件，以便在您的<code class="fe no np nq nr b">login</code>目录中显示消息。</p><p id="2a32" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到<code class="fe no np nq nr b">views/partials/messages.ejs</code>并在末尾添加这些行:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="33f4" class="nw ms it nr b gy nx ny l nz oa">&lt;% if(success_msg!= '') { %&gt;<br/>&lt;p&gt;&lt;%=success_msg %&gt; &lt;/p&gt;<br/>&lt;% } %&gt;</span></pre><p id="e587" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是代码的输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/e95608c0e6b4b9701540e78509edbc05.png" data-original-src="https://miro.medium.com/v2/resize:fit:786/format:webp/1*38cEIqtPFngtQjV0Or3bgg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">步骤1:注册用户</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/d554597ca1cc9decb055adbe97d1a9bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:674/format:webp/1*MsDiwRWzuaj0_PJsnW2fbw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">你现在有一个flash消息显示！</p></figure><h2 id="31f1" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">错误提示信息</h2><p id="0bd9" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">现在，您还将实现一个错误提示消息。当发生错误时，它将在用户验证期间显示。</p><p id="27ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到<code class="fe no np nq nr b">views/partials/messages.ejs</code>，然后在文件末尾添加以下代码:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="cf8b" class="nw ms it nr b gy nx ny l nz oa">&lt;% if(error_msg != '') { %&gt;<br/>  &lt;%= error_msg %&gt; <br/>&lt;% } %&gt; <br/>&lt;% if(error != '') { %&gt;<br/>  &lt;%= error %&gt;<br/>&lt;% } %&gt;</span></pre><p id="7739" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们通过引入Passport.js框架来继续进行用户认证</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="aa08" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">使用Passport进行用户验证</h1><h2 id="5f89" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">本地策略</h2><p id="c6ba" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">创建一个文件<code class="fe no np nq nr b">/config/passport.js</code>，然后从导入以下库开始:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="cdf3" class="nw ms it nr b gy nx ny l nz oa">const LocalStrategy = require('passport-local').Strategy;<br/>const bcrypt = require('bcrypt');<br/>const User = require("../models/user");</span></pre><p id="aa8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您现在正在导入带有其<code class="fe no np nq nr b">Strategy</code>实例的<code class="fe no np nq nr b">passport-local</code>,用于一个带有简单用户名和密码的用户认证机制。因为这次您将比较密码，所以您需要解密数据库返回的密码。因为这个原因，你也会把<code class="fe no np nq nr b">bcrypt</code>带进来。此外，因为您实际上是在比较从数据库返回的密码，所以您将为数据库相关的操作导入<code class="fe no np nq nr b">User</code>模型。</p><p id="ad37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，键入以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><ul class=""><li id="c78a" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe no np nq nr b">Line 2</code>:配置<code class="fe no np nq nr b">passport</code>实例，使其使用<code class="fe no np nq nr b">LocalStrategy</code>策略。您必须指定<code class="fe no np nq nr b">usernameField</code>选项，因为该选项将用于识别将与数据库进行比较的电子邮件地址。您已通过该选项确认您将在表单中使用<code class="fe no np nq nr b">email input type</code>元素。您也可以指定<code class="fe no np nq nr b">passwordField</code>选项。不过默认是<code class="fe no np nq nr b">password</code>，这里不需要指定。</li><li id="876f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">Lines 5–24</code>:首先，查找数据库中是否存在给定的电子邮件地址。如果不是，它将抛出一个错误，说明该电子邮件未被识别。稍后，您将比较用户输入的密码是否与数据库中的密码匹配。如果是，它将返回相关的用户信息。</li><li id="c576" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">Lines 25–34</code>:为了支持登录会话，<code class="fe no np nq nr b"> passport</code>将在<code class="fe no np nq nr b">user</code>实例上使用<code class="fe no np nq nr b">serialize</code>和<code class="fe no np nq nr b">deserialize</code>方法来访问会话。</li></ul><h2 id="5e89" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">处理登录目录的POST请求</h2><p id="ba9c" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">您现在需要告诉Passport您希望在哪里使用用户身份验证。您将在<code class="fe no np nq nr b">login</code>页面上使用该认证机制。</p><p id="775b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到<code class="fe no np nq nr b">/routes/users.js</code>并找到以下代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/3dce6b4d0e4104b6a635624c91190671.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2T9smfs5Mo8wix96uwNejA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">routes/users.js</p></figure><p id="67d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个POST处理程序中，编写下面几行代码:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="7afc" class="nw ms it nr b gy nx ny l nz oa">passport.authenticate('local',{<br/>successRedirect : '/dashboard',<br/>failureRedirect : '/users/login',<br/>failureFlash : true,<br/>})(req,res,next);</span></pre><p id="fe81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着:</p><ul class=""><li id="c458" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">如果用户成功登录，他们将被重定向到<code class="fe no np nq nr b">dashboard</code>目录(<code class="fe no np nq nr b">successRedirect</code>)。</li><li id="c3a3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">如果用户没有成功登录，将他们重定向到<code class="fe no np nq nr b">login</code>目录(<code class="fe no np nq nr b">failureRedirect</code>)。</li><li id="f134" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">出现错误时，获取紧急信息(<code class="fe no np nq nr b">failureFlash</code>)。</li></ul><p id="ab18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在转到<code class="fe no np nq nr b">app.js</code>，开始导入<code class="fe no np nq nr b">passport</code>库:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="83af" class="nw ms it nr b gy nx ny l nz oa">const passport = require('passport');</span></pre><p id="82d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后将这个配置指定为您之前创建的<code class="fe no np nq nr b">LocalStrategy</code>配置。导入后立即执行此步骤:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="7e0f" class="nw ms it nr b gy nx ny l nz oa">require("./config/passport")(passport)</span></pre><p id="f35a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，找到下面几行代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/38d50dfe02b462f585211ab9aee638f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*6405jff89WjJFRHyIf8cgQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">要在app.js中查找的行</p></figure><p id="63f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在注释<code class="fe no np nq nr b">CODE TO COME HERE</code> ( <code class="fe no np nq nr b">line 7</code>)处编写以下代码:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="6786" class="nw ms it nr b gy nx ny l nz oa">app.use(passport.initialize());<br/>app.use(passport.session());</span></pre><p id="3b74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以在应用中使用用户身份验证功能。然而，你还没有完成。您仍然需要处理到<code class="fe no np nq nr b">dashboard</code>目录的重定向。</p><p id="dbc3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到<code class="fe no np nq nr b">/routes/index.js</code>并输入以下代码:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="184c" class="nw ms it nr b gy nx ny l nz oa">router.get('/dashboard',(req,res)=&gt;{<br/>res.render('dashboard');<br/>})</span></pre><p id="6e1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在运行代码并转到<code class="fe no np nq nr b">localhost:3000/users/login</code>。这将是输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/68433adac535ae09343e5931c0a53b47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/1*wWXRneCTl60yc56GzeT4oA.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="0683" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，您终于可以登录了。这表示用户验证成功。</p><p id="9bf7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输入错误的密码会出现以下情况:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/3fb5f78f69a0a151bfd85ba8fe057493.png" data-original-src="https://miro.medium.com/v2/resize:fit:606/format:webp/1*QjFW19GYsCNWeavzSayCOA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">输入错误密码的结果</p></figure><p id="c4ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以尝试输入一个未注册的电子邮件来接收相应的错误信息。</p><p id="e7ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们继续显示用户数据。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="5f93" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">呈现仪表板以显示用户数据</h1><p id="8cef" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">你快完成了！</p><p id="4fb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到<code class="fe no np nq nr b">/routes/index.js</code>并找到以下代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/c188cef988524645cc1bf1c6b2815e31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n84G2ERW2GwioRWTR33Zsg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">要在index.js中查找的代码</p></figure><p id="aad4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按照以下步骤更换<code class="fe no np nq nr b">res.render</code>方法:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="2c0b" class="nw ms it nr b gy nx ny l nz oa">res.render('dashboard',{<br/>user: req.user<br/>});</span></pre><p id="fbd5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您已经将用户信息数据发送到了网页。这个用户信息数据由Passport返回。</p><p id="cb61" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后转到<code class="fe no np nq nr b">/views/dashboard.ejs</code>，修改欢迎消息，如下所示:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="abe4" class="nw ms it nr b gy nx ny l nz oa">&lt;p&gt; Welcome &lt;%= user.name %&gt;&lt;/p&gt;</span></pre><p id="a7dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您正在显示来自登录用户的<code class="fe no np nq nr b">user</code>数据的<code class="fe no np nq nr b">name</code>字段。</p><p id="52e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用正确的凭据登录，则输出如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/f587f5cd0a54d4f2ba5856e578c5ba07.png" data-original-src="https://miro.medium.com/v2/resize:fit:552/format:webp/1*D89Hp7fY7CgCiFVJq8XXyQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">成功的代码输出</p></figure></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="a503" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">处理注销请求</h1><p id="bb31" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">这是你的最后一步，也是最容易的一步。</p><p id="f4a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到<code class="fe no np nq nr b">/routes/users.js</code>并找到以下代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/e7f33102cb4327d606fddc24f8e5dca1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fHZHPPeW8-TMb94ZWn-agw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">要在routes/users.js中查找的代码</p></figure><p id="4bd7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在此处理程序中，编写以下代码:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="a0c3" class="nw ms it nr b gy nx ny l nz oa">req.logout();<br/>req.flash('success_msg','Now logged out');<br/>res.redirect('/users/login');</span></pre><p id="9ed5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe no np nq nr b">req.logout</code>功能由Passport创建。顾名思义，它注销用户会话。稍后，您发送一条成功的flash消息，然后将用户重定向到<code class="fe no np nq nr b">login</code>页面。</p><p id="a2ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将是代码的输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/cdd6e9691b045f63fa69f4b7bf89244a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1218/1*5GrHphmQGSOrHoGcokU1Cw.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="867d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，如果你现在转到<code class="fe no np nq nr b">localhost:3000/dashboard</code>，你会看到一个服务器错误。现在让我们来处理这个。</p><h2 id="e22d" class="nw ms it bd mt ob oc dn mx od oe dp nb li of og nd lm oh oi nf lq oj ok nh ol bi translated">注销时禁止访问仪表板</h2><p id="e681" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">转到<code class="fe no np nq nr b">config</code>并创建一个名为<code class="fe no np nq nr b">auth.js</code>的文件。</p><p id="5429" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe no np nq nr b">/config/auth.js </code>中增加:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="81a5" class="nw ms it nr b gy nx ny l nz oa">module.exports = {<br/>ensureAuthenticated : function(req,res,next) {<br/>if(req.isAuthenticated()) {<br/>return next();<br/>}<br/>req.flash('error_msg' , 'please login to view this resource');<br/>res.redirect('/users/login');<br/>}<br/>}</span></pre><p id="7cfb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将创建一个名为<code class="fe no np nq nr b">ensureAuthenticated</code>的函数，它将确保用户已经登录(<code class="fe no np nq nr b">req.isAuthenticated()</code>)。如果是这样，它就转移到下一个中间件。如果没有，它会抛出一个错误，并再次将用户重定向到<code class="fe no np nq nr b">login</code>页面。</p><p id="0cb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，转到<code class="fe no np nq nr b">/routes/index.js</code>并导入该功能:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="e039" class="nw ms it nr b gy nx ny l nz oa">const {ensureAuthenticated} = require("../config/auth.js")</span></pre><p id="b5f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">找到以下代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/026f8f9c8a5a5b6647dcfbb8e0674a47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KDL1fmQUBWipiN4-R_TCCA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">要在index.js中查找的代码</p></figure><p id="743d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在把<code class="fe no np nq nr b">router.get</code>功能修改成这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ph"><img src="../Images/c2178e352da5db5e7a7cd6fc735a4791.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KF6kxpSl8TCoDh8Q2O5n5w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">添加安全认证中间件</p></figure><p id="3124" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您已经表示希望在这个目录中使用这个函数作为中间件。</p><p id="2a77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该代码将输出以下内容。点击注销:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/9bd4f65b85004df372bcc71bb03f5be7.png" data-original-src="https://miro.medium.com/v2/resize:fit:502/format:webp/1*Bzn2yiolzL24FgFuKRbR9Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">仪表板的屏幕截图</p></figure><p id="7b90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后转到<code class="fe no np nq nr b">localhost:3000/dashboard</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/d0ee48a53b7e9133c7dfe63551ddf088.png" data-original-src="https://miro.medium.com/v2/resize:fit:698/format:webp/1*fwAMqwbV8RzmQI7N-MSHkg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">注销后转到仪表板</p></figure></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="7b3d" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">链接</h1><ul class=""><li id="ca95" class="lv lw it lb b lc nj lf nk li pk lm pl lq pm lu ma mb mc md bi translated"><a class="ae ky" href="https://github.com/HussainArif12/UserAuthentication-In-JavaScript" rel="noopener ugc nofollow" target="_blank"> Github回购</a></li></ul><p id="9b2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Passport文档包含了您需要知道的关于用户身份验证的所有内容，但是它是无序的，这就是为什么我觉得它有点混乱。然而，这里是学习Passport所需的最佳资源。</p><ul class=""><li id="fc99" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://www.youtube.com/watch?v=6FOq4cUdH8k" rel="noopener ugc nofollow" target="_blank">通过旅行媒体进行Passport验证的节点</a></li><li id="07b4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.youtube.com/watch?v=-RCnNyD0L-s" rel="noopener ugc nofollow" target="_blank"> Passport登录系统教程</a>由Web Dev简化</li><li id="5ca0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.youtube.com/watch?v=sakQbeRjgwg&amp;list=PL4cUxeGkcC9jdm7QX143aMLAqyM-jTZ2x" rel="noopener ugc nofollow" target="_blank">网络忍者OAuth登录播放列表</a></li></ul></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="e8a6" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">结论</h1><p id="3a1f" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">这是一个很长的教程！谢谢你能走到这一步。在困惑的情况下，建议你解构代码，研究什么功能做什么——永不放弃！非常感谢你坚持到最后。祝您愉快！</p><p id="4993" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一篇:<a class="ae ky" href="https://medium.com/better-programming/reacts-context-api-explained-baebcee39d2f?source=your_stories_page---------------------------" rel="noopener"> React的上下文API解释</a> <br/>上一篇:<a class="ae ky" href="https://levelup.gitconnected.com/get-your-daily-dose-of-inspiration-with-reactjs-fa529940326d?source=your_stories_page---------------------------" rel="noopener ugc nofollow" target="_blank">用React获取你每天的灵感剂量。Js </a></p></div></div>    
</body>
</html>