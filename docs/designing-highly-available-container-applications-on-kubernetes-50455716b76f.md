# 在 Kubernetes 上设计高可用性容器应用程序

> 原文：<https://betterprogramming.pub/designing-highly-available-container-applications-on-kubernetes-50455716b76f>

## 与 pod 中断预算和反亲和

![](img/268a62ea31692c205503a3d440ce0423.png)

由 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的 [chuttersnap](https://unsplash.com/@chuttersnap?utm_source=medium&utm_medium=referral) 拍摄。

一个多节点的 Kubernetes 集群在设计上是高度可用的。然而，这并不意味着如果集群发生了可怕的事情，您的容器应用程序不会被中断。

Kubernetes 根据几个因素为节点分配一个 pod，这些因素包括资源可用性、节点可用性、污点、容忍度以及相似性和反相似性规则。在默认设置中，Kubernetes 可以在满足这些约束的任何节点上安排一个 pod。

默认情况下，Kubernetes 不会尝试应用程序的高可用性。如果您旋转 pod 的三个副本，不一定会将它们分布在所有工作节点上。Kubernetes 将尽可能地覆盖这一点，但如何传播取决于上述因素。

这并不意味着你不能告诉 Kubernetes 做你想要的。在设计高可用性时，您自然希望您的实例分布在多个区域中，但是这是以您可能希望避免的延迟和出口费用为代价的。因此，您需要平衡您的需求和实用的设计决策。

在本文中，让我们关注高可用性设计。

# Pod 中断预算

Pod 中断预算是一个 Kubernetes 对象，它确保复制的应用程序在任何给定的时间点仍然保持一定数量的健康副本。

例如，一个名为 web-app 的应用程序运行三个副本，pod 中断预算为 2，如果有任何自愿中断，则在给定时间至少会有两个实例运行。

如果您希望确保您的客户在修补和升级集群时面临尽可能少的中断，这一点尤其有用。您还可以在需要法定人数才能运行的应用程序中使用 pod 中断预算。

请注意，您应该仅在运行多个复制副本的应用程序上指定 pod 中断预算。如果您在具有单个所需副本的应用程序上指定中断预算，Kubernetes 将不会在计划内停机的情况下从集群中驱逐 pod。

虽然使用 pod 中断预算是一种最佳做法，但您需要确保在考虑 pod 中断预算的情况下耗尽节点。这意味着您不应该一次耗尽多个节点。相反，您应该等待 Kubernetes 将被驱逐的 pod 重新安排到新节点，然后再尝试排出另一个。

有两种方法可以指定 pod 中断预算:按百分比或 pod 数量。例如，如果您将`minAvailable`指定为 2，那么 Kubernetes 允许驱逐，前提是一次至少有两个 pod 是健康的。如果您将`minAvailable`指定为 30%，这意味着如果一次有 30%的所需副本是健康的，Kubernetes 将允许驱逐。

您可以使用`minAvailable`或`maxUnavailable`标志来控制这种行为。这取决于您的具体使用情况。在大多数用例中，推荐使用`minAvailable`。

让我们为 NGINX 部署配置一个 pod 中断预算，然后自己看看:

好了，现在让我们创建一个 NGINX 部署:

让我们来看看部署状态:

部署已启动并正在运行，所有四个副本都运行良好且可用。

现在让我们尝试清空`gke-cluster-1-default-pool-bf356567-mrnh`节点，因为两个 NGINX 实例正在该节点上运行:

如果你查看日志，你会发现驱逐其中一个 pod(`nginx-5ffb5df89f-ctv4c`)的错误，因为它会违反 pod 中断预算。但是，它会删除另一个 pod，并且只有在另一个 pod 在另一个节点上被成功调度并且运行良好之后才会驱逐`nginx-5ffb5df89f-ctv4c`。

让我们看看分离舱被驱逐后我们会得到什么:

正如我们所看到的，Kubernetes 已经重新安排了其他节点上的 pod，它们已经启动并运行。

# Pod 亲和力和反亲和力

Pod 亲合性和反亲合性是确保高可用性的另一种方法，它尽可能将容器安排在不同的节点上。默认的 Kubernetes 调度器根据资源需求选择一个节点，默认情况下不保证将您的 pod 放在不同的节点中。

您可以强制 Kubernetes 使用 pod 反亲缘关系来安排您的 pod，使它们尽可能分散。万一您失去一个数据中心或一个节点，这对于确保高可用性非常有帮助。

您还可以一次规划一个节点的修补和升级，并确保该过程中的中断最小。如果您的所有 pod 都出现在一个节点中，这将成为一个问题。

Pod 反相似性主要以两种方式工作，每种方式提供一个硬`(requiredDuringSchedulingIgnoredDuringExecution)`或一个软检查`(preferredDuringSchedulingIgnoredDuringExecution)`。

这两种场景都有其用例。硬检查的一个用例是在每个节点上提供一个复制的 Redis 缓存。这将有助于应用程序在本地与 Redis 交互，从而提高性能。

您可以对无状态前端应用程序进行软检查，这将考虑资源可用性和其他需求。软条件的想法是使应用程序尽可能高可用，让 Kubernetes 决定什么是最好的，而不是在不需要的时候超载资源。

让我们尝试在每个 Kubernetes 节点上部署一个带有硬检查的 Redis 缓存。因为我们有三个节点在运行，所以我们将创建 Redis 的三个副本:

我们去拿豆荚，看看发生了什么:

等等，发生什么事了？为什么有一个 pod 待定？如果您还记得的话，我们已经清空了其中一个节点，但它仍未准备好进行调度。

让我们来看看这个节点:

现在，让我们打开节点，允许在其中进行调度，看看会发生什么:

我们一取消对节点的授权，Redis pod 就开始运行。到目前为止，一切顺利！

现在让我们修改 NGINX 部署，以便 Kubernetes 将 pod 分散到各个节点上。目前，每个节点上运行两个 pods，最近未授权的节点上没有运行 pods。让我们应用软反亲和规则，看看我们会得到什么:

我们去拿豆荚，看看我们能得到什么:

正如我们看到的，所有的豆荚都分布在节点上。

让我们将部署扩展到六个单元，并看看 Kubernetes 在哪里部署单元:

正如我们所看到的，Kubernetes 在空节点中创建了两个新的 pod，每个节点创建了两个 pod。

# 结论

虽然有其他方法可以确保您的 Kubernetes 集群的高可用性，但 pod 中断预算和 pod 反关联性是使您的应用程序在任何时候都具有高可用性的最佳方法。当然，为了实现高可用性，您还应该确保您的集群也是高可用性的。例如，您的节点应该分布在一个区域的多个分区中，或者分布在一个内部部署的多个数据中心中。

感谢阅读！我希望你喜欢这篇文章。