<html>
<head>
<title>Docker Multi-Stage Build</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Docker多阶段构建</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/docker-multi-stage-build-build-from-one-image-copy-to-another-image-c76cdc62ba7e?source=collection_archive---------12-----------------------#2019-09-04">https://betterprogramming.pub/docker-multi-stage-build-build-from-one-image-copy-to-another-image-c76cdc62ba7e?source=collection_archive---------12-----------------------#2019-09-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6892" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从一个映像构建，复制到另一个映像</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/b7267cee03631faee4683cca4f0d3843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*9LE68V2_nLQjRg3dAx54VA.jpeg"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">图片由来自<a class="ae ku" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=943245" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae ku" href="https://pixabay.com/users/Skitterphoto-324082/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=943245" rel="noopener ugc nofollow" target="_blank">鲁迪和</a>彼得·斯皮特林拍摄</p></figure><p id="ede9" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我现在就要清理我的服务器<em class="lr"/>。如果只是为了构建应用程序，为什么要安装Node呢？最后，Nginx负责服务器端。</p><p id="659a" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">如果你像我一样懒，这篇文章是给你的！</p><p id="869c" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在服务器上安装所有东西的日子已经一去不复返了。如果您有10台服务器会怎样？20台服务器？40台服务器？一个接一个地在服务器上安装所有东西是一个可怕的想法。</p><p id="c80d" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在你所要做的就是确保每台服务器都已经安装了Docker和Git，你就可以开始了！目标是部署最新的代码——我们所要做的就是git pull和docker-compose up。整洁！</p><p id="d9b4" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们将把<a class="ae ku" href="https://vuejs.org/" rel="noopener ugc nofollow" target="_blank"> Vue </a>项目编译成静态html，并用Nginx服务它。首先，你需要有Vue项目——在这里克隆hello world Vue<a class="ae ku" href="https://github.com/zamahsyari/vue-hello-world" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ls"><img src="../Images/df0a5b8d4c705329d67f85890c076f79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RqKz4sdh_UOwwbgtd6uskg.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">hello world Vue</p></figure><p id="6c17" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">接下来进入<em class="lr"> vue-hello-world </em>目录，创建新的两个文件并命名为Dockerfile和docker-compose.yml。</p><h2 id="5653" class="lx ly it bd lz ma mb dn mc md me dp mf le mg mh mi li mj mk ml lm mm mn mo mp bi translated">第一阶段</h2><ul class=""><li id="c84d" class="mq mr it kx b ky ms lb mt le mu li mv lm mw lq mx my mz na bi translated">拉节点图像</li><li id="f794" class="mq mr it kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated">将当前目录复制到节点映像中</li><li id="696a" class="mq mr it kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated">安装项目依赖项</li><li id="fbbc" class="mq mr it kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated">构建项目</li></ul><h2 id="75b0" class="lx ly it bd lz ma mb dn mc md me dp mf le mg mh mi li mj mk ml lm mm mn mo mp bi translated">第二阶段</h2><ul class=""><li id="ac8b" class="mq mr it kx b ky ms lb mt le mu li mv lm mw lq mx my mz na bi translated">拉Nginx图像</li><li id="aebf" class="mq mr it kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated">将构建的项目文件夹从阶段1复制到nginx</li></ul><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="05ec" class="lx ly it nh b gy nl nm l nn no">FROM node AS node<br/>COPY . /root<br/>WORKDIR /root<br/>RUN npm install<br/>RUN npm run build<br/>RUN echo 'BUILD SUCCEEDED'</span><span id="15ac" class="lx ly it nh b gy np nm l nn no">FROM nginx:alpine<br/>COPY --from=node /root/dist /usr/share/nginx/html<br/>RUN echo 'ATTACHED TO NGINX'</span></pre><p id="5434" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">如果您想知道，<em class="lr"> npm run build </em>将创建一个包含静态html的新的<em class="lr"> dist目录</em>。Nginx提供的就是这个静态html。</p><p id="fd7e" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">然后，在<strong class="kx iu"> docker-compose.yml </strong>中，我们需要编写config来构建镜像，并打开一个特定的端口向现实世界开放。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="4a18" class="lx ly it nh b gy nl nm l nn no">version: '3'<br/>services:<br/>  app:<br/>    build: .<br/>    ports:<br/>    - "8181:80"<br/>    command: 'nginx -g "daemon off;"'</span></pre><p id="40ff" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">搞定了。现在我们需要测试它。转到<em class="lr"> vue-hello-world </em>目录并执行该命令:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="ab3c" class="lx ly it nh b gy nl nm l nn no">docker-compose up</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/fa28d859728d5ecdf205390765bca861.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*17HuDDp-oBhIuP5J6vd5rw.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">准备发球</p></figure><p id="7517" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">Docker现在将基于Dockerfile脚本构建映像。等待几分钟，您的应用程序将在localhost:8181上提供。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi nr"><img src="../Images/5686843329669e83abe305e843e08f49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6o6-Ni7iSGyBw0cmAG8Vug.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">本地主机:8181</p></figure><p id="fead" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">最后，当您的团队成员之一提交repo上的更改并想要部署时，您所要做的就是git pull和docker-compose up。</p></div></div>    
</body>
</html>