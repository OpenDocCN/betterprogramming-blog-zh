<html>
<head>
<title>Write Your Kubernetes Infrastructure as Go Code — Using Custom Resource Definitions With Cdk8s</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的Kubernetes基础设施编写成Go代码——使用Cdk8s的自定义资源定义</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/write-your-kubernetes-infrastructure-as-go-code-using-custom-resource-definitions-with-cdk8s-5d9500693e02?source=collection_archive---------6-----------------------#2022-07-25">https://betterprogramming.pub/write-your-kubernetes-infrastructure-as-go-code-using-custom-resource-definitions-with-cdk8s-5d9500693e02?source=collection_archive---------6-----------------------#2022-07-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6d79" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用CRDs作为API</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/621c896a84e5f7e1a8675380629edb06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nRtndhXcwWHzK4QG"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@ihor_dvoretskyi?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Ihor Dvoretskyi </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="85a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://cdk8s.io/docs/latest/" rel="noopener ugc nofollow" target="_blank">cdk8s</a>(Kubernetes的云开发工具包)是一个开源框架(CNCF的一部分)，使用它你可以用常规编程语言(而不是<code class="fe ls lt lu lv b">yaml</code>)定义你的Kubernetes应用。以前关于这个主题的一些博客涵盖了入门经验和使用<code class="fe ls lt lu lv b">cdk8s-plus</code>库进一步改进核心<code class="fe ls lt lu lv b">cdk8s</code>库特性。我们将继续推进<code class="fe ls lt lu lv b">cdk8s</code>更进一步。</p><p id="60c7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇博文将展示如何将<a class="ae kv" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#customresourcedefinitions" rel="noopener ugc nofollow" target="_blank"> Kubernetes自定义资源定义</a>与<code class="fe ls lt lu lv b">cdk8s</code>结合使用。我们将从一个简单的<code class="fe ls lt lu lv b">Nginx</code>示例开始，然后您将使用Strimzi项目CRDs与Go和<code class="fe ls lt lu lv b">cdk8s</code>的组合来定义和部署Kubernetes上的Kafka集群！</p><blockquote class="lw lx ly"><p id="4f2c" class="kw kx lz ky b kz la jr lb lc ld ju le ma lg lh li mb lk ll lm mc lo lp lq lr ij bi translated"><em class="iq">我假设你对Kubernetes自定义资源定义有所了解，甚至可能使用过一些</em> <a class="ae kv" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" rel="noopener ugc nofollow" target="_blank"> <em class="iq">操作符</em> </a> <em class="iq">。如果没有，也没关系！Kubernetes文档对此做了很好的介绍。您可以随时参考它，回到这里并跟随它！</em></p></blockquote><p id="f6dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">cdk8s</code>让你可以在代码中直接使用Kubernetes API对象，而不必导入单独的Go客户端包，这一切都归功于<code class="fe ls lt lu lv b">cdk8s import</code>。(在<em class="lz">中也提到了“等等，Kubernetes API依赖项呢？?"</em>前一篇<a class="ae kv" rel="noopener ugc nofollow" target="_blank" href="/write-your-kubernetes-infrastructure-as-go-code-getting-started-with-cdk8s-989725f8af73">博文</a>的一段。但是您也可以将它用于自定义资源定义！让我们来看看实际情况。</p><h1 id="f07f" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">开始之前…</h1><p id="8982" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">确保您已经安装了<code class="fe ls lt lu lv b">Go</code> ( <a class="ae kv" href="https://go.dev/dl/" rel="noopener ugc nofollow" target="_blank"> v1.16 </a>或更高版本)和<a class="ae kv" href="https://github.com/cdk8s-team/cdk8s-cli" rel="noopener ugc nofollow" target="_blank"> cdk8s CLI </a>。此外，您需要能够访问Kubernetes集群。对于学习和实验，我会推荐使用本地运行的单节点集群——比如<code class="fe ls lt lu lv b"><a class="ae kv" href="https://minikube.sigs.k8s.io/docs/start/" rel="noopener ugc nofollow" target="_blank">minikube</a></code>、<a class="ae kv" href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation" rel="noopener ugc nofollow" target="_blank"> kind </a>等。</p><blockquote class="lw lx ly"><p id="6dbf" class="kw kx lz ky b kz la jr lb lc ld ju le ma lg lh li mb lk ll lm mc lo lp lq lr ij bi translated"><em class="iq">我一般用</em> <code class="fe ls lt lu lv b"><em class="iq">minikube</em></code> <em class="iq">，所以建立一个集群就像</em> <code class="fe ls lt lu lv b"><em class="iq">minikube start</em></code>一样简单</p></blockquote><p id="de5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要安装cdk8s CLI:</p><p id="0f3d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以从以下选项中选择:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="9e6b" class="ne me iq lv b gy nf ng l nh ni">#homebrew<br/>brew install cdk8s</span><span id="d9b8" class="ne me iq lv b gy nj ng l nh ni">#npm<br/>npm install -g cdk8s-cli</span><span id="0a77" class="ne me iq lv b gy nj ng l nh ni">#yarn<br/>yarn global add cdk8s-cli</span></pre></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><h1 id="e7fe" class="md me iq bd mf mg nr mi mj mk ns mm mn jw nt jx mp jz nu ka mr kc nv kd mt mu bi translated">好吧，让我们开始吧…</h1><blockquote class="lw lx ly"><p id="982e" class="kw kx lz ky b kz la jr lb lc ld ju le ma lg lh li mb lk ll lm mc lo lp lq lr ij bi translated"><em class="iq">虽然这篇博文会提供一步一步的说明，但是你可以随时参考Github </em> 上完整的 <a class="ae kv" href="https://github.com/abhirockzz/cdk8s-for-go-developers/tree/master/part3-crd" rel="noopener ugc nofollow" target="_blank"> <em class="iq">代码</em></a></p></blockquote><p id="df71" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">cdk8s</code>让你很容易开始并启动你的应用程序。你不需要猜测和弄清楚如何构建你的项目，设置依赖关系等等。因为<code class="fe ls lt lu lv b">cdk8s init</code>命令会帮你做到！</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="114a" class="ne me iq lv b gy nf ng l nh ni">cdk8s init go-app</span><span id="ae13" class="ne me iq lv b gy nj ng l nh ni">#output<br/>....</span><span id="d8f3" class="ne me iq lv b gy nj ng l nh ni"> Your cdk8s Go project is ready!</span><span id="34c5" class="ne me iq lv b gy nj ng l nh ni">   cat help      Prints this message  <br/>   cdk8s synth   Synthesize k8s manifests to dist/<br/>   cdk8s import  Imports k8s API objects to "imports/k8s"</span><span id="5e1e" class="ne me iq lv b gy nj ng l nh ni">  Deploy:<br/>   kubectl apply -f dist/</span></pre><p id="2039" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">更新generate <code class="fe ls lt lu lv b">go.mod</code>文件，并用下面的内容替换它——这是为了让事情更简单。</p><blockquote class="lw lx ly"><p id="ee48" class="kw kx lz ky b kz la jr lb lc ld ju le ma lg lh li mb lk ll lm mc lo lp lq lr ij bi translated">如果需要，请随意使用最新版本的模块。</p></blockquote><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="b603" class="ne me iq lv b gy nf ng l nh ni">module cdk8s-crd</span><span id="2c31" class="ne me iq lv b gy nj ng l nh ni">go 1.16</span><span id="2723" class="ne me iq lv b gy nj ng l nh ni">require (<br/>    github.com/aws/constructs-go/constructs/v10 v10.1.42<br/>    github.com/aws/jsii-runtime-go v1.61.0<br/>    github.com/cdk8s-team/cdk8s-core-go/cdk8s/v2 v2.3.34<br/>)</span></pre><p id="8ca3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，让我们用一个真正的(真的！)简单的自定义资源定义。</p><p id="c332" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将使用来自Kubernetes示例<a class="ae kv" href="https://github.com/kubernetes/sample-controller" rel="noopener ugc nofollow" target="_blank">的CRD样本。说实话，它并没有真正做什么。但是，由于我们刚刚开始，这应该足够了！</a></p><p id="f80f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，安装/注册<code class="fe ls lt lu lv b">CRD</code>资源本身:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="58ff" class="ne me iq lv b gy nf ng l nh ni">kubectl apply -f <a class="ae kv" href="https://raw.githubusercontent.com/kubernetes/sample-controller/master/artifacts/examples/crd.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes/sample-controller/master/artifacts/examples/crd.yaml</a></span></pre><p id="7d8b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">确认是否安装了<code class="fe ls lt lu lv b">CRD</code>:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="8d8f" class="ne me iq lv b gy nf ng l nh ni">kubectl get crd</span><span id="9825" class="ne me iq lv b gy nj ng l nh ni"># output<br/>NAME                           CREATED AT<br/>foos.samplecontroller.k8s.io   2022-07-08T09:28:46Z</span><span id="c6f0" class="ne me iq lv b gy nj ng l nh ni">kubectl get foos.samplecontroller.k8s.io</span><span id="9079" class="ne me iq lv b gy nj ng l nh ni">#output (as expected)<br/>No resources found in default namespace.</span></pre><p id="58d9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以，我们只是安装了一个名称为<code class="fe ls lt lu lv b">foos.samplecontroller.k8s.io</code>类型为<code class="fe ls lt lu lv b">Foo</code>的<code class="fe ls lt lu lv b">CRD</code>。可以使用<code class="fe ls lt lu lv b">yaml</code>创建一个这样的实例...但是...</p><p id="64cc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们是来写Go代码的！</p><p id="82ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为此，首先使用<code class="fe ls lt lu lv b">cdk8s</code>将<code class="fe ls lt lu lv b">CRD</code>作为API导入——这将自动创建相应的Go API表示(<code class="fe ls lt lu lv b">struct</code>等)。):</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="7888" class="ne me iq lv b gy nf ng l nh ni">cdk8s import <a class="ae kv" href="https://raw.githubusercontent.com/kubernetes/sample-controller/master/artifacts/examples/crd.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes/sample-controller/master/artifacts/examples/crd.yaml</a></span></pre><p id="94c9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">检查<code class="fe ls lt lu lv b">imports</code>目录，应该已经创建了一个附加文件夹。</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="7148" class="ne me iq lv b gy nf ng l nh ni">imports/<br/>└── samplecontrollerk8sio<br/>    ├── internal<br/>    │   └── types.go<br/>    ├── jsii<br/>    │   ├── jsii.go<br/>    │   └── samplecontrollerk8sio-0.0.0.tgz<br/>    ├── samplecontrollerk8sio.go<br/>    ├── samplecontrollerk8sio.init.go<br/>    └── version</span></pre><p id="6cfe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在可以像使用任何其他Kubernetes资源/API一样使用<code class="fe ls lt lu lv b">CRD</code>(比如<code class="fe ls lt lu lv b">Deployment</code>),并在<code class="fe ls lt lu lv b">cdk8s</code> Go代码中导入它。创建一个名为<code class="fe ls lt lu lv b">foo.go</code>的新文件，并复制以下代码:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="2862" class="ne me iq lv b gy nf ng l nh ni">package main</span><span id="5fa9" class="ne me iq lv b gy nj ng l nh ni">import (<br/>    "cdk8s-crd/imports/samplecontrollerk8sio"</span><span id="28c5" class="ne me iq lv b gy nj ng l nh ni">    "github.com/aws/constructs-go/constructs/v10"<br/>    "github.com/aws/jsii-runtime-go"<br/>    "github.com/cdk8s-team/cdk8s-core-go/cdk8s/v2"<br/>)</span><span id="04c4" class="ne me iq lv b gy nj ng l nh ni">type FooChartProps struct {<br/>    cdk8s.ChartProps<br/>}</span><span id="a913" class="ne me iq lv b gy nj ng l nh ni">func NewFooChart(scope constructs.Construct, id string, props *FooChartProps) cdk8s.Chart {<br/>    var cprops cdk8s.ChartProps<br/>    if props != nil {<br/>        cprops = props.ChartProps<br/>    }<br/>    chart := cdk8s.NewChart(scope, jsii.String(id), &amp;cprops)</span><span id="d556" class="ne me iq lv b gy nj ng l nh ni">    samplecontrollerk8sio.NewFoo(chart, jsii.String("foo1"), &amp;samplecontrollerk8sio.FooProps{Spec: &amp;samplecontrollerk8sio.FooSpec{DeploymentName: jsii.String("foo1-dep"), Replicas: jsii.Number(2)}})</span><span id="ffe7" class="ne me iq lv b gy nj ng l nh ni">    return chart<br/>}</span></pre><p id="187f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">看看我们如何创建一个<code class="fe ls lt lu lv b">samplecontrollerk8sio.Foo</code>的实例:</p><ul class=""><li id="fee3" class="nw nx iq ky b kz la lc ld lf ny lj nz ln oa lr ob oc od oe bi translated">从<code class="fe ls lt lu lv b">cdk8s-crd/imports/samplecontrollerk8sio</code>包中导入自动生成的CRD API，</li><li id="221b" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ob oc od oe bi translated">使用<code class="fe ls lt lu lv b">NewFoo</code>函数并通过<code class="fe ls lt lu lv b">FooProps</code>提供元数据</li></ul><p id="d21e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用以下内容替换<code class="fe ls lt lu lv b">main.go</code>的内容:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="c680" class="ne me iq lv b gy nf ng l nh ni">package main</span><span id="b48d" class="ne me iq lv b gy nj ng l nh ni">import (<br/>    "github.com/cdk8s-team/cdk8s-core-go/cdk8s/v2"<br/>)</span><span id="f595" class="ne me iq lv b gy nj ng l nh ni">type MyChartProps struct {<br/>    cdk8s.ChartProps<br/>}</span><span id="e6ed" class="ne me iq lv b gy nj ng l nh ni">func main() {<br/>    app := cdk8s.NewApp(nil)<br/>    NewFooChart(app, "FooApp", nil)<br/>    app.Synth()<br/>}</span></pre><p id="39f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们所做的就是将我们刚刚定义的<code class="fe ls lt lu lv b">Chart</code>(在<code class="fe ls lt lu lv b">foo.go</code>中)包含在<code class="fe ls lt lu lv b">cdk8s</code> <code class="fe ls lt lu lv b">App</code>中。</p><p id="7aab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建<code class="fe ls lt lu lv b">Foo</code>资源...</p><p id="3736" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行<code class="fe ls lt lu lv b">cdk8s synth</code> -这将在<code class="fe ls lt lu lv b">dist</code>文件夹中产生一个清单:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="cb3b" class="ne me iq lv b gy nf ng l nh ni">apiVersion: samplecontroller.k8s.io/v1alpha1<br/>kind: Foo<br/>spec:<br/>  deploymentName: foo1-dep<br/>  replicas: 2<br/>metadata:<br/>  name: fooapp-foo1-c80094ac</span></pre><p id="dbd1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要在Kubernetes创建它:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="146d" class="ne me iq lv b gy nf ng l nh ni">kubectl apply -f dist</span></pre><p id="1233" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以通过运行以下命令进行确认:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="373f" class="ne me iq lv b gy nf ng l nh ni">kubectl get foo<br/>kubectl get foos.samplecontroller.k8s.io</span></pre><blockquote class="lw lx ly"><p id="a6bb" class="kw kx lz ky b kz la jr lb lc ld ju le ma lg lh li mb lk ll lm mc lo lp lq lr ij bi translated"><em class="iq">为了进一步反省，您可以使用已创建资源的名称，例如</em> <code class="fe ls lt lu lv b"><em class="iq">kubectl describe foo/fooapp-foo1-c80094ac</em></code></p></blockquote><p id="4212" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，现在你已经看到了一个简单的例子，我们可以继续学习稍微高级一点的东西。</p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><h1 id="d6fd" class="md me iq bd mf mg nr mi mj mk ns mm mn jw nt jx mp jz nu ka mr kc nv kd mt mu bi translated">使用Strimzi、<code class="fe ls lt lu lv b">cdk8s</code>和Go在Kubernetes上设置卡夫卡</h1><p id="6c0c" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">Strimzi是一个开源的CNCF项目，也是我个人最喜欢的项目之一！如果你不知道Strimzi，没关系。只需理解它提供了一种在Kubernetes上运行Apache Kafka的方法，借助于定制的资源定义和相应的操作符，例如Kafka cluster、Kafka Connect topic、users、Kafka Mirror等组件。</p><p id="fc5e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里有一个不同Strimzi组件如何交互的高层图。由于Strimzi深潜超出了范围，我建议您参考它的(优秀！)<a class="ae kv" href="https://strimzi.io/docs/" rel="noopener ugc nofollow" target="_blank">文档</a>了解详情。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/c8397b14c2f8cd27e84216f2bfd8579d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J3To7C5VuUUoQIz9.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://strimzi.io/documentation/" rel="noopener ugc nofollow" target="_blank">https://strimzi.io/documentation/</a></p></figure><p id="63e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">和以前一样，我们需要首先安装CRD本身(你也可以参考<a class="ae kv" href="https://strimzi.io/quickstarts/" rel="noopener ugc nofollow" target="_blank"> Strimzi快速入门</a></p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="977d" class="ne me iq lv b gy nf ng l nh ni">kubectl create namespace kafka<br/>kubectl create -f 'https://strimzi.io/install/latest?namespace=kafka' -n kafka</span><span id="0977" class="ne me iq lv b gy nj ng l nh ni"># wait for the Operator Pod to start up (Running)<br/>kubectl get pod -n kafka --watch</span></pre><blockquote class="lw lx ly"><p id="9ddb" class="kw kx lz ky b kz la jr lb lc ld ju le ma lg lh li mb lk ll lm mc lo lp lq lr ij bi translated"><em class="iq">您也可以使用</em> <code class="fe ls lt lu lv b"><em class="iq">kubectl logs deployment/strimzi-cluster-operator -n kafka -f</em></code>查看操作员日志</p></blockquote><p id="4dbf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每个支持的Kafka组件(集群、连接、用户等。)有一个相应的定制资源定义——出于本文的目的，我们将只使用Kafka集群和主题CRD。让我们将它们作为API导入:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="fc05" class="ne me iq lv b gy nf ng l nh ni">cdk8s import https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/main/install/cluster-operator/040-Crd-kafka.yaml</span><span id="29b7" class="ne me iq lv b gy nj ng l nh ni">cdk8s import kafkatopic:=https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/main/install/cluster-operator/043-Crd-kafkatopic.yaml</span></pre><blockquote class="lw lx ly"><p id="37f8" class="kw kx lz ky b kz la jr lb lc ld ju le ma lg lh li mb lk ll lm mc lo lp lq lr ij bi translated"><em class="iq">注意，我已经将</em> <code class="fe ls lt lu lv b"><em class="iq">kafkatopic</em></code> <em class="iq">添加到Kafka主题CRD </em>的模块名称前面</p></blockquote><p id="3b0e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">检查<code class="fe ls lt lu lv b">imports</code>文件夹——您应该会看到另外两个名为<code class="fe ls lt lu lv b">kafkastrimziio</code>和<code class="fe ls lt lu lv b">kafkatopic_kafkastrimziio</code>的文件夹。</p><p id="577d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">又到了写代码的时候了:</p><p id="695c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建一个<code class="fe ls lt lu lv b">kafka_strimzi.go</code>文件，从Github repo 中复制代码<a class="ae kv" href="https://github.com/abhirockzz/cdk8s-for-go-developers/blob/master/part3-crd/kafka_strimzi.go" rel="noopener ugc nofollow" target="_blank">:</a></p><blockquote class="lw lx ly"><p id="4eb0" class="kw kx lz ky b kz la jr lb lc ld ju le ma lg lh li mb lk ll lm mc lo lp lq lr ij bi translated"><em class="iq">或者你也可以简单地这样做:</em> <code class="fe ls lt lu lv b"><em class="iq">curl -o kafka.go </em><a class="ae kv" href="https://raw.githubusercontent.com/abhirockzz/cdk8s-for-go-developers/master/part3-crd/kafka_strimzi.go" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://raw.githubusercontent.com/abhirockzz/cdk8s-for-go-developers/master/part3-crd/kafka_strimzi.go</em></a></code></p></blockquote><p id="ee4d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将在这里向您介绍代码的重要部分。从创建新的<code class="fe ls lt lu lv b">Chart</code>的<code class="fe ls lt lu lv b">NewKafkaChart</code>函数开始。</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="a42a" class="ne me iq lv b gy nf ng l nh ni">func NewKafkaChart(scope constructs.Construct, id string, props *KafkaChartProps) cdk8s.Chart {<br/>    //.... ommitted for brevity<br/>    chart := cdk8s.NewChart(scope, jsii.String(id), &amp;cprops)</span></pre><p id="c2c8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">查看Kafka集群是如何使用<code class="fe ls lt lu lv b">kafkastrimziio.KafkaProps</code> struct定义的(要深入了解这些组件，您可以参考<a class="ae kv" href="https://strimzi.io/docs/operators/latest/configuring.html#assembly-config-kafka-str" rel="noopener ugc nofollow" target="_blank"> Strimzi文档</a>)。我们指定Kafka版本、节点/副本的数量(我们将坚持使用单个节点副本)以及如何公开集群等。</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="8550" class="ne me iq lv b gy nf ng l nh ni">//....<br/>&amp;kafkastrimziio.KafkaProps{<br/>            Spec: &amp;kafkastrimziio.KafkaSpec{<br/>                Kafka: &amp;kafkastrimziio.KafkaSpecKafka{</span><span id="f35a" class="ne me iq lv b gy nj ng l nh ni">                    Version:  jsii.String("3.2.0"),<br/>                    Replicas: jsii.Number(1),<br/>                    Listeners: &amp;[]*kafkastrimziio.KafkaSpecKafkaListeners{<br/>                        {<br/>                            Name: jsii.String("plain"),<br/>                            Port: jsii.Number(9092),<br/>                            Type: kafkastrimziio.KafkaSpecKafkaListenersType_INTERNAL,<br/>                            Tls:  jsii.Bool(false),<br/>                        },<br/>                    },<br/>//....</span></pre><p id="c16b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们添加Kafka集群所需的配置(符合我们只有单节点集群的事实)以及存储(临时存储将适用于此示例)。</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="608f" class="ne me iq lv b gy nf ng l nh ni">//...<br/>Config: map[string]interface{}{<br/>                        "offsets.topic.replication.factor":         1,<br/>                        "transaction.state.log.replication.factor": 1,<br/>                        "transaction.state.log.min.isr":            1,<br/>                        "default.replication.factor":               1,<br/>                        "min.insync.replicas":                      1,<br/>                        "inter.broker.protocol.version":            "3.2",<br/>                    },<br/>                    Storage: &amp;kafkastrimziio.KafkaSpecKafkaStorage{<br/>                        Type: kafkastrimziio.KafkaSpecKafkaStorageType_EPHEMERAL,<br/>                    },<br/>//...</span></pre><p id="7493" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们配置Zookeeper以及处理Kafka主题的<a class="ae kv" href="https://strimzi.io/docs/operators/latest/configuring.html#assembly-kafka-entity-operator-str" rel="noopener ugc nofollow" target="_blank">实体操作符</a>(以及用户，尽管我们在这里没有使用它)</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="b1e0" class="ne me iq lv b gy nf ng l nh ni">//...<br/>Zookeeper: &amp;kafkastrimziio.KafkaSpecZookeeper{<br/>                    Replicas: jsii.Number(1),<br/>                    Storage: &amp;kafkastrimziio.KafkaSpecZookeeperStorage{<br/>                        Type: kafkastrimziio.KafkaSpecZookeeperStorageType_EPHEMERAL,<br/>                    },<br/>                },<br/>                EntityOperator: &amp;kafkastrimziio.KafkaSpecEntityOperator{<br/>                    TopicOperator: &amp;kafkastrimziio.KafkaSpecEntityOperatorTopicOperator{},<br/>                }}})<br/>//...</span></pre><p id="b9ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要连接它，请更新<code class="fe ls lt lu lv b">main.go</code>文件:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="fa43" class="ne me iq lv b gy nf ng l nh ni">func main() {<br/>    app := cdk8s.NewApp(nil)<br/>    //NewFooChart(app, "FooApp", nil)<br/>    NewKafkaChart(app, "KafkaApp", nil)<br/>    app.Synth()<br/>}</span></pre><p id="e30c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要使用CRD创建Kafka集群…</p><p id="27a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">遵循通常的工作流程:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="0517" class="ne me iq lv b gy nf ng l nh ni"># generate manifest (check it in dist folder)<br/>cdk8s synth</span><span id="04de" class="ne me iq lv b gy nj ng l nh ni"># apply it (note the kafka namespace)<br/>kubectl apply -f dist/ -n kafka</span></pre><p id="1870" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">等待创建资源:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="415b" class="ne me iq lv b gy nf ng l nh ni">KAFKA_CRD_INSTANCE_NAME=$(kubectl get kafka -n kafka -o=jsonpath='{.items[0].metadata.name}')<br/>kubectl wait kafka/$KAFKA_CRD_INSTANCE_NAME --for=condition=Ready --timeout=300s -n kafka</span></pre><p id="b7ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦创建了所有Kafka集群资源，您应该会看到下面的消息— <code class="fe ls lt lu lv b">kafka.kafka.strimzi.io/&lt;name of your Kafka CRD instance&gt; condition met</code>。Kafka集群现在已经准备好了，我们可以使用基于Kafka CLI的生产者和消费者(Strimzi quickstart中的说明)来测试它。</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="3507" class="ne me iq lv b gy nf ng l nh ni">BOOSTRAP_SERVER=$(kubectl get kafka -n kafka -o=jsonpath='{.items[0].metadata.name}')-kafka-bootstrap</span><span id="6b81" class="ne me iq lv b gy nj ng l nh ni">kubectl -n kafka run kafka-producer -ti --image=quay.io/strimzi/kafka:0.29.0-kafka-3.2.0 --rm=true --restart=Never -- bin/kafka-console-producer.sh --bootstrap-server $BOOSTRAP_SERVER:9092 --topic test-topic</span><span id="a75f" class="ne me iq lv b gy nj ng l nh ni">kubectl -n kafka run kafka-consumer -ti --image=quay.io/strimzi/kafka:0.29.0-kafka-3.2.0 --rm=true --restart=Never -- bin/kafka-console-consumer.sh --bootstrap-server $BOOSTRAP_SERVER:9092 --topic test-topic --from-beginning</span></pre><p id="423e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">暂时就这样吧！</p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><h1 id="b9a0" class="md me iq bd mf mg nr mi mj mk ns mm mn jw nt jx mp jz nu ka mr kc nv kd mt mu bi translated">该总结了</h1><p id="9dad" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">您了解了如何将Kubernetes自定义资源定义与<code class="fe ls lt lu lv b">cdk8s</code>结合起来。这真的很强大，意味着您可以继续使用代码(在这种情况下，用Go编写)来定义内置的Kubernetes资源(如<code class="fe ls lt lu lv b">Deployment</code>等)。)以及自定义资源！</p><p id="b7c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你喜欢你所尝试的吗？</p><p id="e975" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">嗯，可以继续学习！</p><p id="76d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">几个建议:</p><ol class=""><li id="92a1" class="nw nx iq ky b kz la lc ld lf ny lj nz ln oa lr ol oc od oe bi translated">你可以尝试更新现有代码来添加一个<code class="fe ls lt lu lv b">Deployment</code>资源，该资源引用一个Kafka客户端应用程序(你必须先编写它并将其打包为Docker容器)，并且可以访问你创建的Kafka集群。探索如何获得连接参数..</li><li id="61c0" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ol oc od oe bi translated">我们创建的Kafka集群被配置为只允许<strong class="ky ir">内部</strong>访问。探索对外公开它的选项(参考Strimzi文档)并更新代码来实现它(应该是一个小的改变)。哪些Kubernetes对象会受到它的影响？</li></ol><p id="17e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">编码快乐！</p></div></div>    
</body>
</html>