<html>
<head>
<title>Run GitHub Actions Self-hosted macOS Runners on Apple M1 Mac</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在苹果M1 Mac上运行GitHub Actions自托管macOS运行程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/run-github-actions-self-hosted-macos-runners-on-apple-m1-mac-b559acd6d783?source=collection_archive---------2-----------------------#2022-04-22">https://betterprogramming.pub/run-github-actions-self-hosted-macos-runners-on-apple-m1-mac-b559acd6d783?source=collection_archive---------2-----------------------#2022-04-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7385" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第2部分:使用M1 Mac来驱动您自己的iOS CI/CD管道</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/97d083892c15dcc941a7e72d9053fee9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*C2LV7Fb7MlexjkmqKmvycg.png"/></div></figure><p id="e9f2" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在本系列的第1部分中，我们看到了使用苹果硅机器创建自托管的微软Azure的DevOps代理。</p><p id="8f12" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">对于那些正在使用GitHub actions的人来说，在这篇文章中，我们将为GitHub actions自托管的运行者介绍使用基于M1的机器的过程。</p><h1 id="7429" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">准备安装</h1><p id="5b3d" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">首先，您需要镜像GitHub托管的运行程序的配置，以避免将来出现任何错误。为此，创建一个名为<strong class="kp ir"> runner </strong>的用户帐户，并将该帐户添加到管理组:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="3bb1" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">重新启动后，您的新用户帐户将准备就绪。从现在开始，使用这个帐户来配置和运行我们的自托管runner。</p><blockquote class="mj mk ml"><p id="e9d6" class="kn ko mm kp b kq kr jr ks kt ku ju kv mn kx ky kz mo lb lc ld mp lf lg lh li ij bi translated">注意:你需要安装一些必备的工具，比如<strong class="kp ir"> git </strong>如果还没有安装的话，还需要<a class="ae lj" href="https://support.apple.com/en-us/HT211861" rel="noopener ugc nofollow" target="_blank">在你的苹果M1机器</a>上安装Rosetta 2。</p></blockquote><h1 id="1a0e" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">设置和配置跑步者</h1><p id="9ed1" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">您可以在存储库级别、组织级别或企业级别创建自托管运行程序。为此，导航至所需级别的<strong class="kp ir">设置</strong>选项卡。从侧边栏导航中选择<strong class="kp ir">动作</strong>，接下来选择<strong class="kp ir">跑步者</strong>选项并点击<strong class="kp ir">新的自托管跑步者</strong>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mq"><img src="../Images/fb9ec6788ec1a6dfaacda9edf90620a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RiJ7rHm396nabgBCyhYU6A.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mv"><img src="../Images/2f23b760e0696fada81b9682f317380e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w-IVCseNZDE7fGFpHJ54gA.png"/></div></div></figure><p id="df5b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">当您这样做时，您将看到一个视图，其中包含安装命令和示例用法，如上所示。从这里，只需打开一个终端，并按顺序运行命令。在运行<strong class="kp ir"> config.sh </strong>，<strong class="kp ir"> </strong>时，您将在终端中看到以下对话:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi mw"><img src="../Images/da6285a3727612725bc34639695623b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wFLEi0htcWorzrwUiK7LGQ.png"/></div></div></figure><p id="3802" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在这里，选择您的跑步者组和名称或接受默认值。您可以选择为您的跑步者提供额外的标签，标签的用法将在后面解释。然后，您可以自定义工作文件夹或接受默认值<code class="fe mx my mz na b">_work</code>。</p><p id="78c0" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">最后，您需要配置额外的环境变量，以确保动作在您的自托管runner上正常工作。最重要的是<code class="fe mx my mz na b">ImageOS</code>和<code class="fe mx my mz na b">XCODE_12_DEVELOPER_DIR</code> / <code class="fe mx my mz na b">XCODE_11_DEVELOPER_DIR</code>。对于<code class="fe mx my mz na b">ImageOS</code>，您需要提供操作系统名称(此处为macos)和版本，格式为<strong class="kp ir"> macos*version* </strong>，即<code class="fe mx my mz na b">maos12</code>。对于<code class="fe mx my mz na b">XCODE_*_DEVELOPER_DIR</code>，提供适用版本<code class="fe mx my mz na b">/Applications/Xcode_12.5.1.app/Contents/Developer</code>的Xcode开发者目录的路径。您可以在<strong class="kp ir">中添加这些变量。runner文件夹中的env </strong>文件。如果您的操作需要额外的环境变量，您也可以在这里添加它们。</p><p id="7da7" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这样，您就可以最终执行<strong class="kp ir"> run.sh </strong>脚本，它将出现在您的新runner目录中。</p><h1 id="bed7" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">确认成功</h1><p id="79ec" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">一旦你完成了设置，你应该在终端上看到输出，运行者已经启动，并且<strong class="kp ir">正在监听任务</strong>。然后你可以在你的浏览器中导航到你的GitHub库，点击<strong class="kp ir">设置</strong>标签，然后选择<strong class="kp ir">动作</strong>，然后在侧边栏中再次选择<strong class="kp ir">跑步者</strong>，在那里你会看到你新关联的跑步者带有一个绿点，状态为<strong class="kp ir">空闲</strong>，如下所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mr ms di mt bf mu"><div class="gh gi nb"><img src="../Images/5058f1df97a97fb1c2dd279a2b71feb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZGPovqsgPcqFUtevVgVcaQ.png"/></div></div></figure><p id="7817" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在，要在您的自托管运行器上运行操作，您需要像这样修改您的工作流文件<code class="fe mx my mz na b"><a class="ae lj" href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on" rel="noopener ugc nofollow" target="_blank">jobs.&lt;job_id&gt;.runs-on</a></code>属性:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="4fb2" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在自承载流道的数组中，可以提供在配置过程中提供的附加标签。提交更改后，您可以享受自托管带来的性能提升。</p><h1 id="7a16" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">配置工具缓存</h1><p id="1cff" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">许多设置动作下载工具并将其存储在<strong class="kp ir">/Users/runner/hostedtoolcache</strong>的工具缓存文件夹中。您可以使用<a class="ae lj" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank"> homebrew </a>管理所需的工具，并使用以下python脚本将安装的工具链接到您的工具缓存文件夹:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="0a31" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">使用GitHub actions，您可以通过在<code class="fe mx my mz na b">.env</code>文件中提供上述脚本路径到<code class="fe mx my mz na b">ACTIONS_RUNNER_HOOK_JOB_STARTED</code>环境变量，在每个作业之前运行这个脚本。通过这样做，您可以确保在执行任何作业之前，已安装的工具将始终在工具缓存中可用。</p><h1 id="371c" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">Sudoers构型</h1><p id="718b" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">如果您的操作需要root权限，您可以通过键入<code class="fe mx my mz na b">sudo visudo</code>来配置您的<code class="fe mx my mz na b">sudoers</code>文件。如果你的runner只用于私有库(由于runner的<a class="ae lj" href="http://If your tasks require root privileges, you can configure your sudoers file by typing sudo visudo. You can add the following line in this file to allow root privileges without prompting for a password, however, this is not advisable due to potential security risks:" rel="noopener ugc nofollow" target="_blank">安全性</a>，这是GitHub提供的默认推荐)，你可以在<code class="fe mx my mz na b">sudoers</code>文件中添加下面一行:</p><pre class="kg kh ki kj gt nc na nd ne aw nf bi"><span id="fef0" class="ng ll iq na b gy nh ni l nj nk">runner ALL=(ALL) NOPASSWD: ALL</span></pre><p id="91a3" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">或者，您可以添加限制应用程序级别，以便这些应用程序不需要密码提示。例如，<a class="ae lj" href="https://github.com/kuler90/setup-unity" rel="noopener ugc nofollow" target="_blank"> setup-unity </a>动作需要<code class="fe mx my mz na b">hdiutil</code>的root权限，在这种情况下，您可以将<code class="fe mx my mz na b">hdiutil</code>添加到无密码提示中，如下所示:</p><pre class="kg kh ki kj gt nc na nd ne aw nf bi"><span id="c731" class="ng ll iq na b gy nh ni l nj nk">runner<!-- -->  ALL= NOPASSWD: <strong class="na ir">/bin/</strong><strong class="na ir">hdiutil</strong><strong class="na ir"><br/></strong># Or your additional applications with arguments:<strong class="na ir"><br/></strong>runner<!-- -->  ALL= NOPASSWD: <strong class="na ir">/bin/</strong><strong class="na ir">hdiutil,</strong>/your_dir/your_bin your_args</span></pre><h1 id="dc6a" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">都准备好了吗？</h1><p id="e06f" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">不幸的是没有，虽然这是大多数操作所需的基本设置，但有些操作可能需要预装更多的附加工具。幸运的是，这些操作在它们的文档中指定了这些需求。</p><p id="65d6" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果我遗漏了什么，请随时指出，并继续关注本系列的第3部分，在那里，我将讨论优化管道以获得更高性能的不同步骤。</p></div></div>    
</body>
</html>